<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>03-Cas-åŸå­æ“ä½œ | AlfredNing</title><meta name=keywords content><meta name=description content="CASå®šä¹‰ Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢ V: ä½ç½®å†…å­˜å€¼ A: æ—§çš„é¢„æœŸå€¼ B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼
å½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼
ç¡¬ä»¶çº§åˆ«ä¿è¯ CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ cmpxchgæŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±Unsafeç±»æä¾›çš„CASæ–¹æ³•
æ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½
Unsafeç±» æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äºsun.miscåŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**
å˜é‡offSetä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€
å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚
AtomicIntegerç±» AtomicIntegerä¸»è¦æ˜¯é€šè¿‡CAS + volatile + nativeæ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚
CASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
CASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§
å®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚
æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚
åŸå­å¼•ç”¨ AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹
è‡ªå®šä¹‰åŸå­å¼•ç”¨ import java.util.concurrent.atomic.AtomicReference; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; /** * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:41:00 */ public class AtomicReferenceDemo { public static void main(String[] args) { User u1 = new User(&#34;u1&#34;, 20); User u2 = new User(&#34;u2&#34;, 30); AtomicReference<User> userAtomicReference = new AtomicReference<>(); userAtomicReference."><meta name=author content="AlfredNing"><link rel=canonical href=https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.27402031ac19c221a0356fba06f890a1a2bf8518669338f57cb7df4a3a1eabf9.css integrity="sha256-J0AgMawZwiGgNW+6BviQoaK/hRhmkzj1fLffSjoeq/k=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="03-Cas-åŸå­æ“ä½œ"><meta property="og:description" content="CASå®šä¹‰ Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢ V: ä½ç½®å†…å­˜å€¼ A: æ—§çš„é¢„æœŸå€¼ B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼
å½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼
ç¡¬ä»¶çº§åˆ«ä¿è¯ CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ cmpxchgæŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±Unsafeç±»æä¾›çš„CASæ–¹æ³•
æ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½
Unsafeç±» æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äºsun.miscåŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**
å˜é‡offSetä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€
å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚
AtomicIntegerç±» AtomicIntegerä¸»è¦æ˜¯é€šè¿‡CAS + volatile + nativeæ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚
CASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
CASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§
å®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚
æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚
åŸå­å¼•ç”¨ AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹
è‡ªå®šä¹‰åŸå­å¼•ç”¨ import java.util.concurrent.atomic.AtomicReference; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; /** * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:41:00 */ public class AtomicReferenceDemo { public static void main(String[] args) { User u1 = new User(&#34;u1&#34;, 20); User u2 = new User(&#34;u2&#34;, 30); AtomicReference<User> userAtomicReference = new AtomicReference<>(); userAtomicReference."><meta property="og:type" content="article"><meta property="og:url" content="https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"><meta property="article:section" content="note"><meta property="article:published_time" content="2023-07-12T16:20:37+08:00"><meta property="article:modified_time" content="2023-07-22T14:17:20+00:00"><meta property="og:site_name" content="Alfred.Ning"><meta name=twitter:card content="summary"><meta name=twitter:title content="03-Cas-åŸå­æ“ä½œ"><meta name=twitter:description content="CASå®šä¹‰ Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢ V: ä½ç½®å†…å­˜å€¼ A: æ—§çš„é¢„æœŸå€¼ B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼
å½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼
ç¡¬ä»¶çº§åˆ«ä¿è¯ CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ cmpxchgæŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±Unsafeç±»æä¾›çš„CASæ–¹æ³•
æ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½
Unsafeç±» æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äºsun.miscåŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**
å˜é‡offSetä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€
å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚
AtomicIntegerç±» AtomicIntegerä¸»è¦æ˜¯é€šè¿‡CAS + volatile + nativeæ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚
CASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
CASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§
å®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚
æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚
åŸå­å¼•ç”¨ AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹
è‡ªå®šä¹‰åŸå­å¼•ç”¨ import java.util.concurrent.atomic.AtomicReference; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; /** * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:41:00 */ public class AtomicReferenceDemo { public static void main(String[] args) { User u1 = new User(&#34;u1&#34;, 20); User u2 = new User(&#34;u2&#34;, 30); AtomicReference<User> userAtomicReference = new AtomicReference<>(); userAtomicReference."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ç¬”è®°","item":"https://AlfredNing.github.io/note/"},{"@type":"ListItem","position":3,"name":"ç¼–ç¨‹","item":"https://AlfredNing.github.io/note/program/"},{"@type":"ListItem","position":4,"name":"juc","item":"https://AlfredNing.github.io/note/program/juc/"},{"@type":"ListItem","position":5,"name":"03-Cas-åŸå­æ“ä½œ","item":"https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"03-Cas-åŸå­æ“ä½œ","name":"03-Cas-åŸå­æ“ä½œ","description":"CASå®šä¹‰ Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢ V: ä½ç½®å†…å­˜å€¼ A: æ—§çš„é¢„æœŸå€¼ B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼\nå½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼\nç¡¬ä»¶çº§åˆ«ä¿è¯ CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ cmpxchgæŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±Unsafeç±»æä¾›çš„CASæ–¹æ³•\næ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½\nUnsafeç±» æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äºsun.miscåŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**\nå˜é‡offSetä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€\nå˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚\nAtomicIntegerç±» AtomicIntegerä¸»è¦æ˜¯é€šè¿‡CAS + volatile + nativeæ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚\nCASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\nCASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§\nå®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚\næ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚\nåŸå­å¼•ç”¨ AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹\nè‡ªå®šä¹‰åŸå­å¼•ç”¨ import java.util.concurrent.atomic.AtomicReference; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; /** * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:41:00 */ public class AtomicReferenceDemo { public static void main(String[] args) { User u1 = new User(\u0026#34;u1\u0026#34;, 20); User u2 = new User(\u0026#34;u2\u0026#34;, 30); AtomicReference\u0026lt;User\u0026gt; userAtomicReference = new AtomicReference\u0026lt;\u0026gt;(); userAtomicReference.","keywords":[""],"articleBody":"CASå®šä¹‰ Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢ V: ä½ç½®å†…å­˜å€¼ A: æ—§çš„é¢„æœŸå€¼ B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼\nå½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼\nç¡¬ä»¶çº§åˆ«ä¿è¯ CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ cmpxchgæŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±Unsafeç±»æä¾›çš„CASæ–¹æ³•\næ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸ç³»ç»Ÿï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜æ˜¯æœ‰æ’ä»–é”çš„ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½\nUnsafeç±» æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äºsun.miscåŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**\nå˜é‡offSetä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€\nå˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚\nAtomicIntegerç±» AtomicIntegerä¸»è¦æ˜¯é€šè¿‡CAS + volatile + nativeæ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚\nCASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\nCASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§\nå®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚\næ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚\nåŸå­å¼•ç”¨ AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹\nè‡ªå®šä¹‰åŸå­å¼•ç”¨ import java.util.concurrent.atomic.AtomicReference; import lombok.AllArgsConstructor; import lombok.Data; import lombok.NoArgsConstructor; /** * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:41:00 */ public class AtomicReferenceDemo { public static void main(String[] args) { User u1 = new User(\"u1\", 20); User u2 = new User(\"u2\", 30); AtomicReference\u003cUser\u003e userAtomicReference = new AtomicReference\u003c\u003e(); userAtomicReference.set(u1); System.out.println( userAtomicReference.compareAndSet(u1, u2) + \"\\t\" + userAtomicReference.get().toString()); System.out.println( userAtomicReference.compareAndSet(u1, u2) + \"\\t\" + userAtomicReference.get().toString()); } } @Data @AllArgsConstructor @NoArgsConstructor class User { private String username; private int age; } è‡ªæ—‹é” çº¿ç¨‹æŒ‡å°è¯•è·å–é”çš„æ—¶å€™ä¸ä¼šç«‹å³é˜»å¡ï¼Œé‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»è·å–é”ã€‚ å½“çº¿ç¨‹è¢«å‘ç°å‡ºäºå ç”¨æ—¶å€™ï¼Œä¼šä¸æ–­å¾ªç¯åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œç›´åˆ°è·å–ã€‚\nè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPU\nè‡ªå®šä¹‰è‡ªæ—‹é” import java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicReference; /** * è‡ªæ—‹é”å®ç° * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 11:46:00 */ public class SpinLockDemo { AtomicReference\u003cThread\u003e atomicReference = new AtomicReference\u003c\u003e(); public void myLock() { System.out.println(Thread.currentThread().getName() + \"çº¿ç¨‹è¿›å…¥...\"); while (!atomicReference.compareAndSet(null, Thread.currentThread())) { } System.out.println(Thread.currentThread().getName() + \"æŒæœ‰é”..\"); } public void myUnlock() { atomicReference.compareAndSet(Thread.currentThread(), null); System.out.println(Thread.currentThread().getName() + \"é‡Šæ”¾é”..\"); } public static void main(String[] args) { SpinLockDemo spinLockDemo = new SpinLockDemo(); new Thread(() -\u003e { spinLockDemo.myLock(); try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } spinLockDemo.myUnlock(); }, \"t1\").start(); //æš‚åœä¸€ä¼šå„¿çº¿ç¨‹ï¼Œä¿è¯Açº¿ç¨‹å…ˆäºBçº¿ç¨‹å¯åŠ¨å¹¶å®Œæˆ try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } new Thread(() -\u003e { spinLockDemo.myLock(); spinLockDemo.myUnlock(); }, \"t2\").start(); } } ABAé—®é¢˜ è‡ªæ—‹é”æ—¶é—´å¼€é”€å¤§\näº§ç”ŸåŸå›  CASç®—æ³•å®ç°ä¸€ä¸ªé‡è¦å‰æéœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®å¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶é—´å·®ç±»ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–ã€‚\næ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vä¸­å–å‡ºAï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†Bï¼Œ\nç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸã€‚\nå°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nè§£å†³ABA ç‰ˆæœ¬å·æ—¶é—´æˆ³åŸå­å¼•ç”¨: AtomicStampedReferenceç±»\nimport java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicInteger; import java.util.concurrent.atomic.AtomicStampedReference; /** * ABAæ¼”ç¤ºåŠå…¶è§£å†³ * * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 12:10:00 */ public class ABADemo { static AtomicInteger atomicInteger = new AtomicInteger(100); static AtomicStampedReference\u003cInteger\u003e atomicStampedReference = new AtomicStampedReference\u003cInteger\u003e( 100, 1); public static void main(String[] args) { // ABAé—®é¢˜æ¼”ç¤º // abaProblem(); // ABAè§£å†³ ç‰ˆæœ¬å·æœºåˆ¶ new Thread(() -\u003e { int stamp = atomicStampedReference.getStamp(); System.out.println(Thread.currentThread().getName() + \"---é»˜è®¤ç‰ˆæœ¬å·: \" + stamp); try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } atomicStampedReference.compareAndSet(100, 101, stamp, stamp + 1); System.out.println(Thread.currentThread().getName() + \"---æäº¤ä¸€æ¬¡ç‰ˆæœ¬å·: \" + atomicStampedReference.getStamp()); atomicStampedReference.compareAndSet(101, 100, atomicStampedReference.getStamp(), atomicStampedReference.getStamp() + 1); System.out.println(Thread.currentThread().getName() + \"---æäº¤äºŒæ¬¡ç‰ˆæœ¬å·: \" + atomicStampedReference.getStamp()); }, \"t1\").start(); new Thread(() -\u003e { int stamp = atomicStampedReference.getStamp(); System.out.println(Thread.currentThread().getName() + \"---é»˜è®¤ç‰ˆæœ¬å·: \" + stamp); try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); } boolean res = atomicStampedReference.compareAndSet(100, 666, stamp, stamp + 1); System.out.println(Thread.currentThread().getName() + \"ä¿®æ”¹æˆåŠŸ: \" + res + \"\\t\" + atomicStampedReference.getStamp()); }, \"t2\").start(); } private static void abaProblem() { new Thread(() -\u003e { atomicInteger.compareAndSet(100, 101); atomicInteger.compareAndSet(101, 100); }, \"t1\").start(); try { TimeUnit.MICROSECONDS.sleep(10); } catch (InterruptedException e) { e.printStackTrace(); } new Thread(() -\u003e { boolean res = atomicInteger.compareAndSet(100, 666); System.out.println(\"ä¿®æ”¹æˆåŠŸ: \" + res); }, \"t2\").start(); } } åŸå­æ“ä½œç±» åŸºæœ¬ç±»å‹åŸå­ç±» AtomicInteger AtomicBoolean AtomicLong å¸¸ç”¨API\npublic final int get() //è·å–å½“å‰çš„å€¼ public final int getAndSet(int newValue)//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼ public final int getAndIncrement()//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢ public final int getAndDecrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡ public final int getAndAdd(int delta) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼ boolean compareAndSet(int expect, int update) //å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰ import java.util.concurrent.CountDownLatch; import java.util.concurrent.atomic.AtomicInteger; import lombok.Data; /** * AtomicInteger + CountDownLatch * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 15:30:00 */ @Data class NumberAdd { private AtomicInteger atomicInteger = new AtomicInteger(); public void addPlus() { atomicInteger.incrementAndGet(); } } public class AtomicIntegerDemo { public static void main(String[] args) throws InterruptedException { int size = 50; NumberAdd numberAdd = new NumberAdd(); CountDownLatch cdl = new CountDownLatch(size); for (int i = 0; i \u003c size; i++) { new Thread(() -\u003e { try { for (int j = 0; j \u003c 1000; j++) { numberAdd.addPlus(); } } catch (Exception e) { e.printStackTrace(); } finally { cdl.countDown(); } }).start(); } // ç”Ÿäº§ä¸ç”¨ä½¿ç”¨ -ã€‹ CountDownLatch // try { // TimeUnit.SECONDS.sleep(2); // } catch (InterruptedException e) { // e.printStackTrace(); // } cdl.await(); System.out.println(numberAdd.getAtomicInteger().get()); } } æ•°ç»„ç±»å‹åŸå­ç±» AtomicIntegerArray AtomicLongArray AtomicReferenceArray å¼•ç”¨ç±»å‹åŸå­ç±» AtomicReference AtomicStampedReference AtomicMarkableReference AtomicStampedReference ä¸ AtomicMarkableReference åŒºåˆ« AtomicStampedReference æºå¸¦ç‰ˆæœ¬å·çš„å¼•ç”¨åŸå­ç±»å‹ï¼Œå¯ä»¥è§£å†³ABAé—®é¢˜ï¼Œé‡ç‚¹åœ¨äºä¿®æ”¹å‡ æ¬¡\nAtomicMarkableReference å¸¦æœ‰æ ‡è®°ä¸ºçš„å¼•ç”¨åŸå­ç±»å‹ï¼Œå°†çŠ¶æ€æˆ³è½¬ä¸ºboolå€¼ï¼Œé‡åœ¨åœ¨äºæ˜¯å¦ä¿®æ”¹è¿‡\nimport java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicMarkableReference; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 16:33:00 */ public class AtomicMarkableReferenceDemo { static AtomicMarkableReference\u003cInteger\u003e markableReference = new AtomicMarkableReference\u003cInteger\u003e(100, false); public static void main(String[] args) { new Thread(() -\u003e { boolean marked = markableReference.isMarked(); System.out.println(Thread.currentThread().getName() + \"---é»˜è®¤ä¿®æ”¹è¡¨ç¤ºç¬¦å·: \" + marked); try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } markableReference.compareAndSet(100, 101, marked, !marked); }, \"t1\").start(); new Thread(() -\u003e { boolean marked = markableReference.isMarked(); System.out.println(Thread.currentThread().getName() + \"---é»˜è®¤ä¿®æ”¹è¡¨ç¤ºç¬¦å·: \" + marked); try { TimeUnit.SECONDS.sleep(2); } catch (InterruptedException e) { e.printStackTrace(); } boolean b = markableReference.compareAndSet(100, 666, marked, !marked); System.out.println(Thread.currentThread().getName() + \"---ä¿®æ”¹æˆåŠŸ: \" + b); System.out.println(Thread.currentThread().getName() + \"\\t\" + markableReference.getReference()); System.out.println(Thread.currentThread().getName() + \"\\t\" + markableReference.isMarked()); }, \"t2\").start(); } } å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±» AtomicIntegerFieldUpdater ï¼š åŸå­æ›´æ–°å¯¹è±¡ä¸­intç±»å‹å­—æ®µçš„å€¼ AtomicLongFieldUpdaterï¼š åŸå­æ›´æ–°å¯¹è±¡ä¸­Longç±»å‹å­—æ®µçš„å€¼ AtomicReferenceFieldUpdater ï¼š åŸå­æ›´æ–°å¼•ç”¨ç±»å‹å­—æ®µçš„å€¼ äº§ç”Ÿ ä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼å»æ“ä½œéçº¿ç¨‹å®‰å…¨å¯¹è±¡çš„æŸäº›å­—æ®µ/å±æ€§ï¼Œé”æ›´åŠ è½»é‡çº§\nä½¿ç”¨è¦æ±‚ æ›´æ–°çš„å¯¹è±¡å±æ€§å¿…é¡»ä½¿ç”¨ public volatile ä¿®é¥°ç¬¦ã€‚ å› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³•newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚ import java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicIntegerFieldUpdater; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 16:59:00 */ public class AtomicIntegerFieldUpdaterDemo { public static void main(String[] args) { BankAccount bankAccount = new BankAccount(); for (int i = 0; i \u003c 1000; i++) { new Thread(() -\u003e { bankAccount.transfer(bankAccount); }, String.valueOf(i)).start(); } try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\"account: \" + bankAccount.money); } } class BankAccount { String bankName = \"ccb\"; public volatile int money = 0; // æ“ä½œç»å¸¸å‘ç”Ÿå˜åŒ– æ˜“äºæ›´æ–°çš„ AtomicIntegerFieldUpdater\u003cBankAccount\u003e fieldUpdater = AtomicIntegerFieldUpdater.newUpdater(BankAccount.class, \"money\"); public void transfer(BankAccount bankAccount) { fieldUpdater.incrementAndGet(bankAccount); } } import java.util.concurrent.TimeUnit; import java.util.concurrent.atomic.AtomicReferenceFieldUpdater; /** * åˆå§‹åŒ–ä¸€æ¬¡ * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 17:04:00 */ class Myvar { public volatile Boolean isInit = Boolean.FALSE; AtomicReferenceFieldUpdater\u003cMyvar, Boolean\u003e fieldUpdater = AtomicReferenceFieldUpdater.newUpdater(Myvar.class, Boolean.class, \"isInit\"); public void init(Myvar myvar) { if (fieldUpdater.compareAndSet(myvar, Boolean.FALSE, Boolean.TRUE)) { System.out.println(Thread.currentThread().getName() + \"\\t\" + \"------start init\"); try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(Thread.currentThread().getName() + \"\\t\" + \"------end init\"); } else { System.out.println(Thread.currentThread().getName() + \"\\t\" + \"------æŠ¢é”å¤±è´¥ \"); } } } public class AtomicReferenceFieldUpdaterDemo { public static void main(String[] args) { Myvar myvar = new Myvar(); for (int i = 0; i \u003c 5; i++) { new Thread(() -\u003e { myvar.init(myvar); }, String.valueOf(i)).start(); } } } åŸå­æ“ä½œå¢å¼ºç±» DoubleAccumulator DoubleAdder LongAccumulator LongAdder LongAdderåªèƒ½ç”¨æ¥è®¡ç®—åŠ æ³•ï¼Œä¸”ä»é›¶å¼€å§‹è®¡ç®— LongAccumulatoræä¾›äº†è‡ªå®šä¹‰çš„å‡½æ•°æ“ä½œ å¯¹äºå¤§æ•°æ®ç»Ÿè®¡ï¼Œä½¿ç”¨LongAdder\nimport java.util.concurrent.CountDownLatch; import java.util.concurrent.atomic.AtomicLong; import java.util.concurrent.atomic.LongAccumulator; import java.util.concurrent.atomic.LongAdder; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ18æ—¥ 17:34:00 */ class ClickNumberNet { int number = 0; public synchronized void clickBySync() { number++; } AtomicLong atomicLong = new AtomicLong(0); public void clickByAtomicLong() { atomicLong.incrementAndGet(); } LongAdder longAdder = new LongAdder(); public void clickByLongAdder() { longAdder.increment(); } LongAccumulator longAccumulator = new LongAccumulator((x, y) -\u003e x + y, 0); public void clickByLongAccumulator() { longAccumulator.accumulate(1); } } public class LongAdderDemo2 { public static void main(String[] args) throws InterruptedException { ClickNumberNet clickNumberNet = new ClickNumberNet(); long startTime; long endTime; CountDownLatch countDownLatch = new CountDownLatch(50); CountDownLatch countDownLatch2 = new CountDownLatch(50); CountDownLatch countDownLatch3 = new CountDownLatch(50); CountDownLatch countDownLatch4 = new CountDownLatch(50); startTime = System.currentTimeMillis(); for (int i = 1; i \u003c= 50; i++) { new Thread(() -\u003e { try { for (int j = 1; j \u003c= 100 * 10000; j++) { clickNumberNet.clickBySync(); } } finally { countDownLatch.countDown(); } }, String.valueOf(i)).start(); } countDownLatch.await(); endTime = System.currentTimeMillis(); System.out.println( \"----costTime: \" + (endTime - startTime) + \" æ¯«ç§’\" + \"\\t clickBySync result: \" + clickNumberNet.number); startTime = System.currentTimeMillis(); for (int i = 1; i \u003c= 50; i++) { new Thread(() -\u003e { try { for (int j = 1; j \u003c= 100 * 10000; j++) { clickNumberNet.clickByAtomicLong(); } } finally { countDownLatch2.countDown(); } }, String.valueOf(i)).start(); } countDownLatch2.await(); endTime = System.currentTimeMillis(); System.out.println( \"----costTime: \" + (endTime - startTime) + \" æ¯«ç§’\" + \"\\t clickByAtomicLong result: \" + clickNumberNet.atomicLong); startTime = System.currentTimeMillis(); for (int i = 1; i \u003c= 50; i++) { new Thread(() -\u003e { try { for (int j = 1; j \u003c= 100 * 10000; j++) { clickNumberNet.clickByLongAdder(); } } finally { countDownLatch3.countDown(); } }, String.valueOf(i)).start(); } countDownLatch3.await(); endTime = System.currentTimeMillis(); System.out.println(\"----costTime: \" + (endTime - startTime) + \" æ¯«ç§’\" + \"\\t clickByLongAdder result: \" + clickNumberNet.longAdder.sum()); startTime = System.currentTimeMillis(); for (int i = 1; i \u003c= 50; i++) { new Thread(() -\u003e { try { for (int j = 1; j \u003c= 100 * 10000; j++) { clickNumberNet.clickByLongAccumulator(); } } finally { countDownLatch4.countDown(); } }, String.valueOf(i)).start(); } countDownLatch4.await(); endTime = System.currentTimeMillis(); System.out.println(\"----costTime: \" + (endTime - startTime) + \" æ¯«ç§’\" + \"\\t clickByLongAccumulator result: \" + clickNumberNet.longAccumulator.longValue()); } } LongAdderå¿«çš„åŸå›  abstract class Striped64 extends Number\nLongAdderçš„åŸºæœ¬æ€è·¯å°±æ˜¯åˆ†æ•£çƒ­ç‚¹ï¼Œå°†valueå€¼åˆ†æ•£åˆ°ä¸€ä¸ªCellæ•°ç»„ä¸­ï¼Œä¸åŒçº¿ç¨‹ä¼šå‘½ä¸­åˆ°æ•°ç»„çš„ä¸åŒæ§½ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åªå¯¹è‡ªå·±æ§½ä¸­çš„é‚£ä¸ªå€¼è¿›è¡ŒCASæ“ä½œï¼Œè¿™æ ·çƒ­ç‚¹å°±è¢«åˆ†æ•£äº†ï¼Œå†²çªçš„æ¦‚ç‡å°±å°å¾ˆå¤šã€‚å¦‚æœè¦è·å–çœŸæ­£çš„longå€¼ï¼Œåªè¦å°†å„ä¸ªæ§½ä¸­çš„å˜é‡å€¼ç´¯åŠ è¿”å›ã€‚\nsum()ä¼šå°†æ‰€æœ‰Cellæ•°ç»„ä¸­çš„valueå’Œbaseç´¯åŠ ä½œä¸ºè¿”å›å€¼ï¼Œæ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯å°†ä¹‹å‰AtomicLongä¸€ä¸ªvalueçš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªvalueä¸­å»ï¼Œ\nä»è€Œé™çº§æ›´æ–°çƒ­ç‚¹ã€‚\nå†…éƒ¨æœ‰ä¸€ä¸ªbaseå˜é‡ï¼Œä¸€ä¸ªCell[]æ•°ç»„ã€‚\nbaseå˜é‡ï¼šéç«æ€æ¡ä»¶ä¸‹ï¼Œç›´æ¥ç´¯åŠ åˆ°è¯¥å˜é‡ä¸Š Cell[]æ•°ç»„ï¼šç«æ€æ¡ä»¶ä¸‹ï¼Œç´¯åŠ ä¸ªå„ä¸ªçº¿ç¨‹è‡ªå·±çš„æ§½Cell[i]ä¸­ LongAdderåœ¨æ— ç«äº‰çš„æƒ…å†µï¼Œè·ŸAtomicLongä¸€æ ·ï¼Œå¯¹åŒä¸€ä¸ªbaseè¿›è¡Œæ“ä½œï¼Œå½“å‡ºç°ç«äº‰å…³ç³»æ—¶åˆ™æ˜¯é‡‡ç”¨åŒ–æ•´ä¸ºé›¶çš„åšæ³•ï¼Œä»ç©ºé—´æ¢æ—¶é—´ï¼Œç”¨ä¸€ä¸ªæ•°ç»„cellsï¼Œå°†ä¸€ä¸ªvalueæ‹†åˆ†è¿›è¿™ä¸ªæ•°ç»„cellsã€‚å¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶å¯¹valueè¿›è¡Œæ“ä½œæ—¶å€™ï¼Œå¯ä»¥å¯¹çº¿ç¨‹idè¿›è¡Œhashå¾—åˆ°hashå€¼ï¼Œå†æ ¹æ®hashå€¼æ˜ å°„åˆ°è¿™ä¸ªæ•°ç»„cellsçš„æŸä¸ªä¸‹æ ‡ï¼Œå†å¯¹è¯¥ä¸‹æ ‡æ‰€å¯¹åº”çš„å€¼è¿›è¡Œè‡ªå¢æ“ä½œã€‚å½“æ‰€æœ‰çº¿ç¨‹æ“ä½œå®Œæ¯•ï¼Œå°†æ•°ç»„cellsçš„æ‰€æœ‰å€¼å’Œæ— ç«äº‰å€¼baseéƒ½åŠ èµ·æ¥ä½œä¸ºæœ€ç»ˆç»“æœã€‚\nAtomicLong ä¸ LongAdder AtomicLong åŸç† CAS+è‡ªæ—‹\nåœºæ™¯ ä½å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®— AtomicLongèƒ½ä¿è¯å¹¶å‘æƒ…å†µä¸‹è®¡æ•°çš„å‡†ç¡®æ€§ï¼Œå…¶å†…éƒ¨é€šè¿‡CASæ¥è§£å†³å¹¶å‘å®‰å…¨æ€§çš„é—®é¢˜ã€‚ ç¼ºé™· é«˜å¹¶å‘åæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œè‡ªæ—‹å¸¦æ¥çš„\nLongAdder åŸç† CAS+Base+Cellæ•°ç»„åˆ†æ•£ ç©ºé—´æ¢æ—¶é—´å¹¶åˆ†æ•£äº†çƒ­ç‚¹æ•°æ® åœºæ™¯ é«˜å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®—ï¼Œé€‚åˆç²—ç•¥è®¡ç®—\nç¼ºé™· sumæ±‚å’Œä¹‹åå¦‚æœè¿˜æœ‰çº¿ç¨‹ä¿®æ”¹ç»“æœï¼Œæœ€åç»“æœä¸å¤ªå‡†ç¡®\nLongAdderæºç åˆ†æ LongAdder#increment -\u003e #add /* csæ˜¯Striped64 çš„cellsæ•°ç»„å±æ€§ bæ˜¯Striped64 çš„baseå±æ€§ væ˜¯å½“å‰çº¿ç¨‹hashåˆ°cellå­˜å‚¨çš„å€¼ mæ˜¯cellé•¿åº¦å‡1ï¼Œhashä½œä¸ºæ©ç ä½¿ç”¨ aæ˜¯å½“å‰çº¿ç¨‹hashåˆ°çš„cell */ public void add(long x) { Cell[] cs; long b, v; int m; Cell c; // é¦–æ¬¡çº¿ç¨‹è¿›æ¥ï¼Œ(cs = cells) != null ä¸€å®šä¸ºfalse, èµ°#casBaseæ–¹æ³•ï¼Œä»¥caså‡¡æ˜¯æ›´æ–°bashå€¼ï¼Œåªæœ‰æ›´æ–°å¤±è´¥ï¼Œèµ°åˆ°ifä¸­ // (cs = cells) != null ä¸ºtrue: è¯´æ˜å‡ºç°è¿‡çº¿ç¨‹ç«äº‰ï¼ŒCellæ•°ç»„å·²ç»è¢«åˆ›å»º // æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŠ¢å…ˆå¼‚æ­¥ä¿®æ”¹äº†base æ­£åœ¨å‡ºç°ç«äº‰ if ((cs = cells) != null || !casBase(b = base, b + x)) { // è¯¥æ–¹æ³•è¿”å›çº¿ç¨‹çš„ThreadLocalRandomå­—æ®µ // é€šè¿‡éšæœºæ•°ç”Ÿæˆçš„ä¸€ä¸ªå€¼ï¼Œå¯¹äºä¸€ä¸ªç¡®å®šçš„çº¿ç¨‹è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„ int index = getProbe(); // trueä¸ºæ— ç«äº‰ falseè¡¨ç¤ºç«äº‰æ¿€çƒˆï¼Œå¤šä¸ªhashåˆ°åŒä¸€ä¸ªcell, å¯èƒ½è¦æ‰©å®¹ boolean uncontended = true; // cellä¸ºç©ºï¼Œè¯´æ˜æ­£åœ¨å‡ºç°ç«äº‰ï¼Œä¾æ®ä¸Šé¢æ¡ä»¶2 // (m = cs.length - 1) \u003c 0 åº”è¯¥ä¸ä¼šå‡ºç° // (c = cs[index \u0026 m]) == null å½“å‰çº¿ç¨‹æ‰€åœ¨çš„cellä¸ºç©ºï¼Œè¯´æ˜çº¿ç¨‹è¿˜æ²¡æœ‰åˆå§‹åŒ–è¿‡cellï¼Œåº”åˆå§‹ä¸€ä¸ªcell // æ›´æ–°å½“å‰æ‰€åœ¨çº¿ç¨‹Cellå¤±è´¥ï¼Œè¯´æ˜ç«äº‰æ¿€çƒˆï¼Œå¤šä¸ªçº¿ç¨‹Hashåˆ°åŒä¸€ä¸ªcell,åº”æ‰©å®¹ if (cs == null || (m = cs.length - 1) \u003c 0 || (c = cs[index \u0026 m]) == null || !(uncontended = c.cas(v = c.value, v + x))) longAccumulate(x, null, uncontended, index); } } # longAccumulate final void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended, int index) { if (index == 0) { ThreadLocalRandom.current(); // force initialization index = getProbe(); wasUncontended = true; } for (boolean collide = false;;) { // True if last slot nonempty Cell[] cs; Cell c; int n; long v; // cellå·²ç»è¢«åˆå§‹åŒ– if ((cs = cells) != null \u0026\u0026 (n = cs.length) \u003e 0) { // çº¿ç¨‹hashå€¼è¿ç®—ä¹‹åå¾—åˆ°çš„cellå•å…ƒä¸ºä¸ºnullï¼Œè¯´æ˜cellæ²¡æœ‰è¢«ä½¿ç”¨ if ((c = cs[(n - 1) \u0026 index]) == null) { // cellæ•°ç»„æ­£åœ¨æ‰©å®¹ if (cellsBusy == 0) { Cell r = new Cell(x); //åˆ›å»ºå•å…ƒæ ¼ if (cellsBusy == 0 \u0026\u0026 casCellsBusy()) { //å°è¯•åŠ é”ï¼ŒæˆåŠŸåcellsBusy = 1 try { Cell[] rs; int m, j; // double check if ((rs = cells) != null \u0026\u0026 (m = rs.length) \u003e 0 \u0026\u0026 rs[j = (m - 1) \u0026 index] == null) { rs[j] = r; // æ·»åŠ åˆ°cellä¸­ break; } } finally { cellsBusy = 0; } continue; // Slot is now non-empty } } collide = false; } else if (!wasUncontended) // CAS already known to fail wasUncontendedè¡¨ç¤ºå‰ä¸€æ¬¡æ›´æ–°cellå•å…ƒæ ¼æ˜¯å¦æˆåŠŸ wasUncontended = true; // Continue after rehash é‡ç½®ä¸ºtrueï¼Œåé¢é‡æ–°è®¡ç®—çº¿ç¨‹çš„hashå€¼ else if (c.cas(v = c.value, (fn == null) ? v + x : fn.applyAsLong(v, x))) break; else if (n \u003e= NCPU || cells != cs) // cellsæ•°ç»„å¤§å°è¶…è¿‡CPUæ ¸æ•°ï¼Œæ°¸è¿œä¸ä¼šæ‰©å®¹ collide = false; // At max size or stale else if (!collide) collide = true; else if (cellsBusy == 0 \u0026\u0026 casCellsBusy()) { // å°è¯•åŠ é”æ‰©å®¹ try { if (cells == cs) // æ‰©å®¹åçš„å¤§å° = å½“å‰å®¹é‡ * 2 cells = Arrays.copyOf(cs, n \u003c\u003c 1); } finally { cellsBusy = 0; } collide = false; continue; // Retry with expanded table } index = advanceProbe(index); } // cellåœ¨æ²¡æœ‰åŠ é”ä¸”æ²¡æœ‰åˆå§‹åŒ–ï¼Œå°è¯•åŠ é”ï¼Œä¸”åˆå§‹åŒ– else if (cellsBusy == 0 \u0026\u0026 cells == cs \u0026\u0026 casCellsBusy()) { try { // Initialize table if (cells == cs) { Cell[] rs = new Cell[2]; rs[index \u0026 1] = new Cell(x); cells = rs; break; } } finally { cellsBusy = 0; } } // cellæ­£åœ¨åˆå§‹åŒ–ï¼Œç›´æ¥åœ¨åŸºæ•°baseä¸Šé¢è¿›è¡Œç´¯åŠ æ“ä½œ else if (casBase(v = base, (fn == null) ? v + x : fn.applyAsLong(v, x))) break; } } ? å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡® sum()ä¼šå°†æ‰€æœ‰Cellæ•°ç»„ä¸­çš„valueå’Œbaseç´¯åŠ ä½œä¸ºè¿”å›å€¼ã€‚æœ€ç»ˆä¸€è‡´æ€§\næ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯å°†ä¹‹å‰AtomicLongä¸€ä¸ªvalueçš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªvalueä¸­å»ï¼Œä»è€Œé™çº§æ›´æ–°çƒ­ç‚¹ã€‚\n","wordCount":"1799","inLanguage":"zh","datePublished":"2023-07-12T16:20:37+08:00","dateModified":"2023-07-22T14:17:20.599025439Z","author":[{"@type":"Person","name":"AlfredNing"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},"publisher":{"@type":"Organization","name":"AlfredNing","logo":{"@type":"ImageObject","url":"https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://AlfredNing.github.io accesskey=h title="AlfredNing (Alt + H)">AlfredNing</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://AlfredNing.github.io/note/ title=ğŸ““ç¬”è®°><span>ğŸ““ç¬”è®°</span></a></li><li><a href=https://AlfredNing.github.io/thinking/ title=ğŸ¤”é»‘æ´><span>ğŸ¤”é»‘æ´</span></a></li><li><a href=https://AlfredNing.github.io/search/ title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://AlfredNing.github.io/tags/ title=ğŸ·ï¸æ ‡ç­¾><span>ğŸ·ï¸æ ‡ç­¾</span></a></li><li><a href=https://AlfredNing.github.io/archives title=ğŸ—„ï¸å½’æ¡£><span>ğŸ—„ï¸å½’æ¡£</span></a></li><li><a href=https://AlfredNing.github.io/about title=ğŸ¤™å…³äº><span>ğŸ¤™å…³äº</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://AlfredNing.github.io>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/>ç¬”è®°</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/program/>ç¼–ç¨‹</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/program/juc/>juc</a></div><h1 class=post-title>03-Cas-åŸå­æ“ä½œ</h1><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-07-12 16:20:37 +0800 +0800'>2023å¹´-07æœˆ-12æ—¥</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2023å¹´-07æœˆ-22æ—¥&nbsp;|&nbsp;å­—æ•°:&nbsp;1799å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;9åˆ†é’Ÿ&nbsp;|&nbsp;AlfredNing
&nbsp;|&nbsp;æ ‡ç­¾: &nbsp;<ul class=post-tags-meta><a href=https://AlfredNing.github.io/tags/juc/>juc</a></ul></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#cas%e5%ae%9a%e4%b9%89 aria-label=CASå®šä¹‰>CASå®šä¹‰</a><ul><li><a href=#%e7%a1%ac%e4%bb%b6%e7%ba%a7%e5%88%ab%e4%bf%9d%e8%af%81 aria-label=ç¡¬ä»¶çº§åˆ«ä¿è¯>ç¡¬ä»¶çº§åˆ«ä¿è¯</a></li></ul></li><li><a href=#unsafe%e7%b1%bb aria-label=Unsafeç±»>Unsafeç±»</a><ul><li><a href=#atomicinteger%e7%b1%bb aria-label=AtomicIntegerç±»>AtomicIntegerç±»</a></li></ul></li><li><a href=#%e5%8e%9f%e5%ad%90%e5%bc%95%e7%94%a8 aria-label=åŸå­å¼•ç”¨>åŸå­å¼•ç”¨</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%8e%9f%e5%ad%90%e5%bc%95%e7%94%a8 aria-label=è‡ªå®šä¹‰åŸå­å¼•ç”¨>è‡ªå®šä¹‰åŸå­å¼•ç”¨</a></li><li><a href=#%e8%87%aa%e6%97%8b%e9%94%81 aria-label=è‡ªæ—‹é”>è‡ªæ—‹é”</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e8%87%aa%e6%97%8b%e9%94%81 aria-label=è‡ªå®šä¹‰è‡ªæ—‹é”>è‡ªå®šä¹‰è‡ªæ—‹é”</a></li></ul></li></ul></li><li><a href=#aba%e9%97%ae%e9%a2%98 aria-label=ABAé—®é¢˜>ABAé—®é¢˜</a><ul><li><a href=#%e4%ba%a7%e7%94%9f%e5%8e%9f%e5%9b%a0 aria-label=äº§ç”ŸåŸå› >äº§ç”ŸåŸå› </a></li><li><a href=#%e8%a7%a3%e5%86%b3aba aria-label=è§£å†³ABA>è§£å†³ABA</a></li></ul></li><li><a href=#%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%e7%b1%bb aria-label=åŸå­æ“ä½œç±»>åŸå­æ“ä½œç±»</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e7%b1%bb%e5%9e%8b%e5%8e%9f%e5%ad%90%e7%b1%bb aria-label=åŸºæœ¬ç±»å‹åŸå­ç±»>åŸºæœ¬ç±»å‹åŸå­ç±»</a></li><li><a href=#%e6%95%b0%e7%bb%84%e7%b1%bb%e5%9e%8b%e5%8e%9f%e5%ad%90%e7%b1%bb aria-label=æ•°ç»„ç±»å‹åŸå­ç±»>æ•°ç»„ç±»å‹åŸå­ç±»</a></li><li><a href=#%e5%bc%95%e7%94%a8%e7%b1%bb%e5%9e%8b%e5%8e%9f%e5%ad%90%e7%b1%bb aria-label=å¼•ç”¨ç±»å‹åŸå­ç±»>å¼•ç”¨ç±»å‹åŸå­ç±»</a><ul><li><a href=#atomicstampedreference-%e4%b8%8e-atomicmarkablereference-%e5%8c%ba%e5%88%ab aria-label="AtomicStampedReference ä¸ AtomicMarkableReference åŒºåˆ«">AtomicStampedReference ä¸ AtomicMarkableReference åŒºåˆ«</a></li></ul></li><li><a href=#%e5%af%b9%e8%b1%a1%e7%9a%84%e5%b1%9e%e6%80%a7%e4%bf%ae%e6%94%b9%e5%8e%9f%e5%ad%90%e7%b1%bb aria-label=å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»>å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»</a><ul><li><a href=#%e4%ba%a7%e7%94%9f aria-label=äº§ç”Ÿ>äº§ç”Ÿ</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e8%a6%81%e6%b1%82 aria-label=ä½¿ç”¨è¦æ±‚>ä½¿ç”¨è¦æ±‚</a></li></ul></li><li><a href=#%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%e5%a2%9e%e5%bc%ba%e7%b1%bb aria-label=åŸå­æ“ä½œå¢å¼ºç±»>åŸå­æ“ä½œå¢å¼ºç±»</a></li><li><a href=#longadder%e5%bf%ab%e7%9a%84%e5%8e%9f%e5%9b%a0 aria-label=LongAdderå¿«çš„åŸå› >LongAdderå¿«çš„åŸå› </a></li><li><a href=#atomiclong-%e4%b8%8e-longadder aria-label="AtomicLong ä¸ LongAdder">AtomicLong ä¸ LongAdder</a><ul><li><a href=#atomiclong aria-label=AtomicLong>AtomicLong</a><ul><li><a href=#%e5%8e%9f%e7%90%86 aria-label=åŸç†>åŸç†</a></li><li><a href=#%e5%9c%ba%e6%99%af aria-label=åœºæ™¯>åœºæ™¯</a></li><li><a href=#%e7%bc%ba%e9%99%b7 aria-label=ç¼ºé™·>ç¼ºé™·</a></li></ul></li><li><a href=#longadder aria-label=LongAdder>LongAdder</a><ul><li><a href=#%e5%8e%9f%e7%90%86-1 aria-label=åŸç†>åŸç†</a></li><li><a href=#%e5%9c%ba%e6%99%af-1 aria-label=åœºæ™¯>åœºæ™¯</a></li><li><a href=#%e7%bc%ba%e9%99%b7-1 aria-label=ç¼ºé™·>ç¼ºé™·</a></li></ul></li></ul></li></ul></li><li><a href=#longadder%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=LongAdderæºç åˆ†æ>LongAdderæºç åˆ†æ</a><ul><li><a href=#-%e5%b9%b6%e5%8f%91%e4%b8%8b%e4%b8%ba%e4%bb%80%e4%b9%88sum%e5%80%bc%e4%b8%8d%e7%b2%be%e7%a1%ae aria-label="? å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡®">? å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡®</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=caså®šä¹‰>CASå®šä¹‰<a hidden class=anchor aria-hidden=true href=#caså®šä¹‰>#</a></h1><p>Compare And Swapï¼šæ¯”è¾ƒå¹¶äº¤æ¢
V: ä½ç½®å†…å­˜å€¼
A: æ—§çš„é¢„æœŸå€¼
B: è¦ä¿®æ”¹æ›´æ–°çš„å€¼</p><p>å½“ä¸”ä»…å½“Vä¸­çš„å€¼å’ŒAå€¼ç›¸ç­‰ï¼Œç”¨Bå€¼æ›´æ–°Vä¸­çš„å€¼</p><h2 id=ç¡¬ä»¶çº§åˆ«ä¿è¯>ç¡¬ä»¶çº§åˆ«ä¿è¯<a hidden class=anchor aria-hidden=true href=#ç¡¬ä»¶çº§åˆ«ä¿è¯>#</a></h2><p>CASåº•å±‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ <code>cmpxchg</code>æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒJavaåº•å±‚æä¾›ç”±<code>Unsafe</code>ç±»æä¾›çš„CASæ–¹æ³•</p><p>æ‰§è¡ŒcmpxchgæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸º<strong>å¤šæ ¸ç³»ç»Ÿ</strong>ï¼Œå¦‚æœæ˜¯å°±ç»™æ€»çº¿åŠ é”ï¼Œ<strong>åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹æ€»çº¿åŠ é”æˆåŠŸï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šæ‰§è¡Œcasæ“ä½œ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>CASçš„åŸå­æ€§å®é™…ä¸Šæ˜¯CPUå®ç°çš„</strong>ï¼Œ å…¶å®åœ¨è¿™ä¸€ç‚¹ä¸Šè¿˜<strong>æ˜¯æœ‰æ’ä»–é”çš„</strong>ï¼Œåªæ˜¯æ¯”èµ·ç”¨synchronizedï¼Œ è¿™é‡Œçš„æ’ä»–æ—¶é—´è¦çŸ­çš„å¤šï¼Œ æ‰€ä»¥åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ€§èƒ½ä¼šæ¯”è¾ƒå¥½</p><h1 id=unsafeç±»>Unsafeç±»<a hidden class=anchor aria-hidden=true href=#unsafeç±»>#</a></h1><p>æ˜¯CASçš„æ ¸å¿ƒç±»ï¼ŒUnsafeä½äº<code>sun.misc</code>åŒ…ä¸­ï¼Œé€šè¿‡CASç±»å¯ä»¥ç›´æ¥é€šè¿‡æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®**ï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç”¨nativeä¿®é¥°ï¼Œ ä¹Ÿå°±æ˜¯è¯´Unsafeç±»åº•å±‚éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡**</p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/image-20230718112357762.png alt=image-20230718112357762></p><p>å˜é‡<code>offSet</code>ä»£è¡¨å˜é‡å€¼åœ¨å†…å­˜çš„åœ°å€</p><p>å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</p><h2 id=atomicintegerç±»>AtomicIntegerç±»<a hidden class=anchor aria-hidden=true href=#atomicintegerç±»>#</a></h2><p><code>AtomicInteger</code>ä¸»è¦æ˜¯é€šè¿‡<strong>CAS + volatile + native</strong>æ–¹æ³•ç±»ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚</p><p>CASå¹¶å‘åŸè¯­ä½“ç°åœ¨JAVAè¯­è¨€ä¸­å°±æ˜¯sun.misc.Unsafeç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘ä»¬å®ç°å‡º<strong>CASæ±‡ç¼–æŒ‡ä»¤</strong>ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äº<strong>ç¡¬ä»¶</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚å†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œ<strong>å¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</strong></p><blockquote><p>CASæ˜¯é ç¡¬ä»¶å®ç°çš„ä»è€Œåœ¨ç¡¬ä»¶å±‚é¢æå‡æ•ˆç‡ï¼Œæœ€åº•å±‚è¿˜æ˜¯äº¤ç»™ç¡¬ä»¶æ¥ä¿è¯åŸå­æ€§å’Œå¯è§æ€§</p><p>å®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨intelçš„CPUä¸­(X86æœºå™¨ä¸Š)ï¼Œä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤cmpxchgæŒ‡ä»¤ã€‚</p><p>æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ¯”è¾ƒè¦æ›´æ–°å˜é‡çš„å€¼Vå’Œé¢„æœŸå€¼Eï¼ˆcompareï¼‰ï¼Œç›¸ç­‰æ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºæ–°å€¼Nï¼ˆswapï¼‰å¦‚æœä¸ç›¸ç­‰è‡ªæ—‹å†æ¥ã€‚</p></blockquote><h1 id=åŸå­å¼•ç”¨>åŸå­å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#åŸå­å¼•ç”¨>#</a></h1><p>AtomicIntegeråŸå­æ•´å‹ï¼Œå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„åŸç†å¼•ç”¨ç±»å‹</p><h2 id=è‡ªå®šä¹‰åŸå­å¼•ç”¨>è‡ªå®šä¹‰åŸå­å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰åŸå­å¼•ç”¨>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicReference</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.AllArgsConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.Data</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.NoArgsConstructor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è‡ªå®šä¹‰åŸå­ç±»å‹å¼•ç”¨
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 11:41:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicReferenceDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>User</span> <span class=n>u1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=s>&#34;u1&#34;</span><span class=o>,</span> <span class=mi>20</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>User</span> <span class=n>u2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>User</span><span class=o>(</span><span class=s>&#34;u2&#34;</span><span class=o>,</span> <span class=mi>30</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span> <span class=n>userAtomicReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicReference</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>userAtomicReference</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>u1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>userAtomicReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=n>u1</span><span class=o>,</span> <span class=n>u2</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=n>userAtomicReference</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>userAtomicReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=n>u1</span><span class=o>,</span> <span class=n>u2</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=n>userAtomicReference</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toString</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>User</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>String</span> <span class=n>username</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>age</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=è‡ªæ—‹é”>è‡ªæ—‹é”<a hidden class=anchor aria-hidden=true href=#è‡ªæ—‹é”>#</a></h2><p>çº¿ç¨‹æŒ‡å°è¯•è·å–é”çš„æ—¶å€™ä¸ä¼šç«‹å³é˜»å¡ï¼Œ<strong>é‡‡ç”¨å¾ªç¯çš„æ–¹å¼</strong>å»è·å–é”ã€‚
å½“çº¿ç¨‹è¢«å‘ç°å‡ºäºå ç”¨æ—¶å€™ï¼Œä¼šä¸æ–­å¾ªç¯åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œç›´åˆ°è·å–ã€‚</p><p><strong>è¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPU</strong></p><h3 id=è‡ªå®šä¹‰è‡ªæ—‹é”>è‡ªå®šä¹‰è‡ªæ—‹é”<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰è‡ªæ—‹é”>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicReference</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * è‡ªæ—‹é”å®ç°
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 11:46:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SpinLockDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span> <span class=n>atomicReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicReference</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>myLock</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;çº¿ç¨‹è¿›å…¥...&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(!</span><span class=n>atomicReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;æŒæœ‰é”..&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>myUnlock</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>atomicReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>(),</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;é‡Šæ”¾é”..&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SpinLockDemo</span> <span class=n>spinLockDemo</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SpinLockDemo</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>spinLockDemo</span><span class=o>.</span><span class=na>myLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>spinLockDemo</span><span class=o>.</span><span class=na>myUnlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t1&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹ï¼Œä¿è¯Açº¿ç¨‹å…ˆäºBçº¿ç¨‹å¯åŠ¨å¹¶å®Œæˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>spinLockDemo</span><span class=o>.</span><span class=na>myLock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>spinLockDemo</span><span class=o>.</span><span class=na>myUnlock</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t2&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h1 id=abaé—®é¢˜>ABAé—®é¢˜<a hidden class=anchor aria-hidden=true href=#abaé—®é¢˜>#</a></h1><p><strong>è‡ªæ—‹é”æ—¶é—´å¼€é”€å¤§</strong></p><h2 id=äº§ç”ŸåŸå› >äº§ç”ŸåŸå› <a hidden class=anchor aria-hidden=true href=#äº§ç”ŸåŸå› >#</a></h2><p>CASç®—æ³•å®ç°ä¸€ä¸ªé‡è¦å‰æéœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®å¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶é—´å·®ç±»ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–ã€‚</p><p>æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vä¸­å–å‡ºAï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†Bï¼Œ</p><p>ç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸã€‚</p><p><strong>å°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</strong></p><h2 id=è§£å†³aba>è§£å†³ABA<a hidden class=anchor aria-hidden=true href=#è§£å†³aba>#</a></h2><p>ç‰ˆæœ¬å·æ—¶é—´æˆ³åŸå­å¼•ç”¨: <code>AtomicStampedReference</code>ç±»</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicInteger</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicStampedReference</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ABAæ¼”ç¤ºåŠå…¶è§£å†³
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 12:10:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ABADemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=n>AtomicInteger</span> <span class=n>atomicInteger</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>atomicStampedReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicStampedReference</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;(</span>
</span></span><span class=line><span class=cl>      <span class=mi>100</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ABAé—®é¢˜æ¼”ç¤º
</span></span></span><span class=line><span class=cl><span class=c1>//    abaProblem();
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// ABAè§£å†³ ç‰ˆæœ¬å·æœºåˆ¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>stamp</span> <span class=o>=</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---é»˜è®¤ç‰ˆæœ¬å·: &#34;</span> <span class=o>+</span> <span class=n>stamp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>101</span><span class=o>,</span> <span class=n>stamp</span><span class=o>,</span> <span class=n>stamp</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---æäº¤ä¸€æ¬¡ç‰ˆæœ¬å·: &#34;</span> <span class=o>+</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>101</span><span class=o>,</span> <span class=mi>100</span><span class=o>,</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>          <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>()</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---æäº¤äºŒæ¬¡ç‰ˆæœ¬å·: &#34;</span> <span class=o>+</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t1&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>stamp</span> <span class=o>=</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---é»˜è®¤ç‰ˆæœ¬å·: &#34;</span> <span class=o>+</span> <span class=n>stamp</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>5</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>res</span> <span class=o>=</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>666</span><span class=o>,</span> <span class=n>stamp</span><span class=o>,</span> <span class=n>stamp</span> <span class=o>+</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;ä¿®æ”¹æˆåŠŸ: &#34;</span> <span class=o>+</span> <span class=n>res</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=n>atomicStampedReference</span><span class=o>.</span><span class=na>getStamp</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t2&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>abaProblem</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>atomicInteger</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>101</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>atomicInteger</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>101</span><span class=o>,</span> <span class=mi>100</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t1&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MICROSECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>10</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>res</span> <span class=o>=</span> <span class=n>atomicInteger</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>666</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;ä¿®æ”¹æˆåŠŸ: &#34;</span> <span class=o>+</span> <span class=n>res</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t2&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h1 id=åŸå­æ“ä½œç±»>åŸå­æ“ä½œç±»<a hidden class=anchor aria-hidden=true href=#åŸå­æ“ä½œç±»>#</a></h1><h2 id=åŸºæœ¬ç±»å‹åŸå­ç±»>åŸºæœ¬ç±»å‹åŸå­ç±»<a hidden class=anchor aria-hidden=true href=#åŸºæœ¬ç±»å‹åŸå­ç±»>#</a></h2><ul><li>AtomicInteger</li><li>AtomicBoolean</li><li>AtomicLong</li></ul><p><strong>å¸¸ç”¨API</strong></p><ul><li>public final int get() //è·å–å½“å‰çš„å€¼</li><li>public final int getAndSet(int newValue)//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</li><li>public final int getAndIncrement()//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</li><li>public final int getAndDecrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</li><li>public final int getAndAdd(int delta) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</li><li>boolean compareAndSet(int expect, int update) //å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.CountDownLatch</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicInteger</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.Data</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * AtomicInteger + CountDownLatch
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 15:30:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>NumberAdd</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=n>AtomicInteger</span> <span class=n>atomicInteger</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addPlus</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>atomicInteger</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicIntegerDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>50</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NumberAdd</span> <span class=n>numberAdd</span> <span class=o>=</span> <span class=k>new</span> <span class=n>NumberAdd</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>CountDownLatch</span> <span class=n>cdl</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>numberAdd</span><span class=o>.</span><span class=na>addPlus</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>cdl</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç”Ÿäº§ä¸ç”¨ä½¿ç”¨ -ã€‹ CountDownLatch
</span></span></span><span class=line><span class=cl><span class=c1>//    try {
</span></span></span><span class=line><span class=cl><span class=c1>//      TimeUnit.SECONDS.sleep(2);
</span></span></span><span class=line><span class=cl><span class=c1>//    } catch (InterruptedException e) {
</span></span></span><span class=line><span class=cl><span class=c1>//      e.printStackTrace();
</span></span></span><span class=line><span class=cl><span class=c1>//    }
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>cdl</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>numberAdd</span><span class=o>.</span><span class=na>getAtomicInteger</span><span class=o>().</span><span class=na>get</span><span class=o>());</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=æ•°ç»„ç±»å‹åŸå­ç±»>æ•°ç»„ç±»å‹åŸå­ç±»<a hidden class=anchor aria-hidden=true href=#æ•°ç»„ç±»å‹åŸå­ç±»>#</a></h2><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><h2 id=å¼•ç”¨ç±»å‹åŸå­ç±»>å¼•ç”¨ç±»å‹åŸå­ç±»<a hidden class=anchor aria-hidden=true href=#å¼•ç”¨ç±»å‹åŸå­ç±»>#</a></h2><ul><li>AtomicReference</li><li>AtomicStampedReference</li><li>AtomicMarkableReference</li></ul><h3 id=atomicstampedreference-ä¸-atomicmarkablereference-åŒºåˆ«>AtomicStampedReference ä¸ AtomicMarkableReference åŒºåˆ«<a hidden class=anchor aria-hidden=true href=#atomicstampedreference-ä¸-atomicmarkablereference-åŒºåˆ«>#</a></h3><p><code>AtomicStampedReference</code> æºå¸¦ç‰ˆæœ¬å·çš„å¼•ç”¨åŸå­ç±»å‹ï¼Œå¯ä»¥è§£å†³ABAé—®é¢˜ï¼Œ<strong>é‡ç‚¹åœ¨äºä¿®æ”¹å‡ æ¬¡</strong></p><p><code>AtomicMarkableReference</code> å¸¦æœ‰æ ‡è®°ä¸ºçš„å¼•ç”¨åŸå­ç±»å‹ï¼Œå°†çŠ¶æ€æˆ³è½¬ä¸ºboolå€¼ï¼Œ<strong>é‡åœ¨åœ¨äºæ˜¯å¦ä¿®æ”¹è¿‡</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicMarkableReference</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 16:33:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicMarkableReferenceDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=n>AtomicMarkableReference</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>markableReference</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicMarkableReference</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;(</span><span class=mi>100</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>marked</span> <span class=o>=</span> <span class=n>markableReference</span><span class=o>.</span><span class=na>isMarked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---é»˜è®¤ä¿®æ”¹è¡¨ç¤ºç¬¦å·: &#34;</span> <span class=o>+</span> <span class=n>marked</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>markableReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>101</span><span class=o>,</span> <span class=n>marked</span><span class=o>,</span> <span class=o>!</span><span class=n>marked</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t1&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>marked</span> <span class=o>=</span> <span class=n>markableReference</span><span class=o>.</span><span class=na>isMarked</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---é»˜è®¤ä¿®æ”¹è¡¨ç¤ºç¬¦å·: &#34;</span> <span class=o>+</span> <span class=n>marked</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=kt>boolean</span> <span class=n>b</span> <span class=o>=</span> <span class=n>markableReference</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=mi>100</span><span class=o>,</span> <span class=mi>666</span><span class=o>,</span> <span class=n>marked</span><span class=o>,</span> <span class=o>!</span><span class=n>marked</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;---ä¿®æ”¹æˆåŠŸ: &#34;</span> <span class=o>+</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=n>markableReference</span><span class=o>.</span><span class=na>getReference</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=n>markableReference</span><span class=o>.</span><span class=na>isMarked</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>},</span> <span class=s>&#34;t2&#34;</span><span class=o>).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»>å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»<a hidden class=anchor aria-hidden=true href=#å¯¹è±¡çš„å±æ€§ä¿®æ”¹åŸå­ç±»>#</a></h2><ul><li><code>AtomicIntegerFieldUpdater</code> ï¼š åŸå­æ›´æ–°å¯¹è±¡ä¸­intç±»å‹å­—æ®µçš„å€¼</li><li><code>AtomicLongFieldUpdater</code>ï¼š åŸå­æ›´æ–°å¯¹è±¡ä¸­Longç±»å‹å­—æ®µçš„å€¼</li><li><code>AtomicReferenceFieldUpdater</code> ï¼š åŸå­æ›´æ–°å¼•ç”¨ç±»å‹å­—æ®µçš„å€¼</li></ul><h3 id=äº§ç”Ÿ>äº§ç”Ÿ<a hidden class=anchor aria-hidden=true href=#äº§ç”Ÿ>#</a></h3><p>ä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼å»æ“ä½œéçº¿ç¨‹å®‰å…¨å¯¹è±¡çš„<strong>æŸäº›å­—æ®µ/å±æ€§</strong>ï¼Œé”æ›´åŠ è½»é‡çº§</p><h3 id=ä½¿ç”¨è¦æ±‚>ä½¿ç”¨è¦æ±‚<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨è¦æ±‚>#</a></h3><ol><li>æ›´æ–°çš„å¯¹è±¡å±æ€§å¿…é¡»ä½¿ç”¨ public volatile ä¿®é¥°ç¬¦ã€‚</li><li>å› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³•newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicIntegerFieldUpdater</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 16:59:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicIntegerFieldUpdaterDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BankAccount</span> <span class=n>bankAccount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BankAccount</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bankAccount</span><span class=o>.</span><span class=na>transfer</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;account: &#34;</span> <span class=o>+</span> <span class=n>bankAccount</span><span class=o>.</span><span class=na>money</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BankAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>String</span> <span class=n>bankName</span> <span class=o>=</span> <span class=s>&#34;ccb&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>volatile</span> <span class=kt>int</span> <span class=n>money</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ“ä½œç»å¸¸å‘ç”Ÿå˜åŒ– æ˜“äºæ›´æ–°çš„
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>AtomicIntegerFieldUpdater</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=n>fieldUpdater</span> <span class=o>=</span> <span class=n>AtomicIntegerFieldUpdater</span><span class=o>.</span><span class=na>newUpdater</span><span class=o>(</span><span class=n>BankAccount</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;money&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>transfer</span><span class=o>(</span><span class=n>BankAccount</span> <span class=n>bankAccount</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fieldUpdater</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.TimeUnit</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicReferenceFieldUpdater</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * åˆå§‹åŒ–ä¸€æ¬¡
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 17:04:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>Myvar</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>volatile</span> <span class=n>Boolean</span> <span class=n>isInit</span> <span class=o>=</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>FALSE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=n>AtomicReferenceFieldUpdater</span><span class=o>&lt;</span><span class=n>Myvar</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>&gt;</span> <span class=n>fieldUpdater</span> <span class=o>=</span> <span class=n>AtomicReferenceFieldUpdater</span><span class=o>.</span><span class=na>newUpdater</span><span class=o>(</span><span class=n>Myvar</span><span class=o>.</span><span class=na>class</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Boolean</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=s>&#34;isInit&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>init</span><span class=o>(</span><span class=n>Myvar</span> <span class=n>myvar</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>fieldUpdater</span><span class=o>.</span><span class=na>compareAndSet</span><span class=o>(</span><span class=n>myvar</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>FALSE</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>TRUE</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=s>&#34;------start init&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=s>&#34;------end init&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;\t&#34;</span> <span class=o>+</span> <span class=s>&#34;------æŠ¢é”å¤±è´¥  &#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AtomicReferenceFieldUpdaterDemo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Myvar</span> <span class=n>myvar</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Myvar</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>myvar</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>myvar</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=åŸå­æ“ä½œå¢å¼ºç±»>åŸå­æ“ä½œå¢å¼ºç±»<a hidden class=anchor aria-hidden=true href=#åŸå­æ“ä½œå¢å¼ºç±»>#</a></h2><ul><li>DoubleAccumulator</li><li>DoubleAdder</li><li>LongAccumulator</li><li>LongAdder</li></ul><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A44B1ACF-0D04-4D5A-A710-728095FF5B66.png alt=img></p><ul><li>LongAdderåªèƒ½ç”¨æ¥è®¡ç®—åŠ æ³•ï¼Œä¸”ä»é›¶å¼€å§‹è®¡ç®—</li><li>LongAccumulatoræä¾›äº†è‡ªå®šä¹‰çš„å‡½æ•°æ“ä½œ</li></ul><blockquote><p>å¯¹äºå¤§æ•°æ®ç»Ÿè®¡ï¼Œä½¿ç”¨LongAdder</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.CountDownLatch</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.AtomicLong</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.LongAccumulator</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.concurrent.atomic.LongAdder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ18æ—¥ 17:34:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ClickNumberNet</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>number</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>clickBySync</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>number</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>AtomicLong</span> <span class=n>atomicLong</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicLong</span><span class=o>(</span><span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clickByAtomicLong</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>atomicLong</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>LongAdder</span> <span class=n>longAdder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LongAdder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clickByLongAdder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>longAdder</span><span class=o>.</span><span class=na>increment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>LongAccumulator</span> <span class=n>longAccumulator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LongAccumulator</span><span class=o>((</span><span class=n>x</span><span class=o>,</span> <span class=n>y</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=o>,</span> <span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clickByLongAccumulator</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>longAccumulator</span><span class=o>.</span><span class=na>accumulate</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LongAdderDemo2</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ClickNumberNet</span> <span class=n>clickNumberNet</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ClickNumberNet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>startTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>endTime</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>CountDownLatch</span> <span class=n>countDownLatch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>CountDownLatch</span> <span class=n>countDownLatch2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>CountDownLatch</span> <span class=n>countDownLatch3</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>CountDownLatch</span> <span class=n>countDownLatch4</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=mi>50</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mi>100</span> <span class=o>*</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>clickBySync</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>countDownLatch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>countDownLatch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>endTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;----costTime: &#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>endTime</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; æ¯«ç§’&#34;</span> <span class=o>+</span> <span class=s>&#34;\t clickBySync result: &#34;</span> <span class=o>+</span> <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>number</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mi>100</span> <span class=o>*</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>clickByAtomicLong</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>countDownLatch2</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>countDownLatch2</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>endTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;----costTime: &#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>endTime</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; æ¯«ç§’&#34;</span> <span class=o>+</span> <span class=s>&#34;\t clickByAtomicLong result: &#34;</span> <span class=o>+</span> <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>atomicLong</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mi>100</span> <span class=o>*</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>clickByLongAdder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>countDownLatch3</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>countDownLatch3</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>endTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;----costTime: &#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>endTime</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; æ¯«ç§’&#34;</span> <span class=o>+</span> <span class=s>&#34;\t clickByLongAdder result: &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>longAdder</span><span class=o>.</span><span class=na>sum</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>startTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=o>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mi>100</span> <span class=o>*</span> <span class=mi>10000</span><span class=o>;</span> <span class=n>j</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>clickByLongAccumulator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>countDownLatch4</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>},</span> <span class=n>String</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>i</span><span class=o>)).</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>countDownLatch4</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>endTime</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;----costTime: &#34;</span> <span class=o>+</span> <span class=o>(</span><span class=n>endTime</span> <span class=o>-</span> <span class=n>startTime</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; æ¯«ç§’&#34;</span> <span class=o>+</span> <span class=s>&#34;\t clickByLongAccumulator result: &#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>+</span> <span class=n>clickNumberNet</span><span class=o>.</span><span class=na>longAccumulator</span><span class=o>.</span><span class=na>longValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/image-20230718173650061.png alt=image-20230718173650061></p><h2 id=longadderå¿«çš„åŸå› >LongAdderå¿«çš„åŸå› <a hidden class=anchor aria-hidden=true href=#longadderå¿«çš„åŸå› >#</a></h2><p><code>abstract class Striped64 extends Number</code></p><p>LongAdderçš„åŸºæœ¬æ€è·¯å°±æ˜¯<strong>åˆ†æ•£çƒ­ç‚¹</strong>ï¼Œå°†valueå€¼åˆ†æ•£åˆ°ä¸€ä¸ª<strong>Cellæ•°ç»„</strong>ä¸­ï¼Œä¸åŒçº¿ç¨‹ä¼šå‘½ä¸­åˆ°æ•°ç»„çš„ä¸åŒæ§½ä¸­ï¼Œå„ä¸ªçº¿ç¨‹åªå¯¹è‡ªå·±æ§½ä¸­çš„é‚£ä¸ªå€¼è¿›è¡ŒCASæ“ä½œï¼Œè¿™æ ·çƒ­ç‚¹å°±è¢«åˆ†æ•£äº†ï¼Œå†²çªçš„æ¦‚ç‡å°±å°å¾ˆå¤šã€‚å¦‚æœè¦è·å–çœŸæ­£çš„longå€¼ï¼Œåªè¦å°†å„ä¸ªæ§½ä¸­çš„å˜é‡å€¼ç´¯åŠ è¿”å›ã€‚</p><p>sum()ä¼šå°†æ‰€æœ‰Cellæ•°ç»„ä¸­çš„valueå’Œbaseç´¯åŠ ä½œä¸ºè¿”å›å€¼ï¼Œæ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯å°†ä¹‹å‰AtomicLongä¸€ä¸ªvalueçš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªvalueä¸­å»ï¼Œ</p><p><strong>ä»è€Œé™çº§æ›´æ–°çƒ­ç‚¹ã€‚</strong></p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/AF25B743-CB20-40D9-9DD9-ABC76B2F1D3B.png alt=img></p><p>å†…éƒ¨æœ‰ä¸€ä¸ªbaseå˜é‡ï¼Œä¸€ä¸ªCell[]æ•°ç»„ã€‚</p><ul><li>baseå˜é‡ï¼šéç«æ€æ¡ä»¶ä¸‹ï¼Œç›´æ¥ç´¯åŠ åˆ°è¯¥å˜é‡ä¸Š</li><li>Cell[]æ•°ç»„ï¼šç«æ€æ¡ä»¶ä¸‹ï¼Œç´¯åŠ ä¸ªå„ä¸ªçº¿ç¨‹è‡ªå·±çš„æ§½Cell[i]ä¸­</li></ul><p>LongAdderåœ¨æ— ç«äº‰çš„æƒ…å†µï¼Œè·ŸAtomicLongä¸€æ ·ï¼Œå¯¹åŒä¸€ä¸ªbaseè¿›è¡Œæ“ä½œï¼Œå½“å‡ºç°ç«äº‰å…³ç³»æ—¶åˆ™æ˜¯é‡‡ç”¨åŒ–æ•´ä¸ºé›¶çš„åšæ³•ï¼Œä»ç©ºé—´æ¢æ—¶é—´ï¼Œç”¨ä¸€ä¸ªæ•°ç»„cellsï¼Œå°†ä¸€ä¸ªvalueæ‹†åˆ†è¿›è¿™ä¸ªæ•°ç»„cellsã€‚å¤šä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶å¯¹valueè¿›è¡Œæ“ä½œæ—¶å€™ï¼Œå¯ä»¥å¯¹çº¿ç¨‹idè¿›è¡Œhashå¾—åˆ°hashå€¼ï¼Œå†æ ¹æ®hashå€¼æ˜ å°„åˆ°è¿™ä¸ªæ•°ç»„cellsçš„æŸä¸ªä¸‹æ ‡ï¼Œå†å¯¹è¯¥ä¸‹æ ‡æ‰€å¯¹åº”çš„å€¼è¿›è¡Œè‡ªå¢æ“ä½œã€‚å½“æ‰€æœ‰çº¿ç¨‹æ“ä½œå®Œæ¯•ï¼Œå°†æ•°ç»„cellsçš„æ‰€æœ‰å€¼å’Œæ— ç«äº‰å€¼baseéƒ½åŠ èµ·æ¥ä½œä¸ºæœ€ç»ˆç»“æœã€‚</p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/0203AB5C-B6F1-4EBE-B970-A67B9BC3325D.png alt=img></p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/E1151568-974E-4F52-B624-2FC8EC7E671F.png alt=img></p><h2 id=atomiclong-ä¸-longadder>AtomicLong ä¸ LongAdder<a hidden class=anchor aria-hidden=true href=#atomiclong-ä¸-longadder>#</a></h2><h3 id=atomiclong>AtomicLong<a hidden class=anchor aria-hidden=true href=#atomiclong>#</a></h3><h4 id=åŸç†>åŸç†<a hidden class=anchor aria-hidden=true href=#åŸç†>#</a></h4><p>CAS+è‡ªæ—‹</p><h4 id=åœºæ™¯>åœºæ™¯<a hidden class=anchor aria-hidden=true href=#åœºæ™¯>#</a></h4><ul><li>ä½å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®—</li><li>AtomicLongèƒ½ä¿è¯å¹¶å‘æƒ…å†µä¸‹è®¡æ•°çš„å‡†ç¡®æ€§ï¼Œå…¶å†…éƒ¨é€šè¿‡CASæ¥è§£å†³å¹¶å‘å®‰å…¨æ€§çš„é—®é¢˜ã€‚</li></ul><h4 id=ç¼ºé™·>ç¼ºé™·<a hidden class=anchor aria-hidden=true href=#ç¼ºé™·>#</a></h4><p>é«˜å¹¶å‘åæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œè‡ªæ—‹å¸¦æ¥çš„</p><h3 id=longadder>LongAdder<a hidden class=anchor aria-hidden=true href=#longadder>#</a></h3><h4 id=åŸç†-1>åŸç†<a hidden class=anchor aria-hidden=true href=#åŸç†-1>#</a></h4><ul><li>CAS+Base+Cellæ•°ç»„åˆ†æ•£</li><li>ç©ºé—´æ¢æ—¶é—´å¹¶åˆ†æ•£äº†çƒ­ç‚¹æ•°æ®</li></ul><h4 id=åœºæ™¯-1>åœºæ™¯<a hidden class=anchor aria-hidden=true href=#åœºæ™¯-1>#</a></h4><p>é«˜å¹¶å‘ä¸‹çš„å…¨å±€è®¡ç®—ï¼Œé€‚åˆç²—ç•¥è®¡ç®—</p><h4 id=ç¼ºé™·-1>ç¼ºé™·<a hidden class=anchor aria-hidden=true href=#ç¼ºé™·-1>#</a></h4><p>sumæ±‚å’Œä¹‹åå¦‚æœè¿˜æœ‰çº¿ç¨‹ä¿®æ”¹ç»“æœï¼Œæœ€åç»“æœä¸å¤ªå‡†ç¡®</p><h1 id=longadderæºç åˆ†æ>LongAdderæºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#longadderæºç åˆ†æ>#</a></h1><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A53885E2-69C4-4244-8E9D-8BB9F6363657.png alt=img></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LongAdder</span><span class=err>#</span><span class=n>increment</span> <span class=o>-&gt;</span> <span class=err>#</span><span class=n>add</span>
</span></span><span class=line><span class=cl>   <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   csæ˜¯Striped64 çš„cellsæ•°ç»„å±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>   bæ˜¯Striped64 çš„baseå±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>   væ˜¯å½“å‰çº¿ç¨‹hashåˆ°cellå­˜å‚¨çš„å€¼
</span></span></span><span class=line><span class=cl><span class=cm>   mæ˜¯cellé•¿åº¦å‡1ï¼Œhashä½œä¸ºæ©ç ä½¿ç”¨
</span></span></span><span class=line><span class=cl><span class=cm>   aæ˜¯å½“å‰çº¿ç¨‹hashåˆ°çš„cell
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>add</span><span class=o>(</span><span class=kt>long</span> <span class=n>x</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Cell</span><span class=o>[]</span> <span class=n>cs</span><span class=o>;</span> <span class=kt>long</span> <span class=n>b</span><span class=o>,</span> <span class=n>v</span><span class=o>;</span> <span class=kt>int</span> <span class=n>m</span><span class=o>;</span> <span class=n>Cell</span> <span class=n>c</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    	<span class=c1>// é¦–æ¬¡çº¿ç¨‹è¿›æ¥ï¼Œ(cs = cells) != null ä¸€å®šä¸ºfalse, èµ°#casBaseæ–¹æ³•ï¼Œä»¥caså‡¡æ˜¯æ›´æ–°bashå€¼ï¼Œåªæœ‰æ›´æ–°å¤±è´¥ï¼Œèµ°åˆ°ifä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=c1>// (cs = cells) != null  ä¸ºtrue: è¯´æ˜å‡ºç°è¿‡çº¿ç¨‹ç«äº‰ï¼ŒCellæ•°ç»„å·²ç»è¢«åˆ›å»º
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=c1>// æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŠ¢å…ˆå¼‚æ­¥ä¿®æ”¹äº†base æ­£åœ¨å‡ºç°ç«äº‰
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>((</span><span class=n>cs</span> <span class=o>=</span> <span class=n>cells</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>casBase</span><span class=o>(</span><span class=n>b</span> <span class=o>=</span> <span class=n>base</span><span class=o>,</span> <span class=n>b</span> <span class=o>+</span> <span class=n>x</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// è¯¥æ–¹æ³•è¿”å›çº¿ç¨‹çš„ThreadLocalRandomå­—æ®µ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// é€šè¿‡éšæœºæ•°ç”Ÿæˆçš„ä¸€ä¸ªå€¼ï¼Œå¯¹äºä¸€ä¸ªç¡®å®šçš„çº¿ç¨‹è¿™ä¸ªå€¼æ˜¯å›ºå®šçš„
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>getProbe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// trueä¸ºæ— ç«äº‰ falseè¡¨ç¤ºç«äº‰æ¿€çƒˆï¼Œå¤šä¸ªhashåˆ°åŒä¸€ä¸ªcell, å¯èƒ½è¦æ‰©å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>boolean</span> <span class=n>uncontended</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// cellä¸ºç©ºï¼Œè¯´æ˜æ­£åœ¨å‡ºç°ç«äº‰ï¼Œä¾æ®ä¸Šé¢æ¡ä»¶2
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// (m = cs.length - 1) &lt; 0 åº”è¯¥ä¸ä¼šå‡ºç°
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//  (c = cs[index &amp; m]) == null å½“å‰çº¿ç¨‹æ‰€åœ¨çš„cellä¸ºç©ºï¼Œè¯´æ˜çº¿ç¨‹è¿˜æ²¡æœ‰åˆå§‹åŒ–è¿‡cellï¼Œåº”åˆå§‹ä¸€ä¸ªcell
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// æ›´æ–°å½“å‰æ‰€åœ¨çº¿ç¨‹Cellå¤±è´¥ï¼Œè¯´æ˜ç«äº‰æ¿€çƒˆï¼Œå¤šä¸ªçº¿ç¨‹Hashåˆ°åŒä¸€ä¸ªcell,åº”æ‰©å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>cs</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>(</span><span class=n>m</span> <span class=o>=</span> <span class=n>cs</span><span class=o>.</span><span class=na>length</span> <span class=o>-</span> <span class=mi>1</span><span class=o>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                <span class=o>(</span><span class=n>c</span> <span class=o>=</span> <span class=n>cs</span><span class=o>[</span><span class=n>index</span> <span class=o>&amp;</span> <span class=n>m</span><span class=o>])</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                <span class=o>!(</span><span class=n>uncontended</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>cas</span><span class=o>(</span><span class=n>v</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>value</span><span class=o>,</span> <span class=n>v</span> <span class=o>+</span> <span class=n>x</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                <span class=n>longAccumulate</span><span class=o>(</span><span class=n>x</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>uncontended</span><span class=o>,</span> <span class=n>index</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=n>longAccumulate</span>
</span></span><span class=line><span class=cl>    <span class=kd>final</span> <span class=kt>void</span> <span class=nf>longAccumulate</span><span class=o>(</span><span class=kt>long</span> <span class=n>x</span><span class=o>,</span> <span class=n>LongBinaryOperator</span> <span class=n>fn</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                              <span class=kt>boolean</span> <span class=n>wasUncontended</span><span class=o>,</span> <span class=kt>int</span> <span class=n>index</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>index</span> <span class=o>==</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ThreadLocalRandom</span><span class=o>.</span><span class=na>current</span><span class=o>();</span> <span class=c1>// force initialization
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>index</span> <span class=o>=</span> <span class=n>getProbe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>wasUncontended</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=kt>boolean</span> <span class=n>collide</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;;)</span> <span class=o>{</span>       <span class=c1>// True if last slot nonempty
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Cell</span><span class=o>[]</span> <span class=n>cs</span><span class=o>;</span> <span class=n>Cell</span> <span class=n>c</span><span class=o>;</span> <span class=kt>int</span> <span class=n>n</span><span class=o>;</span> <span class=kt>long</span> <span class=n>v</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// cellå·²ç»è¢«åˆå§‹åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=o>((</span><span class=n>cs</span> <span class=o>=</span> <span class=n>cells</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>n</span> <span class=o>=</span> <span class=n>cs</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// çº¿ç¨‹hashå€¼è¿ç®—ä¹‹åå¾—åˆ°çš„cellå•å…ƒä¸ºä¸ºnullï¼Œè¯´æ˜cellæ²¡æœ‰è¢«ä½¿ç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=o>((</span><span class=n>c</span> <span class=o>=</span> <span class=n>cs</span><span class=o>[(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>index</span><span class=o>])</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                     <span class=c1>// cellæ•°ç»„æ­£åœ¨æ‰©å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>cellsBusy</span> <span class=o>==</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>       
</span></span><span class=line><span class=cl>                        <span class=n>Cell</span> <span class=n>r</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Cell</span><span class=o>(</span><span class=n>x</span><span class=o>);</span>   <span class=c1>//åˆ›å»ºå•å…ƒæ ¼
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>cellsBusy</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>casCellsBusy</span><span class=o>())</span> <span class=o>{</span> <span class=c1>//å°è¯•åŠ é”ï¼ŒæˆåŠŸåcellsBusy = 1
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>try</span> <span class=o>{</span>              
</span></span><span class=line><span class=cl>                                <span class=n>Cell</span><span class=o>[]</span> <span class=n>rs</span><span class=o>;</span> <span class=kt>int</span> <span class=n>m</span><span class=o>,</span> <span class=n>j</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// double check
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=o>((</span><span class=n>rs</span> <span class=o>=</span> <span class=n>cells</span><span class=o>)</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                                    <span class=o>(</span><span class=n>m</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>length</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                                    <span class=n>rs</span><span class=o>[</span><span class=n>j</span> <span class=o>=</span> <span class=o>(</span><span class=n>m</span> <span class=o>-</span> <span class=mi>1</span><span class=o>)</span> <span class=o>&amp;</span> <span class=n>index</span><span class=o>]</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=n>rs</span><span class=o>[</span><span class=n>j</span><span class=o>]</span> <span class=o>=</span> <span class=n>r</span><span class=o>;</span> <span class=c1>// æ·»åŠ åˆ°cellä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>cellsBusy</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                            <span class=k>continue</span><span class=o>;</span>           <span class=c1>// Slot is now non-empty
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>collide</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>wasUncontended</span><span class=o>)</span>       <span class=c1>// CAS already known to fail wasUncontendedè¡¨ç¤ºå‰ä¸€æ¬¡æ›´æ–°cellå•å…ƒæ ¼æ˜¯å¦æˆåŠŸ
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>wasUncontended</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>      <span class=c1>// Continue after rehash é‡ç½®ä¸ºtrueï¼Œåé¢é‡æ–°è®¡ç®—çº¿ç¨‹çš„hashå€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>c</span><span class=o>.</span><span class=na>cas</span><span class=o>(</span><span class=n>v</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>value</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                               <span class=o>(</span><span class=n>fn</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>v</span> <span class=o>+</span> <span class=n>x</span> <span class=o>:</span> <span class=n>fn</span><span class=o>.</span><span class=na>applyAsLong</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>x</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>n</span> <span class=o>&gt;=</span> <span class=n>NCPU</span> <span class=o>||</span> <span class=n>cells</span> <span class=o>!=</span> <span class=n>cs</span><span class=o>)</span> <span class=c1>// cellsæ•°ç»„å¤§å°è¶…è¿‡CPUæ ¸æ•°ï¼Œæ°¸è¿œä¸ä¼šæ‰©å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>collide</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>            <span class=c1>// At max size or stale
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>collide</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>collide</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cellsBusy</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>casCellsBusy</span><span class=o>())</span> <span class=o>{</span> <span class=c1>// å°è¯•åŠ é”æ‰©å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=o>(</span><span class=n>cells</span> <span class=o>==</span> <span class=n>cs</span><span class=o>)</span>        <span class=c1>// æ‰©å®¹åçš„å¤§å° = å½“å‰å®¹é‡ * 2
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=n>cells</span> <span class=o>=</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>copyOf</span><span class=o>(</span><span class=n>cs</span><span class=o>,</span> <span class=n>n</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>cellsBusy</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>collide</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=o>;</span>                   <span class=c1>// Retry with expanded table
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=n>index</span> <span class=o>=</span> <span class=n>advanceProbe</span><span class=o>(</span><span class=n>index</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// cellåœ¨æ²¡æœ‰åŠ é”ä¸”æ²¡æœ‰åˆå§‹åŒ–ï¼Œå°è¯•åŠ é”ï¼Œä¸”åˆå§‹åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>cellsBusy</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>cells</span> <span class=o>==</span> <span class=n>cs</span> <span class=o>&amp;&amp;</span> <span class=n>casCellsBusy</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=o>{</span>                           <span class=c1>// Initialize table
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=o>(</span><span class=n>cells</span> <span class=o>==</span> <span class=n>cs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>Cell</span><span class=o>[]</span> <span class=n>rs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Cell</span><span class=o>[</span><span class=mi>2</span><span class=o>];</span>
</span></span><span class=line><span class=cl>                        <span class=n>rs</span><span class=o>[</span><span class=n>index</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=o>]</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Cell</span><span class=o>(</span><span class=n>x</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>cells</span> <span class=o>=</span> <span class=n>rs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>cellsBusy</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// cellæ­£åœ¨åˆå§‹åŒ–ï¼Œç›´æ¥åœ¨åŸºæ•°baseä¸Šé¢è¿›è¡Œç´¯åŠ æ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>casBase</span><span class=o>(</span><span class=n>v</span> <span class=o>=</span> <span class=n>base</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                             <span class=o>(</span><span class=n>fn</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>?</span> <span class=n>v</span> <span class=o>+</span> <span class=n>x</span> <span class=o>:</span> <span class=n>fn</span><span class=o>.</span><span class=na>applyAsLong</span><span class=o>(</span><span class=n>v</span><span class=o>,</span> <span class=n>x</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>    
</span></span></code></pre></div><h2 id=-å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡®>? å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡®<a hidden class=anchor aria-hidden=true href=#-å¹¶å‘ä¸‹ä¸ºä»€ä¹ˆsumå€¼ä¸ç²¾ç¡®>#</a></h2><p>sum()ä¼šå°†æ‰€æœ‰Cellæ•°ç»„ä¸­çš„valueå’Œbaseç´¯åŠ ä½œä¸ºè¿”å›å€¼ã€‚<strong>æœ€ç»ˆä¸€è‡´æ€§</strong></p><p><strong>æ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯å°†ä¹‹å‰AtomicLongä¸€ä¸ªvalueçš„æ›´æ–°å‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªvalueä¸­å»ï¼Œä»è€Œé™çº§æ›´æ–°çƒ­ç‚¹ã€‚</strong></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://AlfredNing.github.io/note/program/juc/04-threadlocal/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>04 ThreadLocal</span></a>
<a class=next href=https://AlfredNing.github.io/note/program/juc/02-volatile/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>02-Volatile</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=AlfredNing/AlfredNing.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://AlfredNing.github.io>AlfredNing</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>