<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>04 ThreadLocal | AlfredNing</title>
<meta name=keywords content><meta name=description content='定义 ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。
每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题 每个线程对该值都是各自线程互相独立访问的 初始化 ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? 为什么要加remove方法
防止内存泄露
实践 不安全的SimpleDateFormat 问题演示 class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><meta name=author content="AlfredNing"><link rel=canonical href=https://AlfredNing.github.io/note/program/juc/04-threadlocal/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.992dd02838d36453c6b1ff2a12a60049a3e447cd982ad5f7b4470d32eb4648e2.css integrity="sha256-mS3QKDjTZFPGsf8qEqYASaPkR82YKtX3tEcNMutGSOI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://AlfredNing.github.io/note/program/juc/04-threadlocal/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="04 ThreadLocal"><meta property="og:description" content='定义 ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。
每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题 每个线程对该值都是各自线程互相独立访问的 初始化 ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? 为什么要加remove方法
防止内存泄露
实践 不安全的SimpleDateFormat 问题演示 class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><meta property="og:type" content="article"><meta property="og:url" content="https://AlfredNing.github.io/note/program/juc/04-threadlocal/"><meta property="article:section" content="note"><meta property="article:published_time" content="2023-07-19T16:22:32+08:00"><meta property="article:modified_time" content="2023-07-20T16:40:10+08:00"><meta property="og:site_name" content="Alfred.Ning"><meta name=twitter:card content="summary"><meta name=twitter:title content="04 ThreadLocal"><meta name=twitter:description content='定义 ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。
每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题 每个线程对该值都是各自线程互相独立访问的 初始化 ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? 为什么要加remove方法
防止内存泄露
实践 不安全的SimpleDateFormat 问题演示 class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"笔记","item":"https://AlfredNing.github.io/note/"},{"@type":"ListItem","position":2,"name":"编程","item":"https://AlfredNing.github.io/note/program/"},{"@type":"ListItem","position":3,"name":"juc","item":"https://AlfredNing.github.io/note/program/juc/"},{"@type":"ListItem","position":4,"name":"04 ThreadLocal","item":"https://AlfredNing.github.io/note/program/juc/04-threadlocal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"04 ThreadLocal","name":"04 ThreadLocal","description":"定义 ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。\n每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题 每个线程对该值都是各自线程互相独立访问的 初始化 ThreadLocal\u0026lt;Integer\u0026gt; tl1 = new ThreadLocal\u0026lt;Integer\u0026gt;() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal\u0026lt;Integer\u0026gt; tl2 = ThreadLocal.withInitial(() -\u0026gt; 2); ? 为什么要加remove方法\n防止内存泄露\n实践 不安全的SimpleDateFormat 问题演示 class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u0026lt; 5; i++) { new Thread(() -\u0026gt; { try { System.","keywords":[""],"articleBody":"定义 ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。\n每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题 每个线程对该值都是各自线程互相独立访问的 初始化 ThreadLocal\u003cInteger\u003e tl1 = new ThreadLocal\u003cInteger\u003e() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal\u003cInteger\u003e tl2 = ThreadLocal.withInitial(() -\u003e 2); ? 为什么要加remove方法\n防止内存泄露\n实践 不安全的SimpleDateFormat 问题演示 class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u003c 5; i++) { new Thread(() -\u003e { try { System.out.println(parseSdf(\"2023-07-20 11:08:10\")); } catch (ParseException e) { e.printStackTrace(); } }, String.valueOf(i)).start(); } } } 原因分析 SimpleDateFormat类内部有一个Calendar对象引用,它用来储存和这个SimpleDateFormat相关的日期信息,例如sdf.parse(dateStr),sdf.format(date) 诸如此类的方法参数传入的日期相关String,Date等等, 都是交由Calendar引用来储存的.这样就会导致一个问题如果你的SimpleDateFormat是个static的, 那么多个thread 之间就会共享这个SimpleDateFormat, 同时也是共享这个Calendar引用。\n解决措施1 - 局部变量 将将SimpleDateFormat定义成局部变量。\n缺点:：每调用一次方法就会创建一个SimpleDateFormat对象，方法结束又要作为垃圾回收。\n解决措施2 - ThreadLocal class SimpleDateFormatDemo { public static final ThreadLocal\u003cSimpleDateFormat\u003e tlsdf = ThreadLocal.withInitial( () -\u003e new SimpleDateFormat(\"yyyy-MM-mm HH:mm:ss\")); public static Date parseSdf(String dataStr) throws ParseException { return tlsdf.get().parse(dataStr); } public static void remove() { tlsdf.remove(); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u003c 5; i++) { new Thread(() -\u003e { try { System.out.println(parseSdf(\"2023-07-20 11:08:10\")); } catch (ParseException e) { e.printStackTrace(); } finally { remove(); } }, String.valueOf(i)).start(); } } } 解决措施3 加锁 第三发时间库 如果是JDK8应用，用Instant 代替Date, LocalDateTime 代替Calendar DateTimeFormatter代替SimpleDateFormat 源码分析 Thread TheadLocal ThreadLocalMap关系 Thread内部有一个ThreadLocal:各自线程都有\nTheadLocal内部有ThreadLocalMap，ThreadLocalMap 含有entry 键值对,键类型：ThreadLocal\n// set方法 public void set(T value) { // 获取当前线程 Thread t = Thread.currentThread(); // 获取ThreadLocalMap ThreadLocalMap map = getMap(t); if (map != null) { map.set(this, value); } else { createMap(t, value); } } void createMap(Thread t, T firstValue) { t.threadLocals = new ThreadLocalMap(this, firstValue); } ThreadLocalMap(ThreadLocal\u003c?\u003e firstKey, Object firstValue) { table = new Entry[INITIAL_CAPACITY]; int i = firstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); size = 1; setThreshold(INITIAL_CAPACITY); } // get方法 public T get() { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) { @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; } } return setInitialValue(); } 内存泄露问题 内存泄露：不再会被使用的对象或者变量占用的内存不能给回收\n强引用 当内存不足，JVM开始垃圾回收，对于强引用的对象，就算是出现了OOM也不会对该对象进行回收，默认支持模式\n强引用是我们最常见的普通对象引用，只要还有强引用指向一个对象，就能表明对象还“活着”，垃圾收集器不会碰这种对象。在 Java 中最常见的就是强引用，把一个对象赋给一个引用变量，这个引用变量就是一个强引用。当一个对象被强引用变量引用时，它处于可达状态，它是不可能被垃圾回收机制回收的，即使该对象以后永远都不会被用到JVM也不会回收。因此强引用是造成Java内存泄漏的主要原因之一。\n对于一个普通的对象，如果没有其他的引用关系，只要超过了引用的作用域或者显式地将相应（强）引用赋值为 null，一般认为就是可以被垃圾收集的了(当然具体回收时机还是要看垃圾收集策略)。\n软引用 软引用相对强引用弱化了一些引用，需要引用java.lang.ref.SoftReference类来实现，可以让对象豁免一些垃圾收集。系统内存充足不会回收，系统内存不足会被回收\n软引用通常用在对内存敏感的程序中，比如高速缓存就有用到软引用，内存够用的时候就保留，不够用就回收！\n弱引用 弱引用需要用java.lang.ref.WeakReference类来实现，它比软引用的生存期更短。只要垃圾回收机制一旦运行，不管JVM的内存空间是否充足，都会回收该对象占用的内存\n软引用和弱引用的适用场景\n假如有一个应用需要读取大量的本地图片:\n如果每次读取图片都从硬盘读取则会严重影响性能, 如果一次性全部加载到内存中又可能造成内存溢出。 此时使用软引用可以解决这个问题。\n设计思路是：用一个HashMap来保存图片的路径和相应图片对象关联的软引用之间的映射关系，在内存不足时，JVM会自动回收这些缓存图片对象所占用的空间，从而有效地避免了OOM的问题。\nMap","wordCount":"487","inLanguage":"zh","datePublished":"2023-07-19T16:22:32+08:00","dateModified":"2023-07-20T16:40:10+08:00","author":[{"@type":"Person","name":"AlfredNing"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://AlfredNing.github.io/note/program/juc/04-threadlocal/"},"publisher":{"@type":"Organization","name":"AlfredNing","logo":{"@type":"ImageObject","url":"https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://AlfredNing.github.io/ accesskey=h title="AlfredNing (Alt + H)">AlfredNing</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://AlfredNing.github.io/note/ title=📓笔记><span>📓笔记</span></a></li><li><a href=https://AlfredNing.github.io/thinking/ title=🤔黑洞><span>🤔黑洞</span></a></li><li><a href=https://AlfredNing.github.io/search/ title="🔎搜索 (Alt + /)" accesskey=/><span>🔎搜索</span></a></li><li><a href=https://AlfredNing.github.io/tags/ title=🏷️标签><span>🏷️标签</span></a></li><li><a href=https://AlfredNing.github.io/archives title=🗄️归档><span>🗄️归档</span></a></li><li><a href=https://AlfredNing.github.io/about title=🤙关于><span>🤙关于</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://AlfredNing.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://AlfredNing.github.io/note/>笔记</a>&nbsp;»&nbsp;<a href=https://AlfredNing.github.io/note/program/>编程</a>&nbsp;»&nbsp;<a href=https://AlfredNing.github.io/note/program/juc/>juc</a></div><h1 class=post-title>04 ThreadLocal</h1><div class=post-meta>创建:&amp;nbsp;&lt;span title='2023-07-19 16:22:32 +0800 +0800'>2023年-07月-19日&lt;/span>&amp;nbsp;|&amp;nbsp;更新:&amp;nbsp;2023年-07月-20日&amp;nbsp;|&amp;nbsp;字数:&amp;nbsp;487字&amp;nbsp;|&amp;nbsp;时长:&amp;nbsp;3分钟&amp;nbsp;|&amp;nbsp;AlfredNing
&nbsp;|&nbsp;标签: &nbsp;<ul class=post-tags-meta><a href=https://AlfredNing.github.io/tags/juc/>Juc</a></ul></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%ae%9a%e4%b9%89 aria-label=定义>定义</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=初始化>初始化</a></li></ul></li><li><a href=#%e5%ae%9e%e8%b7%b5 aria-label=实践>实践</a><ul><li><a href=#%e4%b8%8d%e5%ae%89%e5%85%a8%e7%9a%84simpledateformat aria-label=不安全的SimpleDateFormat>不安全的SimpleDateFormat</a><ul><li><a href=#%e9%97%ae%e9%a2%98%e6%bc%94%e7%a4%ba aria-label=问题演示>问题演示</a></li><li><a href=#%e5%8e%9f%e5%9b%a0%e5%88%86%e6%9e%90 aria-label=原因分析>原因分析</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd1---%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f aria-label="解决措施1 - 局部变量">解决措施1 - 局部变量</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd2---threadlocal aria-label="解决措施2 - ThreadLocal">解决措施2 - ThreadLocal</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd3 aria-label=解决措施3>解决措施3</a></li></ul></li></ul></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=源码分析>源码分析</a><ul><li><a href=#thread-theadlocal-threadlocalmap%e5%85%b3%e7%b3%bb aria-label="Thread 	TheadLocal 	ThreadLocalMap关系">Thread TheadLocal ThreadLocalMap关系</a></li></ul></li><li><a href=#%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98 aria-label=内存泄露问题>内存泄露问题</a><ul><li><a href=#%e5%bc%ba%e5%bc%95%e7%94%a8 aria-label=强引用>强引用</a></li><li><a href=#%e8%bd%af%e5%bc%95%e7%94%a8 aria-label=软引用>软引用</a></li><li><a href=#%e5%bc%b1%e5%bc%95%e7%94%a8 aria-label=弱引用>弱引用</a></li><li><a href=#%e8%99%9a%e5%bc%95%e7%94%a8 aria-label=虚引用>虚引用</a></li><li><a href=#threadlocal%e5%a6%82%e4%bd%95%e9%81%bf%e5%85%8d%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2 aria-label=ThreadLocal如何避免内存泄露>ThreadLocal如何避免内存泄露</a><ul><li><a href=#threadlocalmapentry%e4%bd%bf%e7%94%a8%e5%bc%b1%e5%bc%95%e7%94%a8 aria-label=ThreadLocalMap#Entry使用弱引用>ThreadLocalMap#Entry使用弱引用</a></li><li><a href=#entry%e7%9a%84key%e5%bc%95%e7%94%a8%e6%8c%87%e5%90%91%e4%b8%banull-value%e4%b8%ba%e5%a4%a7%e5%af%b9%e8%b1%a1 aria-label="Entry的key引用指向为null, Value为大对象">Entry的key引用指向为null, Value为大对象</a></li></ul></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=定义>定义<a hidden class=anchor aria-hidden=true href=#定义>#</a></h1><p>ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。</p><ul><li>每个ThreadLocl都是自己专属的本地变量副本,不存在多线程间共享的问题</li><li>每个线程对该值都是各自线程互相独立访问的</li></ul><h2 id=初始化>初始化<a hidden class=anchor aria-hidden=true href=#初始化>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>tl1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>tl2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>.</span><span class=na>withInitial</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>? 为什么要加remove方法</p><p>防止内存泄露</p><h1 id=实践>实践<a hidden class=anchor aria-hidden=true href=#实践>#</a></h1><h2 id=不安全的simpledateformat>不安全的SimpleDateFormat<a hidden class=anchor aria-hidden=true href=#不安全的simpledateformat>#</a></h2><h3 id=问题演示>问题演示<a hidden class=anchor aria-hidden=true href=#问题演示>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SimpleDateFormatDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=nf>parseSdf</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dataStr</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>dataStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>parseSdf</span><span class=p>(</span><span class=s>&#34;2023-07-20 11:08:10&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>},</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>i</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=原因分析>原因分析<a hidden class=anchor aria-hidden=true href=#原因分析>#</a></h3><p>SimpleDateFormat类内部有一个Calendar对象引用,它用来储存和这个SimpleDateFormat相关的日期信息,例如sdf.parse(dateStr),sdf.format(date) 诸如此类的方法参数传入的日期相关String,Date等等, 都是交由Calendar引用来储存的.这样就会导致一个问题如果你的SimpleDateFormat是个static的, 那么多个thread 之间就会共享这个SimpleDateFormat, 同时也是共享这个Calendar引用。</p><h3 id=解决措施1---局部变量>解决措施1 - 局部变量<a hidden class=anchor aria-hidden=true href=#解决措施1---局部变量>#</a></h3><p>将将<code>SimpleDateFormat</code>定义成局部变量。</p><p>缺点:：<strong>每调用一次方法就会创建一个SimpleDateFormat对象，方法结束又要作为垃圾回收。</strong></p><h3 id=解决措施2---threadlocal>解决措施2 - ThreadLocal<a hidden class=anchor aria-hidden=true href=#解决措施2---threadlocal>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SimpleDateFormatDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span><span class=w> </span><span class=n>tlsdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>.</span><span class=na>withInitial</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-mm HH:mm:ss&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=nf>parseSdf</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dataStr</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tlsdf</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>parse</span><span class=p>(</span><span class=n>dataStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>remove</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tlsdf</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>parseSdf</span><span class=p>(</span><span class=s>&#34;2023-07-20 11:08:10&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>},</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>i</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=解决措施3>解决措施3<a hidden class=anchor aria-hidden=true href=#解决措施3>#</a></h3><ul><li>加锁</li><li>第三发时间库</li><li>如果是JDK8应用，用<code>Instant</code> 代替Date, <code>LocalDateTime</code> 代替<code>Calendar</code> <code>DateTimeFormatter</code>代替<code>SimpleDateFormat</code></li></ul><h1 id=源码分析>源码分析<a hidden class=anchor aria-hidden=true href=#源码分析>#</a></h1><h2 id=thread-theadlocal-threadlocalmap关系>Thread TheadLocal ThreadLocalMap关系<a hidden class=anchor aria-hidden=true href=#thread-theadlocal-threadlocalmap关系>#</a></h2><p>Thread内部有一个ThreadLocal:各自线程都有</p><p>TheadLocal内部有<code>ThreadLocalMap</code>，ThreadLocalMap 含有entry 键值对,键类型：ThreadLocal</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// set方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// 获取当前线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// 获取ThreadLocalMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>createMap</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>createMap</span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>firstValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>threadLocals</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocalMap</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>firstValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadLocalMap</span><span class=p>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>firstKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>firstValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>[</span><span class=n>INITIAL_CAPACITY</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstKey</span><span class=p>.</span><span class=na>threadLocalHashCode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>INITIAL_CAPACITY</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=p>(</span><span class=n>firstKey</span><span class=p>,</span><span class=w> </span><span class=n>firstValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setThreshold</span><span class=p>(</span><span class=n>INITIAL_CAPACITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// get方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ThreadLocalMap</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>getEntry</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>setInitialValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=内存泄露问题>内存泄露问题<a hidden class=anchor aria-hidden=true href=#内存泄露问题>#</a></h1><p>内存泄露：<strong>不再会被使用的对象或者变量占用的内存不能给回收</strong></p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A6224E26-D453-4AF3-B553-30AAB8AE253D.png alt=img></p><h2 id=强引用>强引用<a hidden class=anchor aria-hidden=true href=#强引用>#</a></h2><p><strong>当内存不足，JVM开始垃圾回收，对于强引用的对象，就算是出现了OOM也不会对该对象进行回收，默认支持模式</strong></p><p>强引用是我们最常见的普通对象引用，只要还有强引用指向一个对象，就能表明对象还“活着”，垃圾收集器不会碰这种对象。在 Java 中最常见的就是强引用，把一个对象赋给一个引用变量，这个引用变量就是一个强引用。当一个对象被强引用变量引用时，它处于可达状态，它是不可能被垃圾回收机制回收的，即使该对象以后永远都不会被用到JVM也不会回收。因此强引用是造成Java内存泄漏的主要原因之一。</p><p>对于一个普通的对象，如果没有其他的引用关系，只要超过了引用的作用域或者显式地将相应（强）引用赋值为 null，一般认为就是可以被垃圾收集的了(当然具体回收时机还是要看垃圾收集策略)。</p><h2 id=软引用>软引用<a hidden class=anchor aria-hidden=true href=#软引用>#</a></h2><p>软引用相对强引用弱化了一些引用，需要引用<strong>java.lang.ref.SoftReference</strong>类来实现，可以让对象豁免一些垃圾收集。<strong>系统内存充足不会回收，系统内存不足会被回收</strong></p><p><strong>软引用通常用在对内存敏感的程序中，比如高速缓存就有用到软引用，内存够用的时候就保留，不够用就回收！</strong></p><h2 id=弱引用>弱引用<a hidden class=anchor aria-hidden=true href=#弱引用>#</a></h2><p>弱引用需要用<strong>java.lang.ref.WeakReference</strong>类来实现，它比软引用的生存期更短。只要垃圾回收机制一旦运行，不管JVM的内存空间是否充足，都会回收该对象占用的内存</p><p><strong>软引用和弱引用的适用场景</strong></p><blockquote><p>假如有一个应用需要读取大量的本地图片:</p><ul><li>如果每次读取图片都从硬盘读取则会严重影响性能,</li><li>如果一次性全部加载到内存中又可能造成内存溢出。</li></ul><p>此时使用软引用可以解决这个问题。</p><p>设计思路是：用一个HashMap来保存图片的路径和相应图片对象关联的软引用之间的映射关系，在内存不足时，JVM会自动回收这些缓存图片对象所占用的空间，从而有效地避免了OOM的问题。</p><p>Map&lt;String. SoftReference> imageCache = new HashMap&lt;String, SoftReference>();</p></blockquote><h2 id=虚引用>虚引用<a hidden class=anchor aria-hidden=true href=#虚引用>#</a></h2><p><strong>虚引用需要<code>java.lang.ref.PhantomReference</code>类来实现，需要配合引用队列联合使用</strong></p><p>如果一个对象持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收器回收</p><p>虚引用的主要作用是<strong>跟踪对象被垃圾回收的状态</strong>。 仅仅是提供了一种确保对象被 finalize以后，做某些事情的机制。 PhantomReference的get方法总是返回null，因此无法访问对应的引用对象。意义在于，说明一个对象已经进入finalization阶段，可以被gc回收，用来实现比finalization机制更灵活的回收操作。</p><p><strong>换句话说，设置虚引用关联的唯一目的，就是在这个对象被收集器回收的时候收到一个系统通知或者后续添加进一步的处理。</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.PhantomReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.Reference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.ReferenceQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.WeakReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023年07月20日 16:07:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WeakReferenceDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// -Xms9m -Xmx9m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>referenceQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReferenceQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PhantomReference</span><span class=o>&lt;</span><span class=n>MyObj</span><span class=o>&gt;</span><span class=w> </span><span class=n>objWeakReference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhantomReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MyObj</span><span class=p>(),</span><span class=w> </span><span class=n>referenceQueue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=kt>byte</span><span class=o>[]&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MICROSECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>objWeakReference</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Reference</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>reference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referenceQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reference</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;虚对象死亡，进入队列中&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MyObj</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>finalize</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;my finalized&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=threadlocal如何避免内存泄露>ThreadLocal如何避免内存泄露<a hidden class=anchor aria-hidden=true href=#threadlocal如何避免内存泄露>#</a></h2><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A2FF20B8-6573-4C8C-A319-FDEF49C4304C.png alt=img>
****</p><h3 id=threadlocalmapentry使用弱引用>ThreadLocalMap#Entry使用弱引用<a hidden class=anchor aria-hidden=true href=#threadlocalmapentry使用弱引用>#</a></h3><p>调用某一个方法会在栈帧利用存在对象引用，如果是key是强引用就会导致key指向的<strong>ThreadLocal对象及v指向的对象不能被gc回收，造成内存泄漏</strong>；使用弱引用，就可以使ThreadLocal对象在方法执行完毕后顺利被回收且<strong>Entry的key引用指向为null</strong>。</p><h3 id=entry的key引用指向为null-value为大对象>Entry的key引用指向为null, Value为大对象<a hidden class=anchor aria-hidden=true href=#entry的key引用指向为null-value为大对象>#</a></h3><p>ThreadLocalMap使用ThreadLocal的弱引用作为key，如果一个ThreadLocal没有外部强引用他，那么系统gc的时候，这个ThreadLocal势必会被回收，这样一来，<strong>ThreadLocalMap中就会出现key为null的Entry，就没有办法访问这些key为null的Entry的value，如果当前线程再迟迟不结束的话(比如正好用在线程池)，这些key为null的Entry的value就会一直存在一条强引用链。</strong></p><p>虽然弱引用，保<strong>证了key指向的ThreadLocal对象能被及时回收</strong>，<strong>但是v指向的value对象是需要ThreadLocalMap调用get、set时发现key为null时才会去回收整个entry、value</strong>，因此弱引用不能100%保证内存不泄露。我们要在不使用某个ThreadLocal对象后，手动调用remoev方法来删除它，尤其是在线程池中，不仅仅是内存泄露的问题，因为线程池中的线程是重复使用的，意味着这个线程的ThreadLocalMap对象也是重复使用的，如果我们不手动调用remove方法，那么后面的线程就有可能获取到上个线程遗留下来的value值，造成bug。</p><p><code>set</code>,<code>getEntry</code>,<code>remove</code>方法看出，在threadLocal的生命周期里，针对threadLocal存在的内存泄漏的问题，</p><p>都会通过<code>expungeStaleEntry</code>，<code>cleanSomeSlots</code>,<code>replaceStaleEntry</code>这三个方法清理掉key为null的脏entry。</p><p><strong>用完在finally中手动清除</strong></p><h1 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><ul><li>ThreadLocal并不适用线程间共享数据问题</li><li>ThreadLocal适用于线程隔离且方法间共享的问题</li><li>ThreadLocal通过在不同线程内创建独立副本避免了线程安全问题</li><li>每个线程持有一个只属于自己的专属Map并维护了ThreadLocal对象与具体实例的映射，该Map由于只被持有它的线程访问，故不存在线程安全以及锁的问题</li><li>ThreadLocalMap的Entry对ThreadLocal的引用为弱引用，避免了ThreadLocal对象无法被回收的问题</li><li>都会通过expungeStaleEntry，cleanSomeSlots,replaceStaleEntry这三个方法<strong>回收键为 null 的 Entry 对象的值（即为具体实例）以及 Entry 对象本身</strong>从而防止内存泄漏，属于安全加固的方法</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://AlfredNing.github.io/note/program/juc/05-%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B8%8E%E5%AF%B9%E8%B1%A1%E5%A4%B4/><span class=title>« 上一页</span><br><span>05 对象内存布局</span>
</a><a class=next href=https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/><span class=title>下一页 »</span><br><span>03-Cas-原子操作</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=AlfredNing/AlfredNing.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://AlfredNing.github.io/>AlfredNing</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>