<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>04 ThreadLocal | AlfredNing</title>
<meta name=keywords content><meta name=description content='å®šä¹‰ ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚
æ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„ åˆå§‹åŒ– ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•
é˜²æ­¢å†…å­˜æ³„éœ²
å®è·µ ä¸å®‰å…¨çš„SimpleDateFormat é—®é¢˜æ¼”ç¤º class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><meta name=author content="AlfredNing"><link rel=canonical href=https://AlfredNing.github.io/note/program/juc/04-threadlocal/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.992dd02838d36453c6b1ff2a12a60049a3e447cd982ad5f7b4470d32eb4648e2.css integrity="sha256-mS3QKDjTZFPGsf8qEqYASaPkR82YKtX3tEcNMutGSOI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://AlfredNing.github.io/note/program/juc/04-threadlocal/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="04 ThreadLocal"><meta property="og:description" content='å®šä¹‰ ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚
æ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„ åˆå§‹åŒ– ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•
é˜²æ­¢å†…å­˜æ³„éœ²
å®è·µ ä¸å®‰å…¨çš„SimpleDateFormat é—®é¢˜æ¼”ç¤º class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><meta property="og:type" content="article"><meta property="og:url" content="https://AlfredNing.github.io/note/program/juc/04-threadlocal/"><meta property="article:section" content="note"><meta property="article:published_time" content="2023-07-19T16:22:32+08:00"><meta property="article:modified_time" content="2023-07-20T16:40:10+08:00"><meta property="og:site_name" content="Alfred.Ning"><meta name=twitter:card content="summary"><meta name=twitter:title content="04 ThreadLocal"><meta name=twitter:description content='å®šä¹‰ ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚
æ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„ åˆå§‹åŒ– ThreadLocal<Integer> tl1 = new ThreadLocal<Integer>() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal<Integer> tl2 = ThreadLocal.withInitial(() -> 2); ? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•
é˜²æ­¢å†…å­˜æ³„éœ²
å®è·µ ä¸å®‰å…¨çš„SimpleDateFormat é—®é¢˜æ¼”ç¤º class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i < 5; i++) { new Thread(() -> { try { System.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ç¬”è®°","item":"https://AlfredNing.github.io/note/"},{"@type":"ListItem","position":2,"name":"ç¼–ç¨‹","item":"https://AlfredNing.github.io/note/program/"},{"@type":"ListItem","position":3,"name":"juc","item":"https://AlfredNing.github.io/note/program/juc/"},{"@type":"ListItem","position":4,"name":"04 ThreadLocal","item":"https://AlfredNing.github.io/note/program/juc/04-threadlocal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"04 ThreadLocal","name":"04 ThreadLocal","description":"å®šä¹‰ ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚\næ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„ åˆå§‹åŒ– ThreadLocal\u0026lt;Integer\u0026gt; tl1 = new ThreadLocal\u0026lt;Integer\u0026gt;() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal\u0026lt;Integer\u0026gt; tl2 = ThreadLocal.withInitial(() -\u0026gt; 2); ? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•\né˜²æ­¢å†…å­˜æ³„éœ²\nå®è·µ ä¸å®‰å…¨çš„SimpleDateFormat é—®é¢˜æ¼”ç¤º class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u0026lt; 5; i++) { new Thread(() -\u0026gt; { try { System.","keywords":[""],"articleBody":"å®šä¹‰ ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚\næ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„ åˆå§‹åŒ– ThreadLocal\u003cInteger\u003e tl1 = new ThreadLocal\u003cInteger\u003e() { @Override protected Integer initialValue() { return 2; } }; ThreadLocal\u003cInteger\u003e tl2 = ThreadLocal.withInitial(() -\u003e 2); ? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•\né˜²æ­¢å†…å­˜æ³„éœ²\nå®è·µ ä¸å®‰å…¨çš„SimpleDateFormat é—®é¢˜æ¼”ç¤º class SimpleDateFormatDemo { public static final SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); public static Date parseSdf(String dataStr) throws ParseException { return sdf.parse(dataStr); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u003c 5; i++) { new Thread(() -\u003e { try { System.out.println(parseSdf(\"2023-07-20 11:08:10\")); } catch (ParseException e) { e.printStackTrace(); } }, String.valueOf(i)).start(); } } } åŸå› åˆ†æ SimpleDateFormatç±»å†…éƒ¨æœ‰ä¸€ä¸ªCalendarå¯¹è±¡å¼•ç”¨,å®ƒç”¨æ¥å‚¨å­˜å’Œè¿™ä¸ªSimpleDateFormatç›¸å…³çš„æ—¥æœŸä¿¡æ¯,ä¾‹å¦‚sdf.parse(dateStr),sdf.format(date) è¯¸å¦‚æ­¤ç±»çš„æ–¹æ³•å‚æ•°ä¼ å…¥çš„æ—¥æœŸç›¸å…³String,Dateç­‰ç­‰, éƒ½æ˜¯äº¤ç”±Calendarå¼•ç”¨æ¥å‚¨å­˜çš„.è¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜å¦‚æœä½ çš„SimpleDateFormatæ˜¯ä¸ªstaticçš„, é‚£ä¹ˆå¤šä¸ªthread ä¹‹é—´å°±ä¼šå…±äº«è¿™ä¸ªSimpleDateFormat, åŒæ—¶ä¹Ÿæ˜¯å…±äº«è¿™ä¸ªCalendarå¼•ç”¨ã€‚\nè§£å†³æªæ–½1 - å±€éƒ¨å˜é‡ å°†å°†SimpleDateFormatå®šä¹‰æˆå±€éƒ¨å˜é‡ã€‚\nç¼ºç‚¹:ï¼šæ¯è°ƒç”¨ä¸€æ¬¡æ–¹æ³•å°±ä¼šåˆ›å»ºä¸€ä¸ªSimpleDateFormatå¯¹è±¡ï¼Œæ–¹æ³•ç»“æŸåˆè¦ä½œä¸ºåƒåœ¾å›æ”¶ã€‚\nè§£å†³æªæ–½2 - ThreadLocal class SimpleDateFormatDemo { public static final ThreadLocal\u003cSimpleDateFormat\u003e tlsdf = ThreadLocal.withInitial( () -\u003e new SimpleDateFormat(\"yyyy-MM-mm HH:mm:ss\")); public static Date parseSdf(String dataStr) throws ParseException { return tlsdf.get().parse(dataStr); } public static void remove() { tlsdf.remove(); } public static void main(String[] args) throws ParseException { for (int i = 0; i \u003c 5; i++) { new Thread(() -\u003e { try { System.out.println(parseSdf(\"2023-07-20 11:08:10\")); } catch (ParseException e) { e.printStackTrace(); } finally { remove(); } }, String.valueOf(i)).start(); } } } è§£å†³æªæ–½3 åŠ é” ç¬¬ä¸‰å‘æ—¶é—´åº“ å¦‚æœæ˜¯JDK8åº”ç”¨ï¼Œç”¨Instant ä»£æ›¿Date, LocalDateTime ä»£æ›¿Calendar DateTimeFormatterä»£æ›¿SimpleDateFormat æºç åˆ†æ Thread TheadLocal ThreadLocalMapå…³ç³» Threadå†…éƒ¨æœ‰ä¸€ä¸ªThreadLocal:å„è‡ªçº¿ç¨‹éƒ½æœ‰\nTheadLocalå†…éƒ¨æœ‰ThreadLocalMapï¼ŒThreadLocalMap å«æœ‰entry é”®å€¼å¯¹,é”®ç±»å‹ï¼šThreadLocal\n// setæ–¹æ³• public void set(T value) { // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è·å–ThreadLocalMap ThreadLocalMap map = getMap(t); if (map != null) { map.set(this, value); } else { createMap(t, value); } } void createMap(Thread t, T firstValue) { t.threadLocals = new ThreadLocalMap(this, firstValue); } ThreadLocalMap(ThreadLocal\u003c?\u003e firstKey, Object firstValue) { table = new Entry[INITIAL_CAPACITY]; int i = firstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); size = 1; setThreshold(INITIAL_CAPACITY); } // getæ–¹æ³• public T get() { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) { @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; } } return setInitialValue(); } å†…å­˜æ³„éœ²é—®é¢˜ å†…å­˜æ³„éœ²ï¼šä¸å†ä¼šè¢«ä½¿ç”¨çš„å¯¹è±¡æˆ–è€…å˜é‡å ç”¨çš„å†…å­˜ä¸èƒ½ç»™å›æ”¶\nå¼ºå¼•ç”¨ å½“å†…å­˜ä¸è¶³ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå°±ç®—æ˜¯å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œé»˜è®¤æ”¯æŒæ¨¡å¼\nå¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨ Java ä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ï¼Œå³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°JVMä¹Ÿä¸ä¼šå›æ”¶ã€‚å› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚\nå¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸º nullï¼Œä¸€èˆ¬è®¤ä¸ºå°±æ˜¯å¯ä»¥è¢«åƒåœ¾æ”¶é›†çš„äº†(å½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥)ã€‚\nè½¯å¼•ç”¨ è½¯å¼•ç”¨ç›¸å¯¹å¼ºå¼•ç”¨å¼±åŒ–äº†ä¸€äº›å¼•ç”¨ï¼Œéœ€è¦å¼•ç”¨java.lang.ref.SoftReferenceç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ã€‚ç³»ç»Ÿå†…å­˜å……è¶³ä¸ä¼šå›æ”¶ï¼Œç³»ç»Ÿå†…å­˜ä¸è¶³ä¼šè¢«å›æ”¶\nè½¯å¼•ç”¨é€šå¸¸ç”¨åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå†…å­˜å¤Ÿç”¨çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶ï¼\nå¼±å¼•ç”¨ å¼±å¼•ç”¨éœ€è¦ç”¨java.lang.ref.WeakReferenceç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨çš„ç”Ÿå­˜æœŸæ›´çŸ­ã€‚åªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€æ—¦è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜\nè½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„é€‚ç”¨åœºæ™¯\nå‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡:\nå¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½, å¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­åˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚ æ­¤æ—¶ä½¿ç”¨è½¯å¼•ç”¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nè®¾è®¡æ€è·¯æ˜¯ï¼šç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜ã€‚\nMap","wordCount":"487","inLanguage":"zh","datePublished":"2023-07-19T16:22:32+08:00","dateModified":"2023-07-20T16:40:10+08:00","author":[{"@type":"Person","name":"AlfredNing"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://AlfredNing.github.io/note/program/juc/04-threadlocal/"},"publisher":{"@type":"Organization","name":"AlfredNing","logo":{"@type":"ImageObject","url":"https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://AlfredNing.github.io/ accesskey=h title="AlfredNing (Alt + H)">AlfredNing</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://AlfredNing.github.io/note/ title=ğŸ““ç¬”è®°><span>ğŸ““ç¬”è®°</span></a></li><li><a href=https://AlfredNing.github.io/thinking/ title=ğŸ¤”é»‘æ´><span>ğŸ¤”é»‘æ´</span></a></li><li><a href=https://AlfredNing.github.io/search/ title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://AlfredNing.github.io/tags/ title=ğŸ·ï¸æ ‡ç­¾><span>ğŸ·ï¸æ ‡ç­¾</span></a></li><li><a href=https://AlfredNing.github.io/archives title=ğŸ—„ï¸å½’æ¡£><span>ğŸ—„ï¸å½’æ¡£</span></a></li><li><a href=https://AlfredNing.github.io/about title=ğŸ¤™å…³äº><span>ğŸ¤™å…³äº</span></a></li></ul></nav></header><main class="main page"><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://AlfredNing.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/>ç¬”è®°</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/program/>ç¼–ç¨‹</a>&nbsp;Â»&nbsp;<a href=https://AlfredNing.github.io/note/program/juc/>juc</a></div><h1 class=post-title>04 ThreadLocal</h1><div class=post-meta>åˆ›å»º:&amp;nbsp;&lt;span title='2023-07-19 16:22:32 +0800 +0800'>2023å¹´-07æœˆ-19æ—¥&lt;/span>&amp;nbsp;|&amp;nbsp;æ›´æ–°:&amp;nbsp;2023å¹´-07æœˆ-20æ—¥&amp;nbsp;|&amp;nbsp;å­—æ•°:&amp;nbsp;487å­—&amp;nbsp;|&amp;nbsp;æ—¶é•¿:&amp;nbsp;3åˆ†é’Ÿ&amp;nbsp;|&amp;nbsp;AlfredNing
&nbsp;|&nbsp;æ ‡ç­¾: &nbsp;<ul class=post-tags-meta><a href=https://AlfredNing.github.io/tags/juc/>Juc</a></ul></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%ae%9a%e4%b9%89 aria-label=å®šä¹‰>å®šä¹‰</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=åˆå§‹åŒ–>åˆå§‹åŒ–</a></li></ul></li><li><a href=#%e5%ae%9e%e8%b7%b5 aria-label=å®è·µ>å®è·µ</a><ul><li><a href=#%e4%b8%8d%e5%ae%89%e5%85%a8%e7%9a%84simpledateformat aria-label=ä¸å®‰å…¨çš„SimpleDateFormat>ä¸å®‰å…¨çš„SimpleDateFormat</a><ul><li><a href=#%e9%97%ae%e9%a2%98%e6%bc%94%e7%a4%ba aria-label=é—®é¢˜æ¼”ç¤º>é—®é¢˜æ¼”ç¤º</a></li><li><a href=#%e5%8e%9f%e5%9b%a0%e5%88%86%e6%9e%90 aria-label=åŸå› åˆ†æ>åŸå› åˆ†æ</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd1---%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f aria-label="è§£å†³æªæ–½1 - å±€éƒ¨å˜é‡">è§£å†³æªæ–½1 - å±€éƒ¨å˜é‡</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd2---threadlocal aria-label="è§£å†³æªæ–½2 - ThreadLocal">è§£å†³æªæ–½2 - ThreadLocal</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%8e%aa%e6%96%bd3 aria-label=è§£å†³æªæ–½3>è§£å†³æªæ–½3</a></li></ul></li></ul></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=æºç åˆ†æ>æºç åˆ†æ</a><ul><li><a href=#thread-theadlocal-threadlocalmap%e5%85%b3%e7%b3%bb aria-label="Thread 	TheadLocal 	ThreadLocalMapå…³ç³»">Thread TheadLocal ThreadLocalMapå…³ç³»</a></li></ul></li><li><a href=#%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98 aria-label=å†…å­˜æ³„éœ²é—®é¢˜>å†…å­˜æ³„éœ²é—®é¢˜</a><ul><li><a href=#%e5%bc%ba%e5%bc%95%e7%94%a8 aria-label=å¼ºå¼•ç”¨>å¼ºå¼•ç”¨</a></li><li><a href=#%e8%bd%af%e5%bc%95%e7%94%a8 aria-label=è½¯å¼•ç”¨>è½¯å¼•ç”¨</a></li><li><a href=#%e5%bc%b1%e5%bc%95%e7%94%a8 aria-label=å¼±å¼•ç”¨>å¼±å¼•ç”¨</a></li><li><a href=#%e8%99%9a%e5%bc%95%e7%94%a8 aria-label=è™šå¼•ç”¨>è™šå¼•ç”¨</a></li><li><a href=#threadlocal%e5%a6%82%e4%bd%95%e9%81%bf%e5%85%8d%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2 aria-label=ThreadLocalå¦‚ä½•é¿å…å†…å­˜æ³„éœ²>ThreadLocalå¦‚ä½•é¿å…å†…å­˜æ³„éœ²</a><ul><li><a href=#threadlocalmapentry%e4%bd%bf%e7%94%a8%e5%bc%b1%e5%bc%95%e7%94%a8 aria-label=ThreadLocalMap#Entryä½¿ç”¨å¼±å¼•ç”¨>ThreadLocalMap#Entryä½¿ç”¨å¼±å¼•ç”¨</a></li><li><a href=#entry%e7%9a%84key%e5%bc%95%e7%94%a8%e6%8c%87%e5%90%91%e4%b8%banull-value%e4%b8%ba%e5%a4%a7%e5%af%b9%e8%b1%a1 aria-label="Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull, Valueä¸ºå¤§å¯¹è±¡">Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull, Valueä¸ºå¤§å¯¹è±¡</a></li></ul></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=å®šä¹‰>å®šä¹‰<a hidden class=anchor aria-hidden=true href=#å®šä¹‰>#</a></h1><p>ThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚</p><ul><li>æ¯ä¸ªThreadLocléƒ½æ˜¯è‡ªå·±ä¸“å±çš„æœ¬åœ°å˜é‡å‰¯æœ¬,ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜</li><li>æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å€¼éƒ½æ˜¯å„è‡ªçº¿ç¨‹äº’ç›¸ç‹¬ç«‹è®¿é—®çš„</li></ul><h2 id=åˆå§‹åŒ–>åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#åˆå§‹åŒ–>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>tl1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>tl2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>.</span><span class=na>withInitial</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>? ä¸ºä»€ä¹ˆè¦åŠ removeæ–¹æ³•</p><p>é˜²æ­¢å†…å­˜æ³„éœ²</p><h1 id=å®è·µ>å®è·µ<a hidden class=anchor aria-hidden=true href=#å®è·µ>#</a></h1><h2 id=ä¸å®‰å…¨çš„simpledateformat>ä¸å®‰å…¨çš„SimpleDateFormat<a hidden class=anchor aria-hidden=true href=#ä¸å®‰å…¨çš„simpledateformat>#</a></h2><h3 id=é—®é¢˜æ¼”ç¤º>é—®é¢˜æ¼”ç¤º<a hidden class=anchor aria-hidden=true href=#é—®é¢˜æ¼”ç¤º>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SimpleDateFormatDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>sdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=nf>parseSdf</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dataStr</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sdf</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>dataStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>parseSdf</span><span class=p>(</span><span class=s>&#34;2023-07-20 11:08:10&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>},</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>i</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=åŸå› åˆ†æ>åŸå› åˆ†æ<a hidden class=anchor aria-hidden=true href=#åŸå› åˆ†æ>#</a></h3><p>SimpleDateFormatç±»å†…éƒ¨æœ‰ä¸€ä¸ªCalendarå¯¹è±¡å¼•ç”¨,å®ƒç”¨æ¥å‚¨å­˜å’Œè¿™ä¸ªSimpleDateFormatç›¸å…³çš„æ—¥æœŸä¿¡æ¯,ä¾‹å¦‚sdf.parse(dateStr),sdf.format(date) è¯¸å¦‚æ­¤ç±»çš„æ–¹æ³•å‚æ•°ä¼ å…¥çš„æ—¥æœŸç›¸å…³String,Dateç­‰ç­‰, éƒ½æ˜¯äº¤ç”±Calendarå¼•ç”¨æ¥å‚¨å­˜çš„.è¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜å¦‚æœä½ çš„SimpleDateFormatæ˜¯ä¸ªstaticçš„, é‚£ä¹ˆå¤šä¸ªthread ä¹‹é—´å°±ä¼šå…±äº«è¿™ä¸ªSimpleDateFormat, åŒæ—¶ä¹Ÿæ˜¯å…±äº«è¿™ä¸ªCalendarå¼•ç”¨ã€‚</p><h3 id=è§£å†³æªæ–½1---å±€éƒ¨å˜é‡>è§£å†³æªæ–½1 - å±€éƒ¨å˜é‡<a hidden class=anchor aria-hidden=true href=#è§£å†³æªæ–½1---å±€éƒ¨å˜é‡>#</a></h3><p>å°†å°†<code>SimpleDateFormat</code>å®šä¹‰æˆå±€éƒ¨å˜é‡ã€‚</p><p>ç¼ºç‚¹:ï¼š<strong>æ¯è°ƒç”¨ä¸€æ¬¡æ–¹æ³•å°±ä¼šåˆ›å»ºä¸€ä¸ªSimpleDateFormatå¯¹è±¡ï¼Œæ–¹æ³•ç»“æŸåˆè¦ä½œä¸ºåƒåœ¾å›æ”¶ã€‚</strong></p><h3 id=è§£å†³æªæ–½2---threadlocal>è§£å†³æªæ–½2 - ThreadLocal<a hidden class=anchor aria-hidden=true href=#è§£å†³æªæ–½2---threadlocal>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SimpleDateFormatDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span><span class=w> </span><span class=n>tlsdf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadLocal</span><span class=p>.</span><span class=na>withInitial</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;yyyy-MM-mm HH:mm:ss&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=nf>parseSdf</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>dataStr</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>tlsdf</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>parse</span><span class=p>(</span><span class=n>dataStr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>remove</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tlsdf</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ParseException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>5</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>parseSdf</span><span class=p>(</span><span class=s>&#34;2023-07-20 11:08:10&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ParseException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>},</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>i</span><span class=p>)).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=è§£å†³æªæ–½3>è§£å†³æªæ–½3<a hidden class=anchor aria-hidden=true href=#è§£å†³æªæ–½3>#</a></h3><ul><li>åŠ é”</li><li>ç¬¬ä¸‰å‘æ—¶é—´åº“</li><li>å¦‚æœæ˜¯JDK8åº”ç”¨ï¼Œç”¨<code>Instant</code> ä»£æ›¿Date, <code>LocalDateTime</code> ä»£æ›¿<code>Calendar</code> <code>DateTimeFormatter</code>ä»£æ›¿<code>SimpleDateFormat</code></li></ul><h1 id=æºç åˆ†æ>æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#æºç åˆ†æ>#</a></h1><h2 id=thread-theadlocal-threadlocalmapå…³ç³»>Thread TheadLocal ThreadLocalMapå…³ç³»<a hidden class=anchor aria-hidden=true href=#thread-theadlocal-threadlocalmapå…³ç³»>#</a></h2><p>Threadå†…éƒ¨æœ‰ä¸€ä¸ªThreadLocal:å„è‡ªçº¿ç¨‹éƒ½æœ‰</p><p>TheadLocalå†…éƒ¨æœ‰<code>ThreadLocalMap</code>ï¼ŒThreadLocalMap å«æœ‰entry é”®å€¼å¯¹,é”®ç±»å‹ï¼šThreadLocal</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// setæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// è·å–å½“å‰çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// è·å–ThreadLocalMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>createMap</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>createMap</span><span class=p>(</span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>firstValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>threadLocals</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocalMap</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>firstValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadLocalMap</span><span class=p>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>firstKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>firstValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>[</span><span class=n>INITIAL_CAPACITY</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstKey</span><span class=p>.</span><span class=na>threadLocalHashCode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>INITIAL_CAPACITY</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>table</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=p>(</span><span class=n>firstKey</span><span class=p>,</span><span class=w> </span><span class=n>firstValue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setThreshold</span><span class=p>(</span><span class=n>INITIAL_CAPACITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// getæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ThreadLocalMap</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>getEntry</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>setInitialValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=å†…å­˜æ³„éœ²é—®é¢˜>å†…å­˜æ³„éœ²é—®é¢˜<a hidden class=anchor aria-hidden=true href=#å†…å­˜æ³„éœ²é—®é¢˜>#</a></h1><p>å†…å­˜æ³„éœ²ï¼š<strong>ä¸å†ä¼šè¢«ä½¿ç”¨çš„å¯¹è±¡æˆ–è€…å˜é‡å ç”¨çš„å†…å­˜ä¸èƒ½ç»™å›æ”¶</strong></p><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A6224E26-D453-4AF3-B553-30AAB8AE253D.png alt=img></p><h2 id=å¼ºå¼•ç”¨>å¼ºå¼•ç”¨<a hidden class=anchor aria-hidden=true href=#å¼ºå¼•ç”¨>#</a></h2><p><strong>å½“å†…å­˜ä¸è¶³ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œå°±ç®—æ˜¯å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œé»˜è®¤æ”¯æŒæ¨¡å¼</strong></p><p>å¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨ Java ä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ï¼Œå³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°JVMä¹Ÿä¸ä¼šå›æ”¶ã€‚å› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p><p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸º nullï¼Œä¸€èˆ¬è®¤ä¸ºå°±æ˜¯å¯ä»¥è¢«åƒåœ¾æ”¶é›†çš„äº†(å½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥)ã€‚</p><h2 id=è½¯å¼•ç”¨>è½¯å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#è½¯å¼•ç”¨>#</a></h2><p>è½¯å¼•ç”¨ç›¸å¯¹å¼ºå¼•ç”¨å¼±åŒ–äº†ä¸€äº›å¼•ç”¨ï¼Œéœ€è¦å¼•ç”¨<strong>java.lang.ref.SoftReference</strong>ç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ã€‚<strong>ç³»ç»Ÿå†…å­˜å……è¶³ä¸ä¼šå›æ”¶ï¼Œç³»ç»Ÿå†…å­˜ä¸è¶³ä¼šè¢«å›æ”¶</strong></p><p><strong>è½¯å¼•ç”¨é€šå¸¸ç”¨åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå†…å­˜å¤Ÿç”¨çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶ï¼</strong></p><h2 id=å¼±å¼•ç”¨>å¼±å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#å¼±å¼•ç”¨>#</a></h2><p>å¼±å¼•ç”¨éœ€è¦ç”¨<strong>java.lang.ref.WeakReference</strong>ç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨çš„ç”Ÿå­˜æœŸæ›´çŸ­ã€‚åªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€æ—¦è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜</p><p><strong>è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„é€‚ç”¨åœºæ™¯</strong></p><blockquote><p>å‡å¦‚æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡:</p><ul><li>å¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½,</li><li>å¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­åˆå¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚</li></ul><p>æ­¤æ—¶ä½¿ç”¨è½¯å¼•ç”¨å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>è®¾è®¡æ€è·¯æ˜¯ï¼šç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜ã€‚</p><p>Map&lt;String. SoftReference> imageCache = new HashMap&lt;String, SoftReference>();</p></blockquote><h2 id=è™šå¼•ç”¨>è™šå¼•ç”¨<a hidden class=anchor aria-hidden=true href=#è™šå¼•ç”¨>#</a></h2><p><strong>è™šå¼•ç”¨éœ€è¦<code>java.lang.ref.PhantomReference</code>ç±»æ¥å®ç°ï¼Œéœ€è¦é…åˆå¼•ç”¨é˜Ÿåˆ—è”åˆä½¿ç”¨</strong></p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶</p><p>è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨æ˜¯<strong>è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€</strong>ã€‚ ä»…ä»…æ˜¯æä¾›äº†ä¸€ç§ç¡®ä¿å¯¹è±¡è¢« finalizeä»¥åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚ PhantomReferenceçš„getæ–¹æ³•æ€»æ˜¯è¿”å›nullï¼Œå› æ­¤æ— æ³•è®¿é—®å¯¹åº”çš„å¼•ç”¨å¯¹è±¡ã€‚æ„ä¹‰åœ¨äºï¼Œè¯´æ˜ä¸€ä¸ªå¯¹è±¡å·²ç»è¿›å…¥finalizationé˜¶æ®µï¼Œå¯ä»¥è¢«gcå›æ”¶ï¼Œç”¨æ¥å®ç°æ¯”finalizationæœºåˆ¶æ›´çµæ´»çš„å›æ”¶æ“ä½œã€‚</p><p><strong>æ¢å¥è¯è¯´ï¼Œè®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥æˆ–è€…åç»­æ·»åŠ è¿›ä¸€æ­¥çš„å¤„ç†ã€‚</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.PhantomReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.Reference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.ReferenceQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.ref.WeakReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author Alfred.Ning
</span></span></span><span class=line><span class=cl><span class=cm> * @since 2023å¹´07æœˆ20æ—¥ 16:07:00
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WeakReferenceDemo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// -Xms9m -Xmx9m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>referenceQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReferenceQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PhantomReference</span><span class=o>&lt;</span><span class=n>MyObj</span><span class=o>&gt;</span><span class=w> </span><span class=n>objWeakReference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhantomReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MyObj</span><span class=p>(),</span><span class=w> </span><span class=n>referenceQueue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=kt>byte</span><span class=o>[]&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MICROSECONDS</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>objWeakReference</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Reference</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>reference</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referenceQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reference</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;è™šå¯¹è±¡æ­»äº¡ï¼Œè¿›å…¥é˜Ÿåˆ—ä¸­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>MyObj</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>finalize</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;my finalized&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=threadlocalå¦‚ä½•é¿å…å†…å­˜æ³„éœ²>ThreadLocalå¦‚ä½•é¿å…å†…å­˜æ³„éœ²<a hidden class=anchor aria-hidden=true href=#threadlocalå¦‚ä½•é¿å…å†…å­˜æ³„éœ²>#</a></h2><p><img loading=lazy src=https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/A2FF20B8-6573-4C8C-A319-FDEF49C4304C.png alt=img>
****</p><h3 id=threadlocalmapentryä½¿ç”¨å¼±å¼•ç”¨>ThreadLocalMap#Entryä½¿ç”¨å¼±å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#threadlocalmapentryä½¿ç”¨å¼±å¼•ç”¨>#</a></h3><p>è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•ä¼šåœ¨æ ˆå¸§åˆ©ç”¨å­˜åœ¨å¯¹è±¡å¼•ç”¨ï¼Œå¦‚æœæ˜¯keyæ˜¯å¼ºå¼•ç”¨å°±ä¼šå¯¼è‡´keyæŒ‡å‘çš„<strong>ThreadLocalå¯¹è±¡åŠvæŒ‡å‘çš„å¯¹è±¡ä¸èƒ½è¢«gcå›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼</strong>ï¼›ä½¿ç”¨å¼±å¼•ç”¨ï¼Œå°±å¯ä»¥ä½¿ThreadLocalå¯¹è±¡åœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åé¡ºåˆ©è¢«å›æ”¶ä¸”<strong>Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull</strong>ã€‚</p><h3 id=entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull-valueä¸ºå¤§å¯¹è±¡>Entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull, Valueä¸ºå¤§å¯¹è±¡<a hidden class=anchor aria-hidden=true href=#entryçš„keyå¼•ç”¨æŒ‡å‘ä¸ºnull-valueä¸ºå¤§å¯¹è±¡>#</a></h3><p>ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»Ÿgcçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ<strong>ThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯(æ¯”å¦‚æ­£å¥½ç”¨åœ¨çº¿ç¨‹æ± )ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ã€‚</strong></p><p>è™½ç„¶å¼±å¼•ç”¨ï¼Œä¿<strong>è¯äº†keyæŒ‡å‘çš„ThreadLocalå¯¹è±¡èƒ½è¢«åŠæ—¶å›æ”¶</strong>ï¼Œ<strong>ä½†æ˜¯væŒ‡å‘çš„valueå¯¹è±¡æ˜¯éœ€è¦ThreadLocalMapè°ƒç”¨getã€setæ—¶å‘ç°keyä¸ºnullæ—¶æ‰ä¼šå»å›æ”¶æ•´ä¸ªentryã€value</strong>ï¼Œå› æ­¤å¼±å¼•ç”¨ä¸èƒ½100%ä¿è¯å†…å­˜ä¸æ³„éœ²ã€‚æˆ‘ä»¬è¦åœ¨ä¸ä½¿ç”¨æŸä¸ªThreadLocalå¯¹è±¡åï¼Œæ‰‹åŠ¨è°ƒç”¨remoevæ–¹æ³•æ¥åˆ é™¤å®ƒï¼Œå°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± ä¸­ï¼Œä¸ä»…ä»…æ˜¯å†…å­˜æ³„éœ²çš„é—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œæ„å‘³ç€è¿™ä¸ªçº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ä¹Ÿæ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ‰‹åŠ¨è°ƒç”¨removeæ–¹æ³•ï¼Œé‚£ä¹ˆåé¢çš„çº¿ç¨‹å°±æœ‰å¯èƒ½è·å–åˆ°ä¸Šä¸ªçº¿ç¨‹é—ç•™ä¸‹æ¥çš„valueå€¼ï¼Œé€ æˆbugã€‚</p><p><code>set</code>,<code>getEntry</code>,<code>remove</code>æ–¹æ³•çœ‹å‡ºï¼Œåœ¨threadLocalçš„ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œé’ˆå¯¹threadLocalå­˜åœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œ</p><p>éƒ½ä¼šé€šè¿‡<code>expungeStaleEntry</code>ï¼Œ<code>cleanSomeSlots</code>,<code>replaceStaleEntry</code>è¿™ä¸‰ä¸ªæ–¹æ³•æ¸…ç†æ‰keyä¸ºnullçš„è„entryã€‚</p><p><strong>ç”¨å®Œåœ¨finallyä¸­æ‰‹åŠ¨æ¸…é™¤</strong></p><h1 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h1><ul><li>ThreadLocalå¹¶ä¸é€‚ç”¨çº¿ç¨‹é—´å…±äº«æ•°æ®é—®é¢˜</li><li>ThreadLocalé€‚ç”¨äºçº¿ç¨‹éš”ç¦»ä¸”æ–¹æ³•é—´å…±äº«çš„é—®é¢˜</li><li>ThreadLocalé€šè¿‡åœ¨ä¸åŒçº¿ç¨‹å†…åˆ›å»ºç‹¬ç«‹å‰¯æœ¬é¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜</li><li>æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªåªå±äºè‡ªå·±çš„ä¸“å±Mapå¹¶ç»´æŠ¤äº†ThreadLocalå¯¹è±¡ä¸å…·ä½“å®ä¾‹çš„æ˜ å°„ï¼Œè¯¥Mapç”±äºåªè¢«æŒæœ‰å®ƒçš„çº¿ç¨‹è®¿é—®ï¼Œæ•…ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨ä»¥åŠé”çš„é—®é¢˜</li><li>ThreadLocalMapçš„Entryå¯¹ThreadLocalçš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨ï¼Œé¿å…äº†ThreadLocalå¯¹è±¡æ— æ³•è¢«å›æ”¶çš„é—®é¢˜</li><li>éƒ½ä¼šé€šè¿‡expungeStaleEntryï¼ŒcleanSomeSlots,replaceStaleEntryè¿™ä¸‰ä¸ªæ–¹æ³•<strong>å›æ”¶é”®ä¸º null çš„ Entry å¯¹è±¡çš„å€¼ï¼ˆå³ä¸ºå…·ä½“å®ä¾‹ï¼‰ä»¥åŠ Entry å¯¹è±¡æœ¬èº«</strong>ä»è€Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå±äºå®‰å…¨åŠ å›ºçš„æ–¹æ³•</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://AlfredNing.github.io/note/program/juc/05-%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B8%8E%E5%AF%B9%E8%B1%A1%E5%A4%B4/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>05 å¯¹è±¡å†…å­˜å¸ƒå±€</span>
</a><a class=next href=https://AlfredNing.github.io/note/program/juc/03-cas-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>03-Cas-åŸå­æ“ä½œ</span></a></nav></footer></div><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=AlfredNing/AlfredNing.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://AlfredNing.github.io/>AlfredNing</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>