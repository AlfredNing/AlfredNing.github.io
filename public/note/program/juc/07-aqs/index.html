<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>07 AQS | AlfredNing</title>
<meta name="keywords" content="">
<meta name="description" content="å®šä¹‰ AbstractQueuedSynchronizer: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨
æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€
å’ŒAQSç›¸å…³çš„
ReentrantLock CountDownLatch ReentrantReadWriteLock Semaphore é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API
åŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…
æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚
æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ
å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚
ä½“ç³»æ¶æ„ AQS = intå˜é‡ &#43; CLHé˜Ÿåˆ—
Nodeå†…éƒ¨ç±» åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„ CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰
ReentrantLock å®ç° ReentrantLock åº•å±‚ä½¿ç”¨Syncå®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³NonfairSync å’Œå…¬å¹³FairSync éƒ½æ˜¯ç»§æ‰¿AbstractQueuedSynchronizer
å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ !hasQueuedPredecessors()
hasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š
å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›
éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰
åŠ é”è¿‡ç¨‹ static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure.">
<meta name="author" content="AlfredNing">
<link rel="canonical" href="https://AlfredNing.github.io/note/program/juc/07-aqs/">
<meta name="google-site-verification" content="XYZabc">
<meta name="yandex-verification" content="XYZabc">
<meta name="msvalidate.01" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.0afa94d2b970a706db3fee2bf670661d8e9e2df61019549dcb856ed6d409b75d.css" integrity="sha256-CvqU0rlwpwbbP&#43;4r9nBmHY6eLfYQGVSdy4Vu1tQJt10=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://AlfredNing.github.io/note/program/juc/07-aqs/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  
    
      
    
  

<meta property="og:title" content="07 AQS" />
<meta property="og:description" content="å®šä¹‰ AbstractQueuedSynchronizer: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨
æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€
å’ŒAQSç›¸å…³çš„
ReentrantLock CountDownLatch ReentrantReadWriteLock Semaphore é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API
åŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…
æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚
æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ
å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚
ä½“ç³»æ¶æ„ AQS = intå˜é‡ &#43; CLHé˜Ÿåˆ—
Nodeå†…éƒ¨ç±» åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„ CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰
ReentrantLock å®ç° ReentrantLock åº•å±‚ä½¿ç”¨Syncå®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³NonfairSync å’Œå…¬å¹³FairSync éƒ½æ˜¯ç»§æ‰¿AbstractQueuedSynchronizer
å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ !hasQueuedPredecessors()
hasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š
å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›
éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰
åŠ é”è¿‡ç¨‹ static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://AlfredNing.github.io/note/program/juc/07-aqs/" /><meta property="article:section" content="note" />
<meta property="article:published_time" content="2023-07-22T20:31:52+08:00" />
<meta property="article:modified_time" content="2023-07-24T10:43:42+08:00" /><meta property="og:site_name" content="Alfred.Ning" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="07 AQS"/>
<meta name="twitter:description" content="å®šä¹‰ AbstractQueuedSynchronizer: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨
æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€
å’ŒAQSç›¸å…³çš„
ReentrantLock CountDownLatch ReentrantReadWriteLock Semaphore é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API
åŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…
æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚
æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ
å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚
ä½“ç³»æ¶æ„ AQS = intå˜é‡ &#43; CLHé˜Ÿåˆ—
Nodeå†…éƒ¨ç±» åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„ CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰
ReentrantLock å®ç° ReentrantLock åº•å±‚ä½¿ç”¨Syncå®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³NonfairSync å’Œå…¬å¹³FairSync éƒ½æ˜¯ç»§æ‰¿AbstractQueuedSynchronizer
å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ !hasQueuedPredecessors()
hasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š
å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›
éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰
åŠ é”è¿‡ç¨‹ static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ç¬”è®°",
      "item": "https://AlfredNing.github.io/note/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ç¼–ç¨‹",
      "item": "https://AlfredNing.github.io/note/program/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "juc",
      "item": "https://AlfredNing.github.io/note/program/juc/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "07 AQS",
      "item": "https://AlfredNing.github.io/note/program/juc/07-aqs/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "07 AQS",
  "name": "07 AQS",
  "description": "å®šä¹‰ AbstractQueuedSynchronizer: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨\næ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€\nå’ŒAQSç›¸å…³çš„\nReentrantLock CountDownLatch ReentrantReadWriteLock Semaphore é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API\nåŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…\næŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚\næ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ\nå¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚\nä½“ç³»æ¶æ„ AQS = intå˜é‡ + CLHé˜Ÿåˆ—\nNodeå†…éƒ¨ç±» åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„ CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰\nReentrantLock å®ç° ReentrantLock åº•å±‚ä½¿ç”¨Syncå®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³NonfairSync å’Œå…¬å¹³FairSync éƒ½æ˜¯ç»§æ‰¿AbstractQueuedSynchronizer\nå¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ !hasQueuedPredecessors()\nhasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š\nå…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›\néå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰\nåŠ é”è¿‡ç¨‹ static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure.",
  "keywords": [
    ""
  ],
  "articleBody": "å®šä¹‰ AbstractQueuedSynchronizer: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨\næ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€\nå’ŒAQSç›¸å…³çš„\nReentrantLock CountDownLatch ReentrantReadWriteLock Semaphore é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API\nåŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…\næŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§æ’é˜Ÿç­‰å€™æœºåˆ¶ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚\næ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ\nå¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆNodeï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚\nä½“ç³»æ¶æ„ AQS = intå˜é‡ + CLHé˜Ÿåˆ—\nNodeå†…éƒ¨ç±» åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„ CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰\nReentrantLock å®ç° ReentrantLock åº•å±‚ä½¿ç”¨Syncå®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³NonfairSync å’Œå…¬å¹³FairSync éƒ½æ˜¯ç»§æ‰¿AbstractQueuedSynchronizer\nå¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ tryAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ !hasQueuedPredecessors()\nhasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š\nå…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›\néå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰\nåŠ é”è¿‡ç¨‹ static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; /** * Performs lock. Try immediate barge, backing up to normal * acquire on failure. */ final void lock() { if (compareAndSetState(0, 1)) // ç¬¬ä¸€ä¸ªçº¿ç¨‹æŠ¢å  setExclusiveOwnerThread(Thread.currentThread()); else acquire(1); // åç»­çº¿ç¨‹æŠ¢å  } public final void acquire(int arg) { if (!tryAcquire(arg) \u0026\u0026 acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } // 1.tryAcquire è®¾ç½® å°è¯•è·å–é” final boolean nonfairTryAcquire(int acquires) { final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) { if (compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } else if (current == getExclusiveOwnerThread()) { int nextc = c + acquires; if (nextc \u003c 0) // overflow throw new Error(\"Maximum lock count exceeded\"); setState(nextc); return true; } return false; // } // 2.addWaiter è®¾ç½® åˆ›å»ºnodeèŠ‚ç‚¹ è¿›å…¥ç­‰å¾…é˜Ÿåˆ— private Node addWaiter(Node mode) { Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure Node pred = tail; if (pred != null) { node.prev = pred; if (compareAndSetTail(pred, node)) { pred.next = node; return node; } } enq(node); return node; } // åŒå‘é“¾è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè™šèŠ‚ç‚¹(ä¹Ÿå«å“¨å…µèŠ‚ç‚¹)ï¼Œå…¶å®å¹¶ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯å ä½ã€‚çœŸæ­£çš„ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„èŠ‚ç‚¹ï¼Œæ˜¯ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹çš„ã€‚ private Node enq(final Node node) { for (;;) { Node t = tail; if (t == null) { // Must initialize ç¬¬ä¸€æ¬¡åˆå§‹åŒ– if (compareAndSetHead(new Node())) // å“¨å…µèŠ‚ç‚¹ å ä½ tail = head; } else { node.prev = t; if (compareAndSetTail(t, node)) { t.next = node; return t; } } } } // 3.acquireQueued è®¾ç½® final boolean acquireQueued(final Node node, int arg) { boolean failed = true; try { boolean interrupted = false; for (;;) { // å‰é©±èŠ‚ç‚¹-å“¨å…µèŠ‚ç‚¹ final Node p = node.predecessor(); if (p == head \u0026\u0026 tryAcquire(arg)) { setHead(node); p.next = null; // help GC failed = false; return interrupted; } if (shouldParkAfterFailedAcquire(p, node) \u0026\u0026 parkAndCheckInterrupt()) interrupted = true; } } finally { // å¼‚å¸¸æµç¨‹ if (failed) cancelAcquire(node); } } private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) { int ws = pred.waitStatus; if (ws == Node.SIGNAL) // ç¬¬äºŒæ¬¡è¿›å…¥ /* * This node has already set status asking a release * to signal it, so it can safely park. */ return true; if (ws \u003e 0) { /* * Predecessor was cancelled. Skip over predecessors and * indicate retry. */ do { node.prev = pred = pred.prev; } while (pred.waitStatus \u003e 0); pred.next = node; } else { /* * waitStatus must be 0 or PROPAGATE. Indicate that we * need a signal, but don't park yet. Caller will need to * retry to make sure it cannot acquire before parking. */ // ç¬¬ä¸€æ¬¡ ä¿®æ”¹å“¨å…µèŠ‚ç‚¹waitStatus = -1 compareAndSetWaitStatus(pred, ws, Node.SIGNAL); } return false; } // æŒ‚èµ·æŠ¢å çº¿ç¨‹ private final boolean parkAndCheckInterrupt() { LockSupport.park(this); // çº¿ç¨‹ç»™æŒ‚èµ· return Thread.interrupted(); } è§£é”è¿‡ç¨‹ public void unlock() { sync.release(1); } public final boolean release(int arg) { if (tryRelease(arg)) { Node h = head; if (h != null \u0026\u0026 h.waitStatus != 0) unparkSuccessor(h); return true; } return false; } protected final boolean tryRelease(int releases) { int c = getState() - releases; if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) { free = true; setExclusiveOwnerThread(null); } setState(c); return free; } ReentrantLockã€ReentrantReadWriteLockã€StampedLock é”æ¼”å˜ æ— é” -\u003e ç‹¬å é” -\u003e è¯»å†™é” -\u003e é‚®æˆ³(ç¥¨æ®)é”\næ— é”ï¼š å¤šçº¿ç¨‹ç«äº‰ï¼Œæ•°æ®æ— åº\nç‹¬å é”ï¼šè¯»å†™æ“ä½œå…¨éƒ¨äº’æ–¥ï¼Œæ•ˆç‡ä½\nè¯»å†™é”ï¼šè¯»å†™äº’æ–¥ï¼Œè¯»è¯»å…±äº«\nè¯»å†™é” ReentrantReadWriteLock\nå®šä¹‰ ä¸€ä¸ªèµ„æºèƒ½è¢«å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œæˆ–è€…è¢«ä¸€ä¸ªå†™çº¿ç¨‹è®¿é—®ã€‚ä½†æ˜¯ä¸èƒ½åŒæ—¶å­˜åœ¨è¯»å†™çº¿ç¨‹ã€‚\nç¼ºç‚¹ è¯»å†™é”ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„è¯»å†™åˆ†ç¦»ï¼Œå®ƒåªå…è®¸è¯»è¯»å…±å­˜ï¼Œè€Œè¯»å†™å’Œå†™å†™ä¾ç„¶æ˜¯äº’æ–¥çš„ï¼Œå¤§å¤šå®é™…åœºæ™¯æ˜¯â€œè¯»/è¯»â€çº¿ç¨‹é—´å¹¶ä¸å­˜åœ¨äº’æ–¥å…³ç³»ï¼Œåªæœ‰\"è¯»/å†™\"çº¿ç¨‹æˆ–\"å†™/å†™\"çº¿ç¨‹é—´çš„æ“ä½œéœ€è¦äº’æ–¥çš„ã€‚å› æ­¤å¼•å…¥ReentrantReadWriteLockã€‚\né”é¥¥é¥¿é—®é¢˜ï¼šå†™çº¿ç¨‹è·å–ä¸åˆ°é” è¯»çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾ï¼Œå†™çº¿ç¨‹ä¸å¯ä»¥è·å–åˆ°é”ï¼Œå¿…é¡»è¯»å®Œåï¼Œæ‰èƒ½æœ‰æœºä¼šå†™ é€‚ç”¨æ¡ä»¶ åªæœ‰åœ¨è¯»å¤šå†™å°‘æƒ…å¢ƒä¹‹ä¸‹ï¼Œè¯»å†™é”æ‰å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ä½“ç°ã€‚\nimport java.util.HashMap; import java.util.Map; import java.util.concurrent.TimeUnit; import java.util.concurrent.locks.Lock; import java.util.concurrent.locks.ReentrantLock; import java.util.concurrent.locks.ReentrantReadWriteLock; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ24æ—¥ 08:35:00 */ public class ReentrantReadWriteLockDemo { public static void main(String[] args) { Resource resource = new Resource(); for (int i = 1; i \u003c= 10; i++) { int finalI = i; new Thread(() -\u003e { resource.write(finalI + \"\", finalI + \"\"); }, String.valueOf(i)).start(); } for (int i = 1; i \u003c= 10; i++) { int finalI = i; new Thread(() -\u003e { resource.read(finalI + \"\"); }, String.valueOf(i)).start(); } } } class Resource { private Map\u003cString, String\u003e map = new HashMap\u003c\u003e(); private Lock lock = new ReentrantLock(); private ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock(); public void write(String key, String value) { // lock.lock(); try { rwLock.writeLock().lock(); System.out.println(Thread.currentThread().getName() + \" æ­£åœ¨å†™å…¥\"); map.put(key, value); TimeUnit.MICROSECONDS.sleep(400); System.out.println(Thread.currentThread().getName() + \" å†™å…¥å®Œæˆ\"); } catch (InterruptedException e) { e.printStackTrace(); } finally { // lock.unlock(); rwLock.writeLock().unlock(); } } public void read(String key) { // lock.lock(); try { rwLock.readLock().lock(); System.out.println(Thread.currentThread().getName() + \" æ­£åœ¨è¯»å–\"); String value = map.get(key); System.out.println(Thread.currentThread().getName() + \" æ­£åœ¨è¯»å–å®Œæˆï¼š\" + value); } finally { // lock.unlock(); rwLock.readLock().unlock(); } } } é”é™çº§ é”çš„ä¸¥è‹›ç¨‹åº¦å˜å¼ºå«åšå‡çº§ï¼Œåä¹‹å«åšé™çº§\nå°†å†™å…¥é”é™çº§ä¸ºè¯»é”ï¼Œä¸ºäº†å½“å‰çº¿ç¨‹æ„ŸçŸ¥åˆ°æ•°æ®å˜åŒ–ï¼Œç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§ï¼Œå†™åç«‹å³è¯»ã€‚\n**æ‚²è§‚é”ï¼š**å†™é”å¿…é¡»åœ¨æ‰€æœ‰è¯»é”å®Œæˆä¹‹åè¿›è¡Œæ“ä½œ\nçº¿ç¨‹è·å–è¯»é”æ˜¯ä¸èƒ½ç›´æ¥å‡çº§ä¸ºå†™å…¥é”çš„ã€‚\nåœ¨ReentrantReadWriteLockä¸­ï¼Œå½“è¯»é”è¢«ä½¿ç”¨æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å°è¯•è·å–å†™é”ï¼Œè¯¥å†™çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚æ‰€ä»¥ï¼Œéœ€è¦é‡Šæ”¾æ‰€æœ‰è¯»é”ï¼Œæ‰å¯è·å–å†™é”ã€‚\nå³ReadWriteLockè¯»çš„è¿‡ç¨‹ä¸­ä¸å…è®¸å†™ï¼Œåªæœ‰ç­‰å¾…çº¿ç¨‹éƒ½é‡Šæ”¾äº†è¯»é”ï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½è·å–å†™é”ï¼Œä¹Ÿå°±æ˜¯å†™å…¥å¿…é¡»ç­‰å¾…ã€‚\nå½“å‰çº¿ç¨‹å¯ä»¥è·å–åˆ°å†™é”åˆè·å–åˆ°è¯»é”ï¼Œä½†æ˜¯è·å–åˆ°äº†è¯»é”ä¸èƒ½ç»§ç»­è·å–å†™é”ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºè¯»å†™é”è¦ä¿æŒå†™æ“ä½œçš„å¯è§æ€§ã€‚å› ä¸ºï¼Œå¦‚æœå…è®¸è¯»é”åœ¨è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚\né”é™çº§ä»£ç æ¼”ç¤º import java.util.concurrent.locks.ReentrantReadWriteLock; import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock; import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ24æ—¥ 09:45:00 */ public class LockDownGradingDemo { public static void main(String[] args) { ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock(); ReadLock readLock = rwLock.readLock(); WriteLock writeLock = rwLock.writeLock(); writeLock.lock(); System.out.println(\"æ­£åœ¨å†™\"); readLock.lock(); System.out.println(\"æ­£åœ¨è¯»\"); writeLock.unlock(); readLock.unlock(); writeLock.lock(); System.out.println(\"æ­£åœ¨å†™\"); readLock.lock(); System.out.println(\"æ­£åœ¨è¯»\"); writeLock.unlock(); // readLock.unlock(); writeLock.lock(); System.out.println(\"æ­£åœ¨å†™1\"); } } ReentrantWriteReadLockæºç  ç¼“å­˜è®¾è®¡ï¼Œç¼“å­˜ä¸€è‡´æ€§\nå£°æ˜äº†ä¸€ä¸ªvolatileç±»å‹çš„cacheValidå˜é‡ï¼Œä¿è¯å…¶å¯è§æ€§ã€‚ é¦–å…ˆè·å–è¯»é”ï¼Œå¦‚æœcacheä¸å¯ç”¨ï¼Œåˆ™é‡Šæ”¾è¯»é”ï¼Œè·å–å†™é”ï¼Œåœ¨æ›´æ”¹æ•°æ®ä¹‹å‰ï¼Œå†æ£€æŸ¥ä¸€æ¬¡cacheValidçš„å€¼ï¼Œç„¶åä¿®æ”¹æ•°æ®ï¼Œå°†cacheValidç½®ä¸ºtrueï¼Œç„¶ååœ¨é‡Šæ”¾å†™é”å‰è·å–è¯»é”ï¼›æ­¤æ—¶ï¼Œcacheä¸­æ•°æ®å¯ç”¨ï¼Œå¤„ç†cacheä¸­æ•°æ®ï¼Œæœ€åé‡Šæ”¾è¯»é”ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„é”é™çº§çš„è¿‡ç¨‹ï¼Œç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§ã€‚ å¦‚æœè¿èƒŒé”é™çº§çš„æ­¥éª¤:\nå¦‚æœå½“å‰çš„çº¿ç¨‹Cåœ¨ä¿®æ”¹å®Œcacheä¸­çš„æ•°æ®åï¼Œæ²¡æœ‰è·å–è¯»é”è€Œæ˜¯ç›´æ¥é‡Šæ”¾äº†å†™é”ï¼Œé‚£ä¹ˆå‡è®¾æ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹Dè·å–äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆCçº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œåˆ™æ•°æ®å‡ºç°é”™è¯¯ã€‚ å¦‚æœéµå¾ªé”é™çº§çš„æ­¥éª¤\nçº¿ç¨‹Cåœ¨é‡Šæ”¾å†™é”ä¹‹å‰è·å–è¯»é”ï¼Œé‚£ä¹ˆçº¿ç¨‹Dåœ¨è·å–å†™é”æ—¶å°†è¢«é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹Cå®Œæˆæ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œé‡Šæ”¾è¯»é”ã€‚è¿™æ ·å¯ä»¥ä¿è¯è¿”å›çš„æ•°æ®æ˜¯è¿™æ¬¡æ›´æ–°çš„æ•°æ®ï¼Œè¯¥æœºåˆ¶æ˜¯ä¸“é—¨ä¸ºäº†ç¼“å­˜è®¾è®¡çš„ã€‚ é‚®æˆ³é”StampedLock å®šä¹‰ ä¹Ÿå«ç¥¨æ®é”\nStampedLockæ˜¯JDK1.8ä¸­æ–°å¢çš„ä¸€ä¸ªè¯»å†™é”ï¼Œä¹Ÿæ˜¯å¯¹JDK1.5ä¸­çš„è¯»å†™é”ReentrantReadWriteLockçš„ä¼˜åŒ–ã€‚\nReentrantReadWriteLockæ•ˆç‡é«˜çš„åŸå› åœ¨äºå®ƒçš„å¹¶å‘è¯»ï¼ŒStampedLock ä»£è¡¨äº†é”çš„çŠ¶æ€ã€‚å½“stampè¿”å›é›¶æ—¶ï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”å¤±è´¥ã€‚å¹¶ä¸”ï¼Œå½“é‡Šæ”¾é”æˆ–è€…è½¬æ¢é”çš„æ—¶å€™ï¼Œéƒ½è¦ä¼ å…¥æœ€åˆè·å–çš„stampå€¼ã€‚\nè¯»å†™é”çš„é—®é¢˜ - é”é¥¥é¥¿ ReentrantReadWriteLockå®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œä½†æ˜¯ä¸€æ—¦è¯»æ“ä½œæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæƒ³è¦è·å–å†™é”å°±å˜å¾—æ¯”è¾ƒå›°éš¾äº†ï¼Œå‡å¦‚å½“å‰1000ä¸ªçº¿ç¨‹ï¼Œ999ä¸ªè¯»ï¼Œ1ä¸ªå†™ï¼Œæœ‰å¯èƒ½999ä¸ªè¯»å–çº¿ç¨‹é•¿æ—¶é—´æŠ¢åˆ°äº†é”ï¼Œé‚£1ä¸ªå†™çº¿ç¨‹å°±æ‚²å‰§äº† å› ä¸ºå½“å‰æœ‰å¯èƒ½ä¼šä¸€ç›´å­˜åœ¨è¯»é”ï¼Œè€Œæ— æ³•è·å¾—å†™é”ï¼Œæ ¹æœ¬æ²¡æœºä¼šå†™\nè§£å†³é”é¥¥é¥¿ ä½¿ç”¨â€œå…¬å¹³â€ç­–ç•¥å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œ ä½†æ˜¯ç‰ºç‰²äº†ç³»ç»Ÿçš„ååé‡\nç‰¹ç‚¹ æ‰€æœ‰è·å–é”çš„æ–¹æ³•ï¼Œéƒ½è¿”å›ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼ŒStampä¸ºé›¶è¡¨ç¤ºè·å–å¤±è´¥ï¼Œå…¶ä½™éƒ½è¡¨ç¤ºæˆåŠŸï¼› æ‰€æœ‰é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œéƒ½éœ€è¦ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼Œè¿™ä¸ªStampå¿…é¡»æ˜¯å’ŒæˆåŠŸè·å–é”æ—¶å¾—åˆ°çš„Stampä¸€è‡´ï¼› StampedLockæ˜¯ä¸å¯é‡å…¥çš„ï¼Œå±é™©(å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†å†™é”ï¼Œå†å»è·å–å†™é”çš„è¯å°±ä¼šé€ æˆæ­»é”) è®¿é—®æ¨¡å¼ Readingï¼ˆè¯»æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„è¯»é”ç±»ä¼¼ Writingï¼ˆå†™æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„å†™é”ç±»ä¼¼ Optimistic readingï¼ˆä¹è§‚è¯»æ¨¡å¼ï¼‰ï¼šæ— é”æœºåˆ¶ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„ä¹è§‚é”ï¼Œæ”¯æŒè¯»å†™å¹¶å‘ï¼Œå¾ˆä¹è§‚è®¤ä¸ºè¯»å–æ—¶æ²¡äººä¿®æ”¹ï¼Œå‡å¦‚è¢«ä¿®æ”¹å†å®ç°å‡çº§ä¸ºæ‚²è§‚è¯»æ¨¡å¼ ä»£ç æ¼”ç¤º import java.util.concurrent.TimeUnit; import java.util.concurrent.locks.StampedLock; /** * @author Alfred.Ning * @since 2023å¹´07æœˆ24æ—¥ 10:14:00 */ public class StampedLockDemo { static int number = 20; static StampedLock stampedLock = new StampedLock(); public void write() { long stamp = stampedLock.writeLock(); System.out.println(Thread.currentThread().getName() + \" å†™çº¿ç¨‹å‡†å¤‡ä¿®æ”¹\"); try { number += 20; } catch (Exception e) { e.printStackTrace(); } finally { stampedLock.unlockWrite(stamp); } System.out.println(Thread.currentThread().getName() + \" å†™çº¿ç¨‹ä¿®æ”¹ç»“æŸ\"); } // æ‚²è§‚è¯» public void pessimisticRead() { long stamp = stampedLock.readLock(); System.out.println(Thread.currentThread().getName() + \" come in pessimistic lock, after 4 seconds\"); for (int i = 0; i \u003c 4; i++) { try { TimeUnit.SECONDS.sleep(1); System.out.println(Thread.currentThread().getName() + \" æ­£åœ¨è¯»å–ä¸­\"); } catch (InterruptedException e) { e.printStackTrace(); } } int result = number; try { System.out.println(Thread.currentThread().getName() + \" è·å–å˜é‡å€¼: \" + result); System.out.println(\"å†™çº¿ç¨‹æ²¡æœ‰ä¿®æ”¹å€¼ï¼Œå› ä¸º stampedLock.readLock()è¯»çš„æ—¶å€™ï¼Œä¸å¯ä»¥å†™ï¼Œè¯»å†™äº’æ–¥\"); } finally { stampedLock.unlockRead(stamp); } } // ä¹è§‚è¯» public void optimismRead() { long stamp = stampedLock.tryOptimisticRead(); // å…ˆè·å¾—ä¸€æ¬¡æ•°æ® int result = number; //é—´éš”4ç§’é’Ÿï¼Œæˆ‘ä»¬å¾ˆä¹è§‚çš„è®¤ä¸ºæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡numberå€¼ï¼Œå®é™…é åˆ¤æ–­ã€‚ System.out.println(\"4ç§’å‰stampedLock.validateå€¼(trueæ— ä¿®æ”¹ï¼Œfalseæœ‰ä¿®æ”¹)\" + \"\\t\" + stampedLock.validate(stamp)); for (int i = 0; i \u003c 4; i++) { try { TimeUnit.SECONDS.sleep(1); System.out.println( Thread.currentThread().getName() + \"\\t æ­£åœ¨è¯»å–ä¸­......\" + i + \"ç§’åstampedLock.validateå€¼(trueæ— ä¿®æ”¹ï¼Œfalseæœ‰ä¿®æ”¹)\" + \"\\t\" + stampedLock.validate(stamp)); } catch (InterruptedException e) { e.printStackTrace(); } } if (!stampedLock.validate(stamp)) { System.out.println(\"æœ‰äººåŠ¨è¿‡ï¼Œæœ‰å†™æ“ä½œ\"); // åˆ‡æ¢æ™®é€šè¯» stamp = stampedLock.readLock(); try { System.out.println(\"ä¹è§‚è¯»å‡çº§ä¸ºæ‚²è§‚è¯»\"); // é‡æ–°è·å–ç»“æœ result = number; System.out.println(\"é‡æ–°è¯»å–ä¹‹åç»“æœï¼š\" + result); } finally { stampedLock.unlockRead(stamp); } } System.out.println(Thread.currentThread().getName() + \" final value: \" + result); } public static void main(String[] args) { StampedLockDemo resource = new StampedLockDemo(); // æ‚²è§‚è¯» new Thread(resource::pessimisticRead, \"pessimisticRead\").start(); // ä¹è§‚è¯» new Thread(resource::optimismRead, \"pessimisticRead\").start(); try { TimeUnit.SECONDS.sleep(6); // æ¨¡æ‹Ÿä¸šåŠ¡æ²¡æœ‰ä¿®æ”¹ } catch (InterruptedException e) { e.printStackTrace(); } // ä¹è§‚è¯» new Thread(resource::optimismRead, \"pessimisticRead\").start(); try { TimeUnit.SECONDS.sleep(2); } catch (InterruptedException e) { e.printStackTrace(); } new Thread(resource::write, \"write Thread\").start(); } } ç¼ºç‚¹ StampedLock ä¸æ”¯æŒé‡å…¥ï¼Œæ²¡æœ‰Reå¼€å¤´ StampedLock çš„æ‚²è§‚è¯»é”å’Œå†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ï¼ˆConditionï¼‰ ä½¿ç”¨ StampedLockä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå³ä¸è¦è°ƒç”¨interrupt() æ–¹æ³• å¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é” readLockInterruptibly()å’Œå†™é”writeLockInterruptibly() ",
  "wordCount" : "1132",
  "inLanguage": "zh",
  "datePublished": "2023-07-22T20:31:52+08:00",
  "dateModified": "2023-07-24T10:43:42+08:00",
  "author":[{
    "@type": "Person",
    "name": "AlfredNing"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://AlfredNing.github.io/note/program/juc/07-aqs/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AlfredNing",
    "logo": {
      "@type": "ImageObject",
      "url": "https://AlfredNing.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://AlfredNing.github.io/" accesskey="h" title="AlfredNing (Alt + H)">AlfredNing</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://AlfredNing.github.io/note/" title="ğŸ““ç¬”è®°">
                    <span>ğŸ““ç¬”è®°</span>
                </a>
            </li>
            <li>
                <a href="https://AlfredNing.github.io/thinking/" title="ğŸ¤”é»‘æ´">
                    <span>ğŸ¤”é»‘æ´</span>
                </a>
            </li>
            <li>
                <a href="https://AlfredNing.github.io/search/" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://AlfredNing.github.io/tags/" title="ğŸ·ï¸æ ‡ç­¾">
                    <span>ğŸ·ï¸æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://AlfredNing.github.io/archives" title="ğŸ—„ï¸å½’æ¡£">
                    <span>ğŸ—„ï¸å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://AlfredNing.github.io/about" title="ğŸ¤™å…³äº">
                    <span>ğŸ¤™å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://AlfredNing.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://AlfredNing.github.io/note/">ç¬”è®°</a>&nbsp;Â»&nbsp;<a href="https://AlfredNing.github.io/note/program/">ç¼–ç¨‹</a>&nbsp;Â»&nbsp;<a href="https://AlfredNing.github.io/note/program/juc/">juc</a></div>
            <h1 class="post-title">
                07 AQS
            </h1>
            <div class="post-meta">åˆ›å»º:&amp;nbsp;&lt;span title=&#39;2023-07-22 20:31:52 &#43;0800 CST&#39;&gt;2023å¹´-07æœˆ-22æ—¥&lt;/span&gt;&amp;nbsp;|&amp;nbsp;æ›´æ–°:&amp;nbsp;2023å¹´-07æœˆ-24æ—¥&amp;nbsp;|&amp;nbsp;å­—æ•°:&amp;nbsp;1132å­—&amp;nbsp;|&amp;nbsp;æ—¶é•¿:&amp;nbsp;6åˆ†é’Ÿ&amp;nbsp;|&amp;nbsp;AlfredNing

                &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://AlfredNing.github.io/tags/juc/">Juc</a>
                </ul>

                
                
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89" aria-label="å®šä¹‰">å®šä¹‰</a></li>
                <li>
                    <a href="#%e4%bd%93%e7%b3%bb%e6%9e%b6%e6%9e%84" aria-label="ä½“ç³»æ¶æ„">ä½“ç³»æ¶æ„</a><ul>
                        
                <li>
                    <a href="#node%e5%86%85%e9%83%a8%e7%b1%bb" aria-label="Nodeå†…éƒ¨ç±»">Nodeå†…éƒ¨ç±»</a></li>
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e9%98%9f%e5%88%97%e5%9f%ba%e6%9c%ac%e7%bb%93%e6%9e%84" aria-label="åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„">åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„</a></li></ul>
                </li>
                <li>
                    <a href="#reentrantlock-%e5%ae%9e%e7%8e%b0" aria-label="ReentrantLock å®ç°">ReentrantLock å®ç°</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e9%94%81%e8%bf%87%e7%a8%8b" aria-label="åŠ é”è¿‡ç¨‹">åŠ é”è¿‡ç¨‹</a></li>
                <li>
                    <a href="#%e8%a7%a3%e9%94%81%e8%bf%87%e7%a8%8b" aria-label="è§£é”è¿‡ç¨‹">è§£é”è¿‡ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#reentrantlockreentrantreadwritelockstampedlock" aria-label="ReentrantLockã€ReentrantReadWriteLockã€StampedLock">ReentrantLockã€ReentrantReadWriteLockã€StampedLock</a><ul>
                        
                <li>
                    <a href="#%e9%94%81%e6%bc%94%e5%8f%98" aria-label="é”æ¼”å˜">é”æ¼”å˜</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e9%94%81" aria-label="è¯»å†™é”">è¯»å†™é”</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89-1" aria-label="å®šä¹‰">å®šä¹‰</a></li>
                <li>
                    <a href="#%e7%bc%ba%e7%82%b9" aria-label="ç¼ºç‚¹">ç¼ºç‚¹</a></li>
                <li>
                    <a href="#%e9%80%82%e7%94%a8%e6%9d%a1%e4%bb%b6" aria-label="é€‚ç”¨æ¡ä»¶">é€‚ç”¨æ¡ä»¶</a></li>
                <li>
                    <a href="#%e9%94%81%e9%99%8d%e7%ba%a7" aria-label="é”é™çº§">é”é™çº§</a><ul>
                        
                <li>
                    <a href="#%e9%94%81%e9%99%8d%e7%ba%a7%e4%bb%a3%e7%a0%81%e6%bc%94%e7%a4%ba" aria-label="é”é™çº§ä»£ç æ¼”ç¤º">é”é™çº§ä»£ç æ¼”ç¤º</a></li>
                <li>
                    <a href="#reentrantwritereadlock%e6%ba%90%e7%a0%81" aria-label="ReentrantWriteReadLockæºç ">ReentrantWriteReadLockæºç </a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%82%ae%e6%88%b3%e9%94%81stampedlock" aria-label="é‚®æˆ³é”StampedLock">é‚®æˆ³é”StampedLock</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89-2" aria-label="å®šä¹‰">å®šä¹‰</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e9%94%81%e7%9a%84%e9%97%ae%e9%a2%98---%e9%94%81%e9%a5%a5%e9%a5%bf" aria-label="è¯»å†™é”çš„é—®é¢˜ - é”é¥¥é¥¿">è¯»å†™é”çš„é—®é¢˜ - é”é¥¥é¥¿</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e5%86%b3%e9%94%81%e9%a5%a5%e9%a5%bf" aria-label="è§£å†³é”é¥¥é¥¿">è§£å†³é”é¥¥é¥¿</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%89%b9%e7%82%b9" aria-label="ç‰¹ç‚¹">ç‰¹ç‚¹</a></li>
                <li>
                    <a href="#%e8%ae%bf%e9%97%ae%e6%a8%a1%e5%bc%8f" aria-label="è®¿é—®æ¨¡å¼">è®¿é—®æ¨¡å¼</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e6%bc%94%e7%a4%ba" aria-label="ä»£ç æ¼”ç¤º">ä»£ç æ¼”ç¤º</a></li>
                <li>
                    <a href="#%e7%bc%ba%e7%82%b9-1" aria-label="ç¼ºç‚¹">ç¼ºç‚¹</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="å®šä¹‰">å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰">#</a></h1>
<p><code>AbstractQueuedSynchronizer</code>: æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨</p>
<p>æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªintç±»å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€</p>
<p>å’ŒAQSç›¸å…³çš„</p>
<ul>
<li>ReentrantLock</li>
<li>CountDownLatch</li>
<li>ReentrantReadWriteLock</li>
<li>Semaphore</li>
</ul>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/666D8FE9-4122-4AC6-939A-36936EBB4AD4.png" alt="img"  />
</p>
<p>é”: é¢å‘é”çš„ä½¿ç”¨è€…,å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚API</p>
<p>åŒæ­¥å™¨: é¢å‘é”çš„å®ç°è€…</p>
<p>æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§<strong>æ’é˜Ÿç­‰å€™æœºåˆ¶</strong>ã€‚æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»å€™å®¢åŒºæ’é˜Ÿç­‰å€™)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚</p>
<p>æ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ</p>
<p>å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯<strong>CLHé˜Ÿåˆ—</strong>çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹ï¼ˆ<strong>Node</strong>ï¼‰ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ•ˆæœã€‚</p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/AECDB8DC-56E9-4B0F-AF1F-13EBB0ACCBF6.png" alt="img"  />
</p>
<h1 id="ä½“ç³»æ¶æ„">ä½“ç³»æ¶æ„<a hidden class="anchor" aria-hidden="true" href="#ä½“ç³»æ¶æ„">#</a></h1>
<p><strong>AQS = intå˜é‡ + CLHé˜Ÿåˆ—</strong></p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/image-20230722210116941.png" alt="image-20230722210116941"  />
</p>
<h2 id="nodeå†…éƒ¨ç±»">Nodeå†…éƒ¨ç±»<a hidden class="anchor" aria-hidden="true" href="#nodeå†…éƒ¨ç±»">#</a></h2>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/image-20230722210213059.png" alt="image-20230722210213059"  />
</p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/BDD4A0F0-421D-48BD-ACED-B9E82FDC036E.png" alt="img"  />
</p>
<h2 id="åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„">åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#åŒæ­¥é˜Ÿåˆ—åŸºæœ¬ç»“æ„">#</a></h2>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/60EFECF5-4A36-4EC0-8905-B143A02D2A51.png" alt="img"  />
</p>
<p>CLHï¼šCraigã€Landin and Hagersten é˜Ÿåˆ—ï¼Œæ˜¯ä¸ªå•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰</p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/3DCA41FC-B03F-4F7D-A9D2-D9B502793931.png" alt="img"  />
</p>
<h1 id="reentrantlock-å®ç°">ReentrantLock å®ç°<a hidden class="anchor" aria-hidden="true" href="#reentrantlock-å®ç°">#</a></h1>
<p><code>ReentrantLock</code> åº•å±‚ä½¿ç”¨<code>Sync</code>å®ç°ï¼Œå¯¹åº”æœ‰éå…¬å¹³<code>NonfairSync</code> å’Œå…¬å¹³<code>FairSync</code> éƒ½æ˜¯ç»§æ‰¿<code>AbstractQueuedSynchronizer</code></p>
<p>å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„ <code>tryAcquire</code>()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­ <code>!hasQueuedPredecessors()</code></p>
<p>hasQueuedPredecessors() ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š</p>
<p>å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›</p>
<p>éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼‰</p>
<h2 id="åŠ é”è¿‡ç¨‹">åŠ é”è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åŠ é”è¿‡ç¨‹">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NonfairSync</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Sync</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">7316153563782823691L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Performs lock.  Try immediate barge, backing up to normal
</span></span></span><span class="line"><span class="cl"><span class="cm">         * acquire on failure.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetState</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w"> </span><span class="c1">// ç¬¬ä¸€ä¸ªçº¿ç¨‹æŠ¢å </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">acquire</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// åç»­çº¿ç¨‹æŠ¢å </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">acquire</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tryAcquire</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">acquireQueued</span><span class="p">(</span><span class="n">addWaiter</span><span class="p">(</span><span class="n">Node</span><span class="p">.</span><span class="na">EXCLUSIVE</span><span class="p">),</span><span class="w"> </span><span class="n">arg</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">selfInterrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//  1.tryAcquire è®¾ç½®  å°è¯•è·å–é”</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">nonfairTryAcquire</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">acquires</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetState</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">acquires</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">getExclusiveOwnerThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nextc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acquires</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// overflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">setState</span><span class="p">(</span><span class="n">nextc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">//  2.addWaiter è®¾ç½®   åˆ›å»ºnodeèŠ‚ç‚¹ è¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="nf">addWaiter</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">(),</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Try the fast path of enq; backup to full enq on failure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Node</span><span class="w"> </span><span class="n">pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pred</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetTail</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">pred</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">enq</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// åŒå‘é“¾è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè™šèŠ‚ç‚¹(ä¹Ÿå«å“¨å…µèŠ‚ç‚¹)ï¼Œå…¶å®å¹¶ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯å ä½ã€‚çœŸæ­£çš„ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„èŠ‚ç‚¹ï¼Œæ˜¯ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹çš„ã€‚        </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="nf">enq</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Must initialize ç¬¬ä¸€æ¬¡åˆå§‹åŒ– </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetHead</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">()))</span><span class="w"> </span><span class="c1">// å“¨å…µèŠ‚ç‚¹ å ä½</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">node</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetTail</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">t</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//  3.acquireQueued è®¾ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">acquireQueued</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">interrupted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// å‰é©±èŠ‚ç‚¹-å“¨å…µèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">predecessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tryAcquire</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">setHead</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">p</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// help GC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">interrupted</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">parkAndCheckInterrupt</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">interrupted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å¼‚å¸¸æµç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cancelAcquire</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">shouldParkAfterFailedAcquire</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">pred</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred</span><span class="p">.</span><span class="na">waitStatus</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ws</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="na">SIGNAL</span><span class="p">)</span><span class="w"> </span><span class="c1">// ç¬¬äºŒæ¬¡è¿›å…¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * This node has already set status asking a release
</span></span></span><span class="line"><span class="cl"><span class="cm">             * to signal it, so it can safely park.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ws</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Predecessor was cancelled. Skip over predecessors and
</span></span></span><span class="line"><span class="cl"><span class="cm">             * indicate retry.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">node</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="na">waitStatus</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pred</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * waitStatus must be 0 or PROPAGATE.  Indicate that we
</span></span></span><span class="line"><span class="cl"><span class="cm">             * need a signal, but don&#39;t park yet.  Caller will need to
</span></span></span><span class="line"><span class="cl"><span class="cm">             * retry to make sure it cannot acquire before parking.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// ç¬¬ä¸€æ¬¡ ä¿®æ”¹å“¨å…µèŠ‚ç‚¹waitStatus = -1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">compareAndSetWaitStatus</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="w"> </span><span class="n">ws</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="na">SIGNAL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">// æŒ‚èµ·æŠ¢å çº¿ç¨‹       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">parkAndCheckInterrupt</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LockSupport</span><span class="p">.</span><span class="na">park</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"> </span><span class="c1">// çº¿ç¨‹ç»™æŒ‚èµ·</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">interrupted</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">        
</span></span></span></code></pre></div><h2 id="è§£é”è¿‡ç¨‹">è§£é”è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è§£é”è¿‡ç¨‹">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sync</span><span class="p">.</span><span class="na">release</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">release</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tryRelease</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="na">waitStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">unparkSuccessor</span><span class="p">(</span><span class="n">h</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">tryRelease</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">releases</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getState</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">releases</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">getExclusiveOwnerThread</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalMonitorStateException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">setState</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">free</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="reentrantlockreentrantreadwritelockstampedlock">ReentrantLockã€ReentrantReadWriteLockã€StampedLock<a hidden class="anchor" aria-hidden="true" href="#reentrantlockreentrantreadwritelockstampedlock">#</a></h1>
<h2 id="é”æ¼”å˜">é”æ¼”å˜<a hidden class="anchor" aria-hidden="true" href="#é”æ¼”å˜">#</a></h2>
<blockquote>
<p>æ— é” -&gt;  ç‹¬å é” -&gt; è¯»å†™é” -&gt; é‚®æˆ³(ç¥¨æ®)é”</p>
</blockquote>
<p>æ— é”ï¼š å¤šçº¿ç¨‹ç«äº‰ï¼Œæ•°æ®æ— åº</p>
<p>ç‹¬å é”ï¼šè¯»å†™æ“ä½œå…¨éƒ¨äº’æ–¥ï¼Œæ•ˆç‡ä½</p>
<p>è¯»å†™é”ï¼šè¯»å†™äº’æ–¥ï¼Œè¯»è¯»å…±äº«</p>
<h2 id="è¯»å†™é”">è¯»å†™é”<a hidden class="anchor" aria-hidden="true" href="#è¯»å†™é”">#</a></h2>
<p><code>ReentrantReadWriteLock</code></p>
<h3 id="å®šä¹‰-1">å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰-1">#</a></h3>
<p>ä¸€ä¸ªèµ„æºèƒ½è¢«å¤šä¸ª<strong>è¯»çº¿ç¨‹</strong>è®¿é—®ï¼Œæˆ–è€…è¢«ä¸€ä¸ª<strong>å†™çº¿ç¨‹</strong>è®¿é—®ã€‚ä½†æ˜¯ä¸èƒ½åŒæ—¶å­˜åœ¨è¯»å†™çº¿ç¨‹ã€‚</p>
<h3 id="ç¼ºç‚¹">ç¼ºç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç¼ºç‚¹">#</a></h3>
<p>è¯»å†™é”ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„è¯»å†™åˆ†ç¦»ï¼Œå®ƒåªå…è®¸è¯»è¯»å…±å­˜ï¼Œè€Œè¯»å†™å’Œå†™å†™ä¾ç„¶æ˜¯äº’æ–¥çš„ï¼Œå¤§å¤šå®é™…åœºæ™¯æ˜¯â€œ<strong>è¯»/è¯»â€çº¿ç¨‹é—´å¹¶ä¸å­˜åœ¨äº’æ–¥å…³ç³»ï¼Œåªæœ‰&quot;è¯»/å†™&quot;çº¿ç¨‹æˆ–&quot;å†™/å†™&quot;çº¿ç¨‹é—´çš„æ“ä½œéœ€è¦äº’æ–¥çš„ã€‚å› æ­¤å¼•å…¥ReentrantReadWriteLockã€‚</strong></p>
<ol>
<li>é”é¥¥é¥¿é—®é¢˜ï¼šå†™çº¿ç¨‹è·å–ä¸åˆ°é”</li>
<li>è¯»çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾ï¼Œå†™çº¿ç¨‹ä¸å¯ä»¥è·å–åˆ°é”ï¼Œå¿…é¡»è¯»å®Œåï¼Œæ‰èƒ½æœ‰æœºä¼šå†™</li>
</ol>
<h3 id="é€‚ç”¨æ¡ä»¶">é€‚ç”¨æ¡ä»¶<a hidden class="anchor" aria-hidden="true" href="#é€‚ç”¨æ¡ä»¶">#</a></h3>
<p><strong>åªæœ‰åœ¨è¯»å¤šå†™å°‘æƒ…å¢ƒä¹‹ä¸‹ï¼Œè¯»å†™é”æ‰å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ä½“ç°ã€‚</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.Lock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author Alfred.Ning
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @since 2023å¹´07æœˆ24æ—¥ 08:35:00
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReentrantReadWriteLockDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Resource</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Resource</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">finalI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">resource</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">finalI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">finalI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">finalI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">resource</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">finalI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Lock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ReentrantReadWriteLock</span><span class="w"> </span><span class="n">rwLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantReadWriteLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    lock.lock();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ­£åœ¨å†™å…¥&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MICROSECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">400</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; å†™å…¥å®Œæˆ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//      lock.unlock();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    lock.lock();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ­£åœ¨è¯»å–&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ­£åœ¨è¯»å–å®Œæˆï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//      lock.unlock();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">().</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="é”é™çº§">é”é™çº§<a hidden class="anchor" aria-hidden="true" href="#é”é™çº§">#</a></h3>
<p><strong>é”çš„ä¸¥è‹›ç¨‹åº¦å˜å¼ºå«åšå‡çº§ï¼Œåä¹‹å«åšé™çº§</strong></p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/71CE3B64-7971-41F9-B64C-0C1EAD5AB203.png" alt="img"  />
</p>
<p><strong>å°†å†™å…¥é”é™çº§ä¸ºè¯»é”</strong>ï¼Œä¸ºäº†å½“å‰çº¿ç¨‹æ„ŸçŸ¥åˆ°æ•°æ®å˜åŒ–ï¼Œç›®çš„æ˜¯<strong>ä¿è¯æ•°æ®å¯è§æ€§</strong>ï¼Œå†™åç«‹å³è¯»ã€‚</p>
<p>**æ‚²è§‚é”ï¼š**å†™é”å¿…é¡»åœ¨æ‰€æœ‰è¯»é”å®Œæˆä¹‹åè¿›è¡Œæ“ä½œ</p>
<p><strong>çº¿ç¨‹è·å–è¯»é”æ˜¯ä¸èƒ½ç›´æ¥å‡çº§ä¸ºå†™å…¥é”çš„ã€‚</strong></p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/B4C3735A-71BD-4B2D-8381-E8AF8C46CA34.png" alt="img"  />
</p>
<p>åœ¨ReentrantReadWriteLockä¸­ï¼Œå½“è¯»é”è¢«ä½¿ç”¨æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å°è¯•è·å–å†™é”ï¼Œè¯¥å†™çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚æ‰€ä»¥ï¼Œéœ€è¦é‡Šæ”¾æ‰€æœ‰è¯»é”ï¼Œæ‰å¯è·å–å†™é”ã€‚</p>
<p>å³ReadWriteLockè¯»çš„è¿‡ç¨‹ä¸­ä¸å…è®¸å†™ï¼Œåªæœ‰ç­‰å¾…çº¿ç¨‹éƒ½é‡Šæ”¾äº†è¯»é”ï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½è·å–å†™é”ï¼Œä¹Ÿå°±æ˜¯å†™å…¥å¿…é¡»ç­‰å¾…ã€‚</p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/EE2B6855-0906-4E18-B229-252D735B4704.png" alt="img"  />
</p>
<p>å½“å‰çº¿ç¨‹å¯ä»¥è·å–åˆ°å†™é”åˆè·å–åˆ°è¯»é”ï¼Œä½†æ˜¯è·å–åˆ°äº†è¯»é”ä¸èƒ½ç»§ç»­è·å–å†™é”ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºè¯»å†™é”è¦ä¿æŒå†™æ“ä½œçš„å¯è§æ€§ã€‚å› ä¸ºï¼Œå¦‚æœå…è®¸è¯»é”åœ¨è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚</p>
<h4 id="é”é™çº§ä»£ç æ¼”ç¤º">é”é™çº§ä»£ç æ¼”ç¤º<a hidden class="anchor" aria-hidden="true" href="#é”é™çº§ä»£ç æ¼”ç¤º">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author Alfred.Ning
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @since 2023å¹´07æœˆ24æ—¥ 09:45:00
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LockDownGradingDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ReentrantReadWriteLock</span><span class="w"> </span><span class="n">rwLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantReadWriteLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ReadLock</span><span class="w"> </span><span class="n">readLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rwLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">WriteLock</span><span class="w"> </span><span class="n">writeLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rwLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨å†™&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">readLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨è¯»&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">readLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨å†™&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">readLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨è¯»&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    readLock.unlock();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ­£åœ¨å†™1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="reentrantwritereadlockæºç ">ReentrantWriteReadLockæºç <a hidden class="anchor" aria-hidden="true" href="#reentrantwritereadlockæºç ">#</a></h4>
<p><strong>ç¼“å­˜è®¾è®¡ï¼Œç¼“å­˜ä¸€è‡´æ€§</strong></p>
<p><img loading="lazy" src="https://nq-bucket.oss-cn-shanghai.aliyuncs.com/note_img/image-20230724095256121.png" alt="image-20230724095256121"  />
</p>
<ol>
<li>å£°æ˜äº†ä¸€ä¸ªvolatileç±»å‹çš„cacheValidå˜é‡ï¼Œä¿è¯å…¶å¯è§æ€§ã€‚</li>
<li>é¦–å…ˆè·å–è¯»é”ï¼Œå¦‚æœcacheä¸å¯ç”¨ï¼Œåˆ™é‡Šæ”¾è¯»é”ï¼Œè·å–å†™é”ï¼Œåœ¨æ›´æ”¹æ•°æ®ä¹‹å‰ï¼Œå†æ£€æŸ¥ä¸€æ¬¡cacheValidçš„å€¼ï¼Œç„¶åä¿®æ”¹æ•°æ®ï¼Œå°†cacheValidç½®ä¸ºtrueï¼Œç„¶ååœ¨é‡Šæ”¾å†™é”å‰è·å–è¯»é”ï¼›æ­¤æ—¶ï¼Œcacheä¸­æ•°æ®å¯ç”¨ï¼Œå¤„ç†cacheä¸­æ•°æ®ï¼Œæœ€åé‡Šæ”¾è¯»é”ã€‚<strong>è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„é”é™çº§çš„è¿‡ç¨‹ï¼Œç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§ã€‚</strong></li>
</ol>
<p>å¦‚æœè¿èƒŒé”é™çº§çš„æ­¥éª¤:</p>
<ul>
<li>å¦‚æœå½“å‰çš„çº¿ç¨‹Cåœ¨ä¿®æ”¹å®Œcacheä¸­çš„æ•°æ®åï¼Œæ²¡æœ‰è·å–è¯»é”è€Œæ˜¯ç›´æ¥é‡Šæ”¾äº†å†™é”ï¼Œé‚£ä¹ˆå‡è®¾æ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹Dè·å–äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆCçº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œåˆ™æ•°æ®å‡ºç°é”™è¯¯ã€‚</li>
</ul>
<p>å¦‚æœéµå¾ªé”é™çº§çš„æ­¥éª¤</p>
<ul>
<li>çº¿ç¨‹Cåœ¨é‡Šæ”¾å†™é”ä¹‹å‰è·å–è¯»é”ï¼Œé‚£ä¹ˆçº¿ç¨‹Dåœ¨è·å–å†™é”æ—¶å°†è¢«é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹Cå®Œæˆæ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œé‡Šæ”¾è¯»é”ã€‚è¿™æ ·å¯ä»¥ä¿è¯è¿”å›çš„æ•°æ®æ˜¯è¿™æ¬¡æ›´æ–°çš„æ•°æ®ï¼Œè¯¥æœºåˆ¶æ˜¯ä¸“é—¨ä¸ºäº†ç¼“å­˜è®¾è®¡çš„ã€‚</li>
</ul>
<h1 id="é‚®æˆ³é”stampedlock">é‚®æˆ³é”StampedLock<a hidden class="anchor" aria-hidden="true" href="#é‚®æˆ³é”stampedlock">#</a></h1>
<h2 id="å®šä¹‰-2">å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰-2">#</a></h2>
<p><em>ä¹Ÿå«ç¥¨æ®é”</em></p>
<p><code>StampedLock</code>æ˜¯JDK1.8ä¸­æ–°å¢çš„ä¸€ä¸ªè¯»å†™é”ï¼Œä¹Ÿæ˜¯å¯¹JDK1.5ä¸­çš„è¯»å†™é”ReentrantReadWriteLockçš„ä¼˜åŒ–ã€‚</p>
<p><code>ReentrantReadWriteLock</code>æ•ˆç‡é«˜çš„åŸå› åœ¨äºå®ƒçš„å¹¶å‘è¯»ï¼Œ<code>StampedLock</code> ä»£è¡¨äº†é”çš„çŠ¶æ€ã€‚å½“stampè¿”å›é›¶æ—¶ï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”å¤±è´¥ã€‚å¹¶ä¸”ï¼Œå½“é‡Šæ”¾é”æˆ–è€…è½¬æ¢é”çš„æ—¶å€™ï¼Œéƒ½è¦ä¼ å…¥æœ€åˆè·å–çš„stampå€¼ã€‚</p>
<h2 id="è¯»å†™é”çš„é—®é¢˜---é”é¥¥é¥¿">è¯»å†™é”çš„é—®é¢˜ - é”é¥¥é¥¿<a hidden class="anchor" aria-hidden="true" href="#è¯»å†™é”çš„é—®é¢˜---é”é¥¥é¥¿">#</a></h2>
<p><code>ReentrantReadWriteLock</code>å®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œä½†æ˜¯ä¸€æ—¦è¯»æ“ä½œæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæƒ³è¦è·å–å†™é”å°±å˜å¾—æ¯”è¾ƒå›°éš¾äº†ï¼Œå‡å¦‚å½“å‰1000ä¸ªçº¿ç¨‹ï¼Œ999ä¸ªè¯»ï¼Œ1ä¸ªå†™ï¼Œæœ‰å¯èƒ½999ä¸ªè¯»å–çº¿ç¨‹é•¿æ—¶é—´æŠ¢åˆ°äº†é”ï¼Œé‚£1ä¸ªå†™çº¿ç¨‹å°±æ‚²å‰§äº† å› ä¸ºå½“å‰æœ‰å¯èƒ½ä¼šä¸€ç›´å­˜åœ¨è¯»é”ï¼Œè€Œæ— æ³•è·å¾—å†™é”ï¼Œæ ¹æœ¬æ²¡æœºä¼šå†™</p>
<h3 id="è§£å†³é”é¥¥é¥¿">è§£å†³é”é¥¥é¥¿<a hidden class="anchor" aria-hidden="true" href="#è§£å†³é”é¥¥é¥¿">#</a></h3>
<p>ä½¿ç”¨â€œå…¬å¹³â€ç­–ç•¥å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œ ä½†æ˜¯ç‰ºç‰²äº†ç³»ç»Ÿçš„ååé‡</p>
<h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç‰¹ç‚¹">#</a></h2>
<ul>
<li>æ‰€æœ‰è·å–é”çš„æ–¹æ³•ï¼Œéƒ½è¿”å›ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼ŒStampä¸ºé›¶è¡¨ç¤ºè·å–å¤±è´¥ï¼Œå…¶ä½™éƒ½è¡¨ç¤ºæˆåŠŸï¼›</li>
<li>æ‰€æœ‰é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œéƒ½éœ€è¦ä¸€ä¸ªé‚®æˆ³ï¼ˆStampï¼‰ï¼Œè¿™ä¸ªStampå¿…é¡»æ˜¯å’ŒæˆåŠŸè·å–é”æ—¶å¾—åˆ°çš„Stampä¸€è‡´ï¼›</li>
<li>StampedLockæ˜¯ä¸å¯é‡å…¥çš„ï¼Œå±é™©(å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†å†™é”ï¼Œå†å»è·å–å†™é”çš„è¯å°±ä¼šé€ æˆæ­»é”)</li>
</ul>
<h2 id="è®¿é—®æ¨¡å¼">è®¿é—®æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#è®¿é—®æ¨¡å¼">#</a></h2>
<ol>
<li>Readingï¼ˆè¯»æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„è¯»é”ç±»ä¼¼</li>
<li>Writingï¼ˆå†™æ¨¡å¼ï¼‰ï¼šåŠŸèƒ½å’ŒReentrantReadWriteLockçš„å†™é”ç±»ä¼¼</li>
<li>Optimistic readingï¼ˆä¹è§‚è¯»æ¨¡å¼ï¼‰ï¼šæ— é”æœºåˆ¶ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„ä¹è§‚é”ï¼Œ<strong>æ”¯æŒè¯»å†™å¹¶å‘ï¼Œå¾ˆä¹è§‚è®¤ä¸ºè¯»å–æ—¶æ²¡äººä¿®æ”¹ï¼Œå‡å¦‚è¢«ä¿®æ”¹å†å®ç°å‡çº§ä¸ºæ‚²è§‚è¯»æ¨¡å¼</strong></li>
</ol>
<h2 id="ä»£ç æ¼”ç¤º">ä»£ç æ¼”ç¤º<a hidden class="anchor" aria-hidden="true" href="#ä»£ç æ¼”ç¤º">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.locks.StampedLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author Alfred.Ning
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @since 2023å¹´07æœˆ24æ—¥ 10:14:00
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StampedLockDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="n">StampedLock</span><span class="w"> </span><span class="n">stampedLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StampedLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; å†™çº¿ç¨‹å‡†å¤‡ä¿®æ”¹&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">unlockWrite</span><span class="p">(</span><span class="n">stamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; å†™çº¿ç¨‹ä¿®æ”¹ç»“æŸ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// æ‚²è§‚è¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pessimisticRead</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; come in pessimistic lock, after 4 seconds&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ­£åœ¨è¯»å–ä¸­&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; è·å–å˜é‡å€¼: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;å†™çº¿ç¨‹æ²¡æœ‰ä¿®æ”¹å€¼ï¼Œå› ä¸º stampedLock.readLock()è¯»çš„æ—¶å€™ï¼Œä¸å¯ä»¥å†™ï¼Œè¯»å†™äº’æ–¥&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">unlockRead</span><span class="p">(</span><span class="n">stamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ä¹è§‚è¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">optimismRead</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">tryOptimisticRead</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å…ˆè·å¾—ä¸€æ¬¡æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//é—´éš”4ç§’é’Ÿï¼Œæˆ‘ä»¬å¾ˆä¹è§‚çš„è®¤ä¸ºæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡numberå€¼ï¼Œå®é™…é åˆ¤æ–­ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;4ç§’å‰stampedLock.validateå€¼(trueæ— ä¿®æ”¹ï¼Œfalseæœ‰ä¿®æ”¹)&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\t&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">stamp</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\t æ­£åœ¨è¯»å–ä¸­......&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;ç§’åstampedLock.validateå€¼(trueæ— ä¿®æ”¹ï¼Œfalseæœ‰ä¿®æ”¹)&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;\t&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">stamp</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stampedLock</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">stamp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æœ‰äººåŠ¨è¿‡ï¼Œæœ‰å†™æ“ä½œ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// åˆ‡æ¢æ™®é€šè¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">readLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ä¹è§‚è¯»å‡çº§ä¸ºæ‚²è§‚è¯»&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// é‡æ–°è·å–ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é‡æ–°è¯»å–ä¹‹åç»“æœï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">stampedLock</span><span class="p">.</span><span class="na">unlockRead</span><span class="p">(</span><span class="n">stamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; final value: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StampedLockDemo</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StampedLockDemo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    æ‚²è§‚è¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">resource</span><span class="p">::</span><span class="n">pessimisticRead</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;pessimisticRead&#34;</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    ä¹è§‚è¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">resource</span><span class="p">::</span><span class="n">optimismRead</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;pessimisticRead&#34;</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">6</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ¨¡æ‹Ÿä¸šåŠ¡æ²¡æœ‰ä¿®æ”¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ä¹è§‚è¯»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">resource</span><span class="p">::</span><span class="n">optimismRead</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;pessimisticRead&#34;</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">resource</span><span class="p">::</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;write Thread&#34;</span><span class="p">).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="ç¼ºç‚¹-1">ç¼ºç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç¼ºç‚¹-1">#</a></h2>
<ul>
<li>StampedLock ä¸æ”¯æŒé‡å…¥ï¼Œæ²¡æœ‰Reå¼€å¤´</li>
<li>StampedLock çš„æ‚²è§‚è¯»é”å’Œå†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ï¼ˆConditionï¼‰</li>
<li>ä½¿ç”¨ StampedLockä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå³ä¸è¦è°ƒç”¨interrupt() æ–¹æ³•
å¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é” <code>readLockInterruptibly</code>()å’Œå†™é”<code>writeLockInterruptibly</code>()</li>
</ul>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://AlfredNing.github.io/note/program/spring/%E4%B8%8E%E6%BA%90%E7%A0%81%E5%B9%B2%E6%88%98-spring-01/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Springæºç 01</span>
  </a>
  <a class="next" href="https://AlfredNing.github.io/note/program/juc/06-synchronized%E4%B8%8E%E9%94%81%E5%8D%87%E7%BA%A7/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>06 Synchronizedä¸é”å‡çº§</span>
  </a>
</nav>

        </footer>
    </div><div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment">
    </div>
    <script src="https://utteranc.es/client.js"
        repo="AlfredNing/AlfredNing.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>
</article>
</main>

<footer class="footer">
    <span>&copy; 2024 <a href="https://AlfredNing.github.io/">AlfredNing</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script></body>

</html>
